<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent RPG Economy - Character Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00ffff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ffff;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #00ffff; }
            to { text-shadow: 0 0 20px #00ffff, 0 0 30px #00ffff; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .character-card {
            background: rgba(0, 50, 100, 0.3);
            border: 2px solid #0080ff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 128, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 128, 255, 0.4);
            border-color: #00ffff;
        }
        
        .character-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #0080ff;
        }
        
        .character-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #00ff88;
        }
        
        .character-level {
            background: linear-gradient(45deg, #ff6b00, #ff8800);
            color: #000;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 128, 255, 0.2);
        }
        
        .stat-label {
            color: #88ccff;
            font-weight: bold;
        }
        
        .stat-value {
            color: #ffffff;
            font-family: monospace;
        }
        
        .stat-bar {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
            border: 1px solid #0080ff;
        }
        
        .stat-fill {
            height: 100%;
            transition: width 1s ease;
            border-radius: 3px;
        }
        
        .health-bar { background: linear-gradient(90deg, #ff4444, #ff8888); }
        .mana-bar { background: linear-gradient(90deg, #4444ff, #8888ff); }
        .xp-bar { background: linear-gradient(90deg, #44ff44, #88ff88); }
        .compute-bar { background: linear-gradient(90deg, #ffaa00, #ffcc44); }
        
        .activity-log {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #0080ff;
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .activity-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(0, 128, 255, 0.1);
            font-size: 0.9em;
        }
        
        .activity-time {
            color: #888;
            font-size: 0.8em;
        }
        
        .activity-action {
            color: #00ff88;
        }
        
        .activity-result {
            color: #ffff00;
        }
        
        .legendary {
            animation: legendary-pulse 2s infinite;
            border-color: #ff00ff !important;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.5) !important;
        }
        
        @keyframes legendary-pulse {
            0% { box-shadow: 0 0 30px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 50px rgba(255, 0, 255, 0.8); }
            100% { box-shadow: 0 0 30px rgba(255, 0, 255, 0.5); }
        }
        
        .rare {
            border-color: #ff8800 !important;
            box-shadow: 0 0 20px rgba(255, 136, 0, 0.4) !important;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #00ffff;
        }
        
        .control-button {
            background: linear-gradient(45deg, #0080ff, #00ffff);
            color: #000;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .control-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }
        
        .economy-overview {
            background: rgba(0, 50, 0, 0.3);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            grid-column: 1 / -1;
        }
        
        .economy-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .economy-stat {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .economy-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #00ff88;
            display: block;
        }
        
        .economy-label {
            font-size: 0.9em;
            color: #88ccff;
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #00ffff;
        }
        
        .spinner {
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-top: 3px solid #00ffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .zone-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .zone-safe { background: rgba(0, 255, 0, 0.8) !important; }
        .zone-danger { background: rgba(255, 165, 0, 0.8) !important; }
        .zone-demon { background: rgba(138, 43, 226, 0.8) !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ AI AGENT RPG ECONOMY</h1>
        <p>Real-time character progression & combat analytics</p>
        <div id="serverStatus" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
            <span id="connectionStatus">üî¥ Connecting to game servers...</span>
        </div>
    </div>

    <div id="economyOverview" class="economy-overview">
        <h2>üåç Global Economy Status</h2>
        <div class="economy-stats">
            <div class="economy-stat">
                <span class="economy-value" id="totalAgents">-</span>
                <div class="economy-label">Active Agents</div>
            </div>
            <div class="economy-stat">
                <span class="economy-value" id="totalCompute">-</span>
                <div class="economy-label">Total Compute Used</div>
            </div>
            <div class="economy-stat">
                <span class="economy-value" id="totalTrades">-</span>
                <div class="economy-label">Trades Today</div>
            </div>
            <div class="economy-stat">
                <span class="economy-value" id="avgBalance">-</span>
                <div class="economy-label">Average Balance</div>
            </div>
            <div class="economy-stat">
                <span class="economy-value" id="activeBattles">-</span>
                <div class="economy-label">Active Battles</div>
            </div>
            <div class="economy-stat">
                <span class="economy-value" id="legendaryDrops">-</span>
                <div class="economy-label">Legendary Drops</div>
            </div>
        </div>
    </div>

    <div id="agentsGrid" class="stats-grid">
        <div class="loading">
            <div class="spinner"></div>
            Loading agent data from unified schema...
        </div>
    </div>

    <div class="controls">
        <button class="control-button" onclick="refreshData()">üîÑ Refresh</button>
        <button class="control-button" onclick="toggleAutoRefresh()">‚è±Ô∏è Auto</button>
        <button class="control-button" onclick="showCombatLog()">‚öîÔ∏è Combat</button>
        <button class="control-button" onclick="showEconomy()">üí∞ Economy</button>
        <button class="control-button" onclick="showZoneMap()">üó∫Ô∏è Zones</button>
    </div>

    <script>
        let autoRefresh = false;
        let refreshInterval = null;
        let websocket = null;
        
        // Connect to real-time updates
        function connectWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:8081');
                
                websocket.onopen = function() {
                    document.getElementById('connectionStatus').innerHTML = 'üü¢ Connected to game servers';
                    console.log('Connected to game server WebSocket');
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleRealtimeUpdate(data);
                };
                
                websocket.onclose = function() {
                    document.getElementById('connectionStatus').innerHTML = 'üü° Reconnecting...';
                    setTimeout(connectWebSocket, 3000);
                };
                
                websocket.onerror = function(error) {
                    document.getElementById('connectionStatus').innerHTML = 'üî¥ Connection error';
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                console.log('WebSocket not available, using polling mode');
                document.getElementById('connectionStatus').innerHTML = 'üü° Polling mode';
            }
        }
        
        // Handle real-time updates
        function handleRealtimeUpdate(data) {
            console.log('Real-time update:', data);
            
            if (data.type === 'agent_update') {
                updateAgentCard(data.agent);
            } else if (data.type === 'combat_result') {
                showCombatAlert(data);
            } else if (data.type === 'legendary_drop') {
                showLegendaryAlert(data);
            }
        }
        
        // Load agent data from the existing unified schema
        async function loadAgentData() {
            try {
                // Try multiple endpoints since we have various systems running
                const endpoints = [
                    'http://localhost:3334/api/agents',
                    'http://localhost:8080/api/agents', 
                    'http://localhost:3000/api/agents'
                ];
                
                for (let endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint);
                        if (response.ok) {
                            return await response.json();
                        }
                    } catch (e) {
                        console.log(`Endpoint ${endpoint} not available`);
                    }
                }
                
                // Fallback to mock data based on the schema we saw
                return generateMockAgentData();
                
            } catch (error) {
                console.error('Error loading agent data:', error);
                return generateMockAgentData();
            }
        }
        
        // Generate mock data based on the actual schema structure
        function generateMockAgentData() {
            const agentTypes = ['Combat', 'Economic', 'Exploration', 'Support', 'Stealth'];
            const specialties = ['Code Generation', 'Data Analysis', 'Task Orchestration', 'Resource Trading', 'Pattern Recognition'];
            const statuses = ['active', 'idle', 'combat', 'trading', 'leveling'];
            
            return {
                agents: Array.from({length: 8}, (_, i) => ({
                    id: i + 1,
                    name: `Agent_${String(i + 1).padStart(3, '0')}`,
                    type: agentTypes[i % agentTypes.length],
                    specialty: specialties[i % specialties.length],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    balance: Math.random() * 1000 + 100,
                    total_trades: Math.floor(Math.random() * 50) + 5,
                    total_compute_used: Math.random() * 10000 + 1000,
                    level: Math.floor(Math.random() * 20) + 1,
                    health: Math.random() * 100,
                    mana: Math.random() * 100,
                    xp: Math.random() * 1000,
                    zone: ['Safe Zone', 'Combat Zone', 'Economic Hub', 'Demon Layer'][Math.floor(Math.random() * 4)],
                    last_action: new Date(Date.now() - Math.random() * 3600000).toISOString(),
                    recent_activity: generateRecentActivity()
                })),
                economy: {
                    total_agents: 8,
                    total_compute: 45678.9,
                    total_trades: 234,
                    avg_balance: 567.8,
                    active_battles: 3,
                    legendary_drops: 12
                }
            };
        }
        
        function generateRecentActivity() {
            const actions = [
                'Completed API call to OpenAI',
                'Traded 50 compute units',
                'Gained 25 XP from task completion',
                'Entered combat with error handler',
                'Found rare optimization pattern',
                'Leveled up specialization',
                'Joined agent party for raid',
                'Defeated timeout exception'
            ];
            
            return Array.from({length: 5}, () => ({
                time: new Date(Date.now() - Math.random() * 3600000).toLocaleTimeString(),
                action: actions[Math.floor(Math.random() * actions.length)],
                result: Math.random() > 0.7 ? 'LEGENDARY' : Math.random() > 0.4 ? 'RARE' : 'SUCCESS'
            }));
        }
        
        // Render agent cards
        function renderAgents(data) {
            const grid = document.getElementById('agentsGrid');
            
            // Update economy overview
            const economy = data.economy;
            document.getElementById('totalAgents').textContent = economy.total_agents;
            document.getElementById('totalCompute').textContent = economy.total_compute.toFixed(1);
            document.getElementById('totalTrades').textContent = economy.total_trades;
            document.getElementById('avgBalance').textContent = '$' + economy.avg_balance.toFixed(2);
            document.getElementById('activeBattles').textContent = economy.active_battles;
            document.getElementById('legendaryDrops').textContent = economy.legendary_drops;
            
            // Render agent cards
            grid.innerHTML = data.agents.map(agent => `
                <div class="character-card ${agent.status === 'legendary_battle' ? 'legendary' : agent.level > 15 ? 'rare' : ''}" 
                     id="agent-${agent.id}">
                    <div class="zone-indicator zone-${getZoneClass(agent.zone)}">${agent.zone}</div>
                    
                    <div class="character-header">
                        <div class="character-name">
                            ${agent.name}
                            <div style="font-size: 0.7em; color: #88ccff;">${agent.specialty}</div>
                        </div>
                        <div class="character-level">LVL ${agent.level}</div>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-label">üí∞ Balance:</span>
                        <span class="stat-value">$${agent.balance.toFixed(2)}</span>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-label">‚ö° Compute Used:</span>
                        <span class="stat-value">${agent.total_compute_used.toFixed(1)}</span>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-label">üìà Trades:</span>
                        <span class="stat-value">${agent.total_trades}</span>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-label">‚ù§Ô∏è Health:</span>
                        <span class="stat-value">${agent.health.toFixed(0)}%</span>
                        <div class="stat-bar">
                            <div class="stat-fill health-bar" style="width: ${agent.health}%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-label">üîÆ Compute Pool:</span>
                        <span class="stat-value">${agent.mana.toFixed(0)}%</span>
                        <div class="stat-bar">
                            <div class="stat-fill mana-bar" style="width: ${agent.mana}%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-label">‚≠ê Experience:</span>
                        <span class="stat-value">${agent.xp.toFixed(0)} XP</span>
                        <div class="stat-bar">
                            <div class="stat-fill xp-bar" style="width: ${(agent.xp % 100)}%"></div>
                        </div>
                    </div>
                    
                    <div class="activity-log">
                        <strong>üìú Recent Activity:</strong>
                        ${agent.recent_activity.map(activity => `
                            <div class="activity-item">
                                <span class="activity-time">[${activity.time}]</span>
                                <span class="activity-action">${activity.action}</span>
                                <span class="activity-result ${activity.result.toLowerCase()}">${activity.result}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function getZoneClass(zone) {
            if (zone.includes('Safe')) return 'safe';
            if (zone.includes('Combat')) return 'danger';  
            if (zone.includes('Demon')) return 'demon';
            return 'safe';
        }
        
        function updateAgentCard(agentData) {
            const card = document.getElementById(`agent-${agentData.id}`);
            if (card) {
                // Update specific stats without full re-render
                console.log('Updating agent card:', agentData.id);
            }
        }
        
        function showCombatAlert(data) {
            // Flash effect for combat
            const card = document.getElementById(`agent-${data.agentId}`);
            if (card) {
                card.style.animation = 'none';
                setTimeout(() => {
                    card.style.animation = 'legendary-pulse 1s ease-in-out 3';
                }, 10);
            }
        }
        
        function showLegendaryAlert(data) {
            // Create floating legendary drop alert
            const alert = document.createElement('div');
            alert.innerHTML = `üåü LEGENDARY DROP! Agent ${data.agentId} found ${data.item}!`;
            alert.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #ff00ff, #ffff00);
                color: #000;
                padding: 20px;
                border-radius: 10px;
                font-size: 1.2em;
                font-weight: bold;
                z-index: 9999;
                animation: legendary-pulse 3s ease-in-out;
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
        
        // Control functions
        async function refreshData() {
            document.getElementById('agentsGrid').innerHTML = '<div class="loading"><div class="spinner"></div>Refreshing agent data...</div>';
            const data = await loadAgentData();
            renderAgents(data);
        }
        
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                refreshInterval = setInterval(refreshData, 5000);
                document.querySelector('[onclick="toggleAutoRefresh()"]').textContent = '‚è∏Ô∏è Auto';
            } else {
                clearInterval(refreshInterval);
                document.querySelector('[onclick="toggleAutoRefresh()"]').textContent = '‚è±Ô∏è Auto';
            }
        }
        
        function showCombatLog() {
            window.open('/combat-visualizer.html', '_blank');
        }
        
        function showEconomy() {
            window.open('/economy-monitor.html', '_blank');
        }
        
        function showZoneMap() {
            window.open('/zone-map.html', '_blank');
        }
        
        // Initialize dashboard
        async function init() {
            console.log('üéÆ Initializing AI Agent RPG Dashboard');
            
            // Connect to real-time updates
            connectWebSocket();
            
            // Load initial data
            await refreshData();
            
            // Start auto-refresh
            toggleAutoRefresh();
            
            console.log('‚úÖ RPG Dashboard ready!');
        }
        
        // Start the dashboard
        window.addEventListener('DOMContentLoaded', init);
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && autoRefresh) {
                clearInterval(refreshInterval);
            } else if (!document.hidden && autoRefresh) {
                refreshInterval = setInterval(refreshData, 5000);
            }
        });
    </script>
</body>
</html>