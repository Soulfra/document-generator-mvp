name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Grant GITHUB_TOKEN the permissions required to make a Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        echo "Installing Node.js dependencies..."
        npm install --silent || echo "No package.json found, skipping npm install"
        
        echo "Installing build tools..."
        npm install -g typescript @typescript-eslint/parser || echo "TypeScript install failed, continuing..."
        
    - name: Simple Build System
      run: |
        echo "🏗️ Running Simple Build System..."
        
        # Make build script executable
        chmod +x simple-build.js
        
        # Run simple build (fast, focused on essentials)
        node simple-build.js
        
        echo "📊 Build completed, checking output..."
        ls -la dist/
        
        echo "📦 Build manifest:"
        if [ -f "dist/build-manifest.json" ]; then
          cat dist/build-manifest.json
        fi
        
    - name: Copy essential files (fallback)
      run: |
        echo "🔄 Ensuring essential files are in dist..."
        
        # Core platform files
        cp -f index.html dist/ 2>/dev/null || echo "index.html already in dist"
        cp -f anontv.html dist/ 2>/dev/null || echo "anontv.html not found"
        
        # SoulFra Auth system
        cp -f professional-portfolio.html dist/ 2>/dev/null || echo "professional-portfolio.html already in dist"
        cp -f admin-dashboard.html dist/ 2>/dev/null || echo "admin-dashboard.html already in dist"
        cp -f soulfra-universal-auth.js dist/ 2>/dev/null || echo "soulfra-universal-auth.js already in dist"
        cp -f cal-cookie-monster.js dist/ 2>/dev/null || echo "cal-cookie-monster.js already in dist"
        cp -f github-admin-bridge.js dist/ 2>/dev/null || echo "github-admin-bridge.js already in dist"
        cp -f auth-system.js dist/ 2>/dev/null || echo "auth-system.js already in dist"
        
        # Supporting files
        cp -f api-config.js dist/ 2>/dev/null || echo "api-config.js already in dist"
        cp -f arweave-wallet-auth.js dist/ 2>/dev/null || echo "arweave-wallet-auth.js not found"
        cp -f cal-alive-character.js dist/ 2>/dev/null || echo "cal-alive-character.js not found"
        
        # MCP demo files
        if [ -d "mcp/src/web-demo" ]; then
          cp -r mcp/src/web-demo dist/ 2>/dev/null || echo "MCP demo files already copied"
        fi
        
        echo "📁 Final dist contents:"
        ls -la dist/
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'dist'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main'