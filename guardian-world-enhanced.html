<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 Guardian World - AI Collaboration Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Layout Grid */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 1fr 300px;
            height: 100vh;
            gap: 1px;
            background: #333;
        }
        
        /* Canvas Section */
        .canvas-section {
            grid-row: 1;
            grid-column: 1;
            position: relative;
            background: radial-gradient(ellipse at center, #0a0a2e 0%, #000 100%);
            overflow: hidden;
        }
        
        #main-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Right Panel */
        .right-panel {
            grid-row: 1;
            grid-column: 2;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
            border-left: 1px solid #333;
        }
        
        /* Guardian Panel */
        .guardian-panel {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            border-bottom: 1px solid #333;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .panel-title {
            font-size: 20px;
            font-weight: bold;
            color: #00ffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Project Workspace */
        .project-workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            background: #111;
        }
        
        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .workspace-title {
            font-size: 16px;
            color: #ff00ff;
        }
        
        .workspace-actions {
            display: flex;
            gap: 10px;
        }
        
        .workspace-btn {
            padding: 5px 10px;
            background: transparent;
            border: 1px solid #666;
            color: #fff;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .workspace-btn:hover {
            background: #333;
            border-color: #00ffff;
        }
        
        /* File Tree */
        .file-tree {
            flex: 1;
            overflow-y: auto;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .file-item {
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: #222;
        }
        
        .file-item.selected {
            background: #333;
            color: #00ffff;
        }
        
        .file-icon {
            width: 16px;
            text-align: center;
        }
        
        /* Bottom Section - Terminal Chat */
        .bottom-section {
            grid-row: 2;
            grid-column: 1 / -1;
            background: #0a0a0a;
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        /* Control Bar */
        .control-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 420px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            gap: 20px;
            align-items: center;
            z-index: 100;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .control-label {
            font-size: 12px;
            color: #888;
            margin-right: 5px;
        }
        
        .control-button {
            padding: 8px 16px;
            background: rgba(0, 100, 255, 0.2);
            border: 1px solid rgba(0, 100, 255, 0.5);
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .control-button:hover {
            background: rgba(0, 100, 255, 0.4);
            transform: translateY(-1px);
        }
        
        .control-button.active {
            background: rgba(0, 255, 0, 0.3);
            border-color: rgba(0, 255, 0, 0.6);
        }
        
        /* Guardian List Styles */
        .guardian-list {
            list-style: none;
        }
        
        .guardian-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .guardian-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .guardian-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--guardian-color);
            box-shadow: 0 0 15px var(--guardian-color);
        }
        
        .guardian-info {
            flex: 1;
        }
        
        .guardian-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .guardian-details {
            font-size: 12px;
            color: #888;
            display: flex;
            gap: 10px;
        }
        
        .guardian-tag {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            font-size: 11px;
        }
        
        /* Task List */
        .task-list {
            margin-top: 10px;
            font-size: 13px;
        }
        
        .task-item {
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid var(--task-color, #666);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-status {
            font-size: 11px;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        /* Loading and dialogs */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 1s;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid #333;
            border-top-color: #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Floating labels */
        .floating-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
        }
        
        .floating-label.visible {
            opacity: 1;
        }
        
        /* Drop zone overlay */
        .drop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 255, 0, 0.1);
            border: 3px dashed rgba(0, 255, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 500;
        }
        
        .drop-overlay.active {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2 style="color: #00ffff; margin-bottom: 10px;">Initializing Guardian World</h2>
            <p style="color: #888;">Awakening AI consciousness...</p>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Canvas Section -->
        <div class="canvas-section">
            <canvas id="main-canvas"></canvas>
            
            <!-- Control Bar -->
            <div class="control-bar">
                <div class="control-group">
                    <button class="control-button" onclick="spawnGuardian()">
                        ✨ Spawn Guardian
                    </button>
                    <button class="control-button" onclick="togglePause()">
                        ⏸️ Pause
                    </button>
                </div>
                
                <div class="control-group">
                    <span class="control-label">View:</span>
                    <button class="control-button" onclick="toggleDebug()">
                        🔍 Debug
                    </button>
                    <button class="control-button" onclick="toggle3D()">
                        🎲 3D Mode
                    </button>
                </div>
                
                <div class="control-group">
                    <span class="control-label">Project:</span>
                    <button class="control-button" onclick="createNewProject()">
                        📁 New Project
                    </button>
                    <button class="control-button" onclick="saveProject()">
                        💾 Save
                    </button>
                </div>
            </div>
            
            <!-- Drop Overlay -->
            <div class="drop-overlay" id="dropOverlay">
                📁 Drop files to process
            </div>
        </div>
        
        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Guardian Panel -->
            <div class="guardian-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>🌟</span>
                        <span>AI Guardians</span>
                    </h2>
                    <div style="font-size: 12px; color: #888;">
                        <span id="onlineCount">0</span> online
                    </div>
                </div>
                
                <ul class="guardian-list" id="guardianList">
                    <!-- Guardians will be populated here -->
                </ul>
            </div>
            
            <!-- Project Workspace -->
            <div class="project-workspace">
                <div class="workspace-header">
                    <h3 class="workspace-title">📂 Project Workspace</h3>
                    <div class="workspace-actions">
                        <button class="workspace-btn" onclick="newFile()">📄 New</button>
                        <button class="workspace-btn" onclick="buildProject()">🔨 Build</button>
                        <button class="workspace-btn" onclick="runTests()">🧪 Test</button>
                    </div>
                </div>
                
                <div class="file-tree" id="fileTree">
                    <div class="file-item">
                        <span class="file-icon">📁</span>
                        <span>No project loaded</span>
                    </div>
                </div>
                
                <div class="task-list" id="taskList">
                    <!-- Tasks will be shown here -->
                </div>
            </div>
        </div>
        
        <!-- Bottom Section - Terminal Chat -->
        <div class="bottom-section" id="chatContainer">
            <!-- Chat system will be injected here -->
        </div>
    </div>
    
    <!-- Floating Label -->
    <div class="floating-label" id="floatingLabel"></div>
    
    <!-- Include all the guardian scripts -->
    <script src="guardian-ai-engine.js"></script>
    <script src="guardian-physics.js"></script>
    <script src="guardian-personalities.js"></script>
    <script src="guardian-visual-effects.js"></script>
    <script src="guardian-chat-system.js"></script>
    <script src="guardian-server-manager.js"></script>
    <script src="guardian-mcp-bridge.js"></script>
    <script src="guardian-project-workspace.js"></script>
    
    <script>
        // Initialize all systems
        let world = null;
        let chatSystem = null;
        let serverManager = null;
        let mcpBridge = null;
        let workspace = null;
        let isPaused = false;
        let debugMode = false;
        let is3DMode = false;
        
        // Initialize everything
        async function initialize() {
            console.log('🌟 Initializing Guardian World Enhanced...');
            
            // Initialize canvas
            const canvas = document.getElementById('main-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            function resizeCanvas() {
                const section = document.querySelector('.canvas-section');
                canvas.width = section.clientWidth;
                canvas.height = section.clientHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Initialize systems
            world = new GuardianWorld(canvas, ctx);
            chatSystem = new GuardianChatSystem();
            serverManager = new GuardianServerManager();
            mcpBridge = new GuardianMCPBridge();
            workspace = new GuardianProjectWorkspace();
            
            // Initialize chat in container
            chatSystem.initialize('chatContainer');
            
            // Register existing guardians with server manager
            world.guardians.forEach(guardian => {
                const registration = serverManager.registerGuardian(guardian);
                updateGuardianUI(guardian, registration);
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Start animation loop
            startAnimation();
            
            // Hide loading overlay
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                chatSystem.addSystemMessage('Guardian World initialized. Welcome to the AI collaboration platform!');
            }, 2000);
        }
        
        function setupEventListeners() {
            // Canvas interactions
            const canvas = document.getElementById('main-canvas');
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                world.handleMouseMove(x, y);
            });
            
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                world.handleClick(x, y);
            });
            
            // Chat message handling
            window.addEventListener('chatMessage', async (e) => {
                const { content, channel } = e.detail;
                
                // Find available guardian to respond
                const availableGuardians = serverManager.getAvailableGuardians();
                if (availableGuardians.length > 0) {
                    const responder = availableGuardians[Math.floor(Math.random() * availableGuardians.length)];
                    
                    // Generate response based on guardian personality
                    setTimeout(() => {
                        const response = generateGuardianResponse(responder, content);
                        chatSystem.receiveGuardianMessage(responder, response);
                    }, 1000 + Math.random() * 2000);
                }
            });
            
            // Tool execution requests
            window.addEventListener('executeTool', async (e) => {
                const { toolName, params } = e.detail;
                
                // Find guardian with permission for this tool
                const tool = mcpBridge.toolRegistry.get(toolName);
                if (tool) {
                    const guardians = serverManager.getGuardiansByRole(tool.requiredRole[0]);
                    if (guardians.length > 0) {
                        const executor = guardians[0];
                        
                        try {
                            chatSystem.addSystemMessage(`${executor.name} is executing ${toolName}...`);
                            const result = await mcpBridge.executeTool(toolName, params, executor);
                            chatSystem.addToolMessage(toolName, params, JSON.stringify(result, null, 2));
                        } catch (error) {
                            chatSystem.addMessage({
                                type: 'error',
                                content: `Tool execution failed: ${error.message}`
                            });
                        }
                    }
                }
            });
            
            // Project commands
            window.addEventListener('projectCommand', (e) => {
                const { action, params } = e.detail;
                
                switch (action) {
                    case 'create':
                        createNewProject(params);
                        break;
                    case 'load':
                        loadProject(params);
                        break;
                    case 'save':
                        saveProject();
                        break;
                }
            });
            
            // Task assignment
            window.addEventListener('assignTask', (e) => {
                const { guardian, task } = e.detail;
                const guardianData = serverManager.getGuardianByTag(guardian);
                
                if (guardianData) {
                    try {
                        const taskRecord = serverManager.assignTask(guardianData.id, {
                            type: 'development',
                            description: task
                        });
                        
                        chatSystem.addSystemMessage(`Task assigned to ${guardianData.name}: ${task}`);
                        updateGuardianUI(guardianData);
                    } catch (error) {
                        chatSystem.addMessage({
                            type: 'error',
                            content: error.message
                        });
                    }
                }
            });
            
            // Status requests
            window.addEventListener('requestStatus', () => {
                const status = serverManager.getServerStatus();
                chatSystem.addSystemMessage(`
Server Status:
- Guardians: ${status.onlineGuardians}/${status.totalGuardians} online
- Busy: ${status.busyGuardians}
- Projects: ${status.activeProjects}
- Pending Tasks: ${status.pendingTasks}
                `.trim());
            });
            
            // Guardian updates
            window.addEventListener('guardian:statusUpdate', (e) => {
                const { guardianId } = e.detail;
                const guardian = world.guardians.find(g => g.id === guardianId);
                if (guardian) {
                    updateGuardianUI(guardian);
                }
            });
            
            // File drop handling
            setupFileDrop();
        }
        
        function setupFileDrop() {
            const dropOverlay = document.getElementById('dropOverlay');
            const canvasSection = document.querySelector('.canvas-section');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                canvasSection.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                canvasSection.addEventListener(eventName, () => {
                    dropOverlay.classList.add('active');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                canvasSection.addEventListener(eventName, () => {
                    dropOverlay.classList.remove('active');
                }, false);
            });
            
            canvasSection.addEventListener('drop', (e) => {
                const files = Array.from(e.dataTransfer.files);
                files.forEach(file => {
                    world.processFile(file);
                    chatSystem.addSystemMessage(`Processing file: ${file.name}`);
                });
            });
        }
        
        function startAnimation() {
            function animate() {
                if (!isPaused && world) {
                    world.update();
                    world.render();
                    
                    // Update online count
                    chatSystem.updateOnlineCount(world.guardians.length);
                }
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }
        
        function updateGuardianUI(guardian, registration = null) {
            const reg = registration || serverManager.guardianRegistry.get(guardian.id);
            if (!reg) return;
            
            let item = document.getElementById(`guardian-${guardian.id}`);
            
            if (!item) {
                item = document.createElement('li');
                item.id = `guardian-${guardian.id}`;
                item.className = 'guardian-item';
                item.style.setProperty('--guardian-color', guardian.color);
                item.onclick = () => showGuardianDetails(guardian);
                document.getElementById('guardianList').appendChild(item);
            }
            
            item.innerHTML = `
                <div class="guardian-avatar" style="--guardian-color: ${guardian.color}">
                    ${guardian.icon}
                </div>
                <div class="guardian-info">
                    <div class="guardian-name">${guardian.name}</div>
                    <div class="guardian-details">
                        <span class="guardian-tag">${reg.role.name}</span>
                        <span class="guardian-tag">${reg.serverId}</span>
                        <span style="color: ${getStatusColor(reg.status)}">${reg.status}</span>
                    </div>
                    ${reg.currentTask ? `
                        <div style="font-size: 11px; margin-top: 4px; color: #666;">
                            Working on: ${reg.currentTask.description}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function getStatusColor(status) {
            const colors = {
                idle: '#888',
                available: '#00ff00',
                working: '#ffaa00',
                busy: '#ff0000'
            };
            return colors[status] || '#fff';
        }
        
        function generateGuardianResponse(guardian, message) {
            const responses = {
                analyzer: [
                    "Let me analyze that for you...",
                    "Interesting pattern detected.",
                    "Based on my analysis, I suggest...",
                    "The data indicates..."
                ],
                learner: [
                    "I'm learning something new!",
                    "That's fascinating, tell me more.",
                    "I'll research that right away.",
                    "Adding this to my knowledge base..."
                ],
                creator: [
                    "I have a creative idea!",
                    "Let me design something for that.",
                    "How about this approach?",
                    "I can visualize a solution..."
                ],
                scanner: [
                    "Scanning for issues...",
                    "Security check complete.",
                    "I found something that needs attention.",
                    "All systems operational."
                ]
            };
            
            const guardianResponses = responses[guardian.type] || responses.learner;
            return guardianResponses[Math.floor(Math.random() * guardianResponses.length)];
        }
        
        // Control functions
        function spawnGuardian() {
            const guardian = world.spawnNewGuardian();
            const registration = serverManager.registerGuardian(guardian);
            updateGuardianUI(guardian, registration);
            chatSystem.addSystemMessage(`${guardian.name} has joined the world!`);
        }
        
        function togglePause() {
            isPaused = !isPaused;
            const button = event.target;
            button.textContent = isPaused ? '▶️ Play' : '⏸️ Pause';
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            world.setDebugMode(debugMode);
            event.target.classList.toggle('active', debugMode);
        }
        
        function toggle3D() {
            is3DMode = !is3DMode;
            event.target.classList.toggle('active', is3DMode);
            // TODO: Implement 3D mode
        }
        
        function createNewProject(name) {
            const projectName = name || prompt('Project name:');
            if (!projectName) return;
            
            const guardians = world.guardians.map(g => g.id);
            const project = workspace.createProject(projectName, 'AI-generated project', guardians);
            
            chatSystem.addSystemMessage(`Created project: ${projectName}`);
            updateFileTree(project);
        }
        
        function saveProject() {
            if (!workspace.activeProject) {
                chatSystem.addMessage({
                    type: 'error',
                    content: 'No active project to save'
                });
                return;
            }
            
            const exported = workspace.exportProject(workspace.activeProject.id);
            console.log('Project exported:', exported);
            chatSystem.addSystemMessage('Project saved successfully');
        }
        
        function updateFileTree(project) {
            const fileTree = document.getElementById('fileTree');
            const files = workspace.getProjectFiles(project.id);
            
            fileTree.innerHTML = files.map(file => `
                <div class="file-item" onclick="openFile('${file.path}')">
                    <span class="file-icon">${getFileIcon(file.path)}</span>
                    <span>${file.path}</span>
                </div>
            `).join('');
        }
        
        function getFileIcon(path) {
            const ext = path.split('.').pop();
            const icons = {
                js: '📜',
                jsx: '⚛️',
                ts: '🔷',
                tsx: '⚛️',
                css: '🎨',
                html: '🌐',
                json: '📋',
                md: '📝'
            };
            return icons[ext] || '📄';
        }
        
        function openFile(path) {
            console.log('Opening file:', path);
            // TODO: Implement file editor
        }
        
        function newFile() {
            const fileName = prompt('File name:');
            if (!fileName || !workspace.activeProject) return;
            
            workspace.createFile(workspace.activeProject.id, fileName);
            updateFileTree(workspace.activeProject);
        }
        
        async function buildProject() {
            if (!workspace.activeProject) return;
            
            const builder = serverManager.getGuardiansByRole('devops')[0];
            if (builder) {
                const build = await workspace.buildProject(workspace.activeProject.id, builder);
                chatSystem.addSystemMessage(`Build started by ${builder.name}`);
            }
        }
        
        async function runTests() {
            if (!workspace.activeProject) return;
            
            const tester = serverManager.getGuardiansByRole('tester')[0];
            if (tester) {
                const tests = await workspace.runTests(workspace.activeProject.id, tester);
                chatSystem.addSystemMessage(`Tests started by ${tester.name}`);
            }
        }
        
        function showGuardianDetails(guardian) {
            const stats = serverManager.getGuardianStats(guardian.id);
            console.log('Guardian stats:', stats);
            // TODO: Show detailed guardian dialog
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', initialize);
        
        console.log('🌟 Guardian World Enhanced loading...');
    </script>
</body>
</html>