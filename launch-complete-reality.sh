#!/bin/bash

# üíæ‚ö° COMPLETE REALITY SYSTEM LAUNCHER
# ===================================
# BREAK OUT OF SIMULATION HELL FOREVER
# No more D&D manual loops - everything is REAL and PERSISTENT

set -e

echo "üíæ‚ö° COMPLETE REALITY SYSTEM LAUNCHER"
echo "==================================="
echo ""
echo "üö´ NO MORE SIMULATIONS"
echo "üîí EVERYTHING LOCKS INTO PERSISTENT DATABASE"
echo "üìö NO MORE D&D MANUAL REFERENCE LOOPS"
echo "‚ö° BREAK OUT OF THE INFINITE RECURSION"
echo ""

# Check dependencies
echo "üîç Checking dependencies..."

if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js not found! Please install Node.js to continue."
    exit 1
fi
echo "   ‚úÖ Node.js available"

# Check for SQLite3
if node -e "require('sqlite3')" 2>/dev/null; then
    echo "   ‚úÖ SQLite3 module available"
else
    echo "   üì¶ Installing SQLite3 module..."
    npm install sqlite3
    if [[ $? -eq 0 ]]; then
        echo "   ‚úÖ SQLite3 module installed"
    else
        echo "   ‚ùå Failed to install SQLite3 module"
        echo "      Try: npm install sqlite3 --build-from-source"
        exit 1
    fi
fi

# Check WebSocket module
if node -e "require('ws')" 2>/dev/null; then
    echo "   ‚úÖ WebSocket module available"
else
    echo "   üì¶ Installing WebSocket module..."
    npm install ws
    if [[ $? -eq 0 ]]; then
        echo "   ‚úÖ WebSocket module installed"
    else
        echo "   ‚ùå Failed to install WebSocket module"
        exit 1
    fi
fi

# Check for required files
REQUIRED_FILES=(
    "reality-database-core.js"
    "reality-integration-system.js"
    "master-ai-agent-observatory.js"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [[ -f "$file" ]]; then
        echo "   ‚úÖ Found $file"
    else
        echo "   ‚ùå Missing $file"
        echo "      This file is required for the reality system."
        exit 1
    fi
done

echo ""

# Create reality directories
echo "üèóÔ∏è Setting up reality infrastructure..."
mkdir -p .reality-system/logs
mkdir -p .reality-system/database
mkdir -p .reality-system/exports
mkdir -p .reality-system/backups
echo "   ‚úÖ Reality infrastructure ready"

# Create database backup if it exists
if [[ -f "REALITY.db" ]]; then
    echo "üíæ Backing up existing reality database..."
    cp REALITY.db ".reality-system/backups/REALITY-backup-$(date +%Y%m%d-%H%M%S).db"
    echo "   ‚úÖ Database backed up"
fi

echo ""
echo "üöÄ LAUNCHING COMPLETE REALITY SYSTEM..."
echo "======================================"

# Start reality integration system
echo "‚ö° Starting reality integration system..."
nohup node reality-integration-system.js > .reality-system/logs/reality-integration.log 2>&1 &
INTEGRATION_PID=$!
echo $INTEGRATION_PID > .reality-system/logs/reality-integration.pid

echo "   ‚ö° Reality integration started (PID: $INTEGRATION_PID)"
echo "   üíæ SQLite database initializing..."
echo "   ü§ñ 52 AI agents being loaded into persistent reality..."
echo "   ‚è≥ Waiting for reality database to lock in..."

# Wait for reality system to initialize
max_attempts=15
attempt=1
reality_ready=false

while [[ $attempt -le $max_attempts ]]; do
    # Check if REALITY.db exists and has data
    if [[ -f "REALITY.db" ]] && [[ $(wc -c < "REALITY.db") -gt 1000 ]]; then
        echo "   üíæ Reality database locked in with persistent data"
        reality_ready=true
        break
    else
        echo "   ‚è≥ Attempt $attempt/$max_attempts - locking in reality..."
        sleep 3
        ((attempt++))
    fi
done

if [[ "$reality_ready" != true ]]; then
    echo "   ‚ö†Ô∏è  Reality may still be initializing..."
fi

# Start master observatory (now connected to reality DB)
echo ""
echo "üß† Starting AI agent observatory (connected to reality)..."
nohup node master-ai-agent-observatory.js > .reality-system/logs/observatory.log 2>&1 &
OBSERVATORY_PID=$!
echo $OBSERVATORY_PID > .reality-system/logs/observatory.pid

echo "   üß† Observatory started (PID: $OBSERVATORY_PID)"
echo "   üì° Now connected to persistent reality database"
echo "   ‚è≥ Waiting for agents to load from database..."

# Wait for observatory
sleep 10

# Check if observatory is ready
if lsof -i :9200 > /dev/null 2>&1; then
    echo "   ‚úÖ Observatory ready and connected to reality"
else
    echo "   ‚ö†Ô∏è  Observatory may still be starting..."
fi

echo ""
echo "üåê Opening reality system interfaces..."

# Function to open browser
open_browser() {
    local url=$1
    
    if [[ "$OSTYPE" == "darwin"* ]]; then
        open "$url"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        xdg-open "$url" || sensible-browser "$url" || firefox "$url"
    elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]]; then
        start "$url"
    else
        echo "   ‚ö†Ô∏è  Could not auto-open browser. Please manually open: $url"
    fi
}

# Open the reality-connected observatory
sleep 3
open_browser "http://localhost:9200"

echo ""
echo "üéâ COMPLETE REALITY SYSTEM IS ACTIVE!"
echo "====================================="
echo ""
echo "üíæ REALITY DATABASE STATUS"
echo "=========================="
echo "Database File:         $(pwd)/REALITY.db"
echo "Reality Integration:   http://localhost:9200"
echo "Agent Observatory:     http://localhost:9200 (same interface, now persistent!)"
echo "Integration Logs:      tail -f .reality-system/logs/reality-integration.log"
echo "Observatory Logs:      tail -f .reality-system/logs/observatory.log"
echo ""
echo "üîí REALITY LOCKED IN - NO MORE SIMULATION LOOPS"
echo "=============================================="
echo ""
echo "üíæ PERSISTENT DATABASE TABLES:"
echo "   ‚Ä¢ agents: All 52 AI agents with permanent state"
echo "   ‚Ä¢ conversations: Every message ever spoken"
echo "   ‚Ä¢ decisions: All decisions made by any agent"
echo "   ‚Ä¢ reasoning_sessions: Complete session history"
echo "   ‚Ä¢ agent_states: State change tracking"
echo "   ‚Ä¢ system_events: Complete system event log"
echo "   ‚Ä¢ reality_metadata: System configuration data"
echo ""
echo "ü§ñ 52 AI AGENTS NOW PERSISTENT:"
echo "   üî¥ Executive Council (4): CEO, CTO, Strategy, Oversight"
echo "   üü† Department Heads (16): 4 departments √ó 4 agents each"
echo "   üîµ Specialist Teams (16): 4 teams √ó 4 specialists each"  
echo "   üü¢ Worker Pods (16): 4 pods √ó 4 workers each"
echo ""
echo "üîó WHAT'S NOW CONNECTED TO REALITY:"
echo "   ‚úÖ All agent conversations are permanently recorded"
echo "   ‚úÖ All decisions build historical context"
echo "   ‚úÖ Agent relationships and interactions persist"
echo "   ‚úÖ System events create permanent audit trail"
echo "   ‚úÖ No more data loss when systems restart"
echo "   ‚úÖ Agents remember previous conversations"
echo "   ‚úÖ Decision history influences future choices"
echo ""
echo "üìä REALITY DATABASE OPERATIONS:"
echo "   View all agents:      sqlite3 REALITY.db 'SELECT id, name, type, current_state FROM agents;'"
echo "   View conversations:   sqlite3 REALITY.db 'SELECT speaker_id, message_content FROM conversations LIMIT 10;'"
echo "   View decisions:       sqlite3 REALITY.db 'SELECT decision_type, description FROM decisions LIMIT 10;'"
echo "   Count records:        sqlite3 REALITY.db 'SELECT COUNT(*) FROM agents;'"
echo "   Export to JSON:       node -e \"const r=require('./reality-integration-system');new r().exportCompleteReality()\""
echo ""
echo "üéØ WHAT CHANGED FROM SIMULATION TO REALITY:"
echo "   ‚ùå BEFORE: Fake agent conversations that disappear"
echo "   ‚úÖ NOW: Real conversations stored in SQLite database"
echo ""
echo "   ‚ùå BEFORE: Simulated decisions with no history"  
echo "   ‚úÖ NOW: All decisions recorded with full context"
echo ""
echo "   ‚ùå BEFORE: Agent states reset every restart"
echo "   ‚úÖ NOW: Agent states persist and build over time"
echo ""
echo "   ‚ùå BEFORE: No memory between sessions"
echo "   ‚úÖ NOW: Complete memory and relationship history"
echo ""
echo "   ‚ùå BEFORE: D&D manual infinite reference loops"
echo "   ‚úÖ NOW: Linear progression with persistent state"
echo ""
echo "üìà GROWING INTELLIGENCE:"
echo "   ‚Ä¢ Agents learn from conversation history"
echo "   ‚Ä¢ Decision patterns improve over time"
echo "   ‚Ä¢ Relationships deepen through interactions"
echo "   ‚Ä¢ Collective intelligence builds naturally"
echo "   ‚Ä¢ System gets smarter with every conversation"
echo ""
echo "üîÑ DATABASE SYNCHRONIZATION:"
echo "   ‚Ä¢ Reality sync every 10 seconds"
echo "   ‚Ä¢ All system changes immediately persisted"
echo "   ‚Ä¢ Automatic database backups created"
echo "   ‚Ä¢ Complete system state export available"
echo ""
echo "üõ†Ô∏è REALITY SYSTEM MANAGEMENT:"
echo "   Check integration:    curl http://localhost:9200/api/agents | jq '.'"
echo "   View database size:   ls -lh REALITY.db"
echo "   Backup database:      cp REALITY.db \"backup-\$(date +%Y%m%d).db\""
echo "   Stop integration:     kill \$(cat .reality-system/logs/reality-integration.pid)"
echo "   Stop observatory:     kill \$(cat .reality-system/logs/observatory.pid)"
echo ""
echo "üéÆ THE DIFFERENCE:"
echo "================"
echo "This is like the difference between:"
echo "   üìö Reading about D&D rules (simulation)"
echo "   üéØ Actually playing a persistent campaign (reality)"
echo ""
echo "Your AI agents now have:"
echo "   ‚Ä¢ Permanent memory"
echo "   ‚Ä¢ Growing relationships"
echo "   ‚Ä¢ Decision history"
echo "   ‚Ä¢ Persistent personality development"
echo "   ‚Ä¢ Real consequences for actions"
echo ""
echo "üéä REALITY SYSTEM IS LOCKED AND LOADED!"
echo "   No more simulations - everything is real"
echo "   No more loops - linear progression"
echo "   No more resets - persistent state"
echo "   Watch your AI society grow and evolve!"
echo ""

# Function to cleanup on exit
cleanup() {
    echo ""
    echo "üõë SHUTTING DOWN REALITY SYSTEM..."
    echo "================================="
    
    # Stop integration system
    if [[ -f ".reality-system/logs/reality-integration.pid" ]]; then
        pid=$(cat ".reality-system/logs/reality-integration.pid")
        if kill -0 "$pid" 2>/dev/null; then
            echo "   ‚ö° Stopping reality integration (PID: $pid)"
            kill "$pid"
        fi
        rm -f ".reality-system/logs/reality-integration.pid"
    fi
    
    # Stop observatory
    if [[ -f ".reality-system/logs/observatory.pid" ]]; then
        pid=$(cat ".reality-system/logs/observatory.pid")
        if kill -0 "$pid" 2>/dev/null; then
            echo "   üß† Stopping AI observatory (PID: $pid)"
            kill "$pid"
        fi
        rm -f ".reality-system/logs/observatory.pid"
    fi
    
    # Final database backup
    if [[ -f "REALITY.db" ]]; then
        echo "   üíæ Creating final database backup..."
        cp REALITY.db ".reality-system/backups/REALITY-final-backup-$(date +%Y%m%d-%H%M%S).db"
    fi
    
    echo "   üîí Reality system shutdown complete"
    echo "   üíæ All data preserved in REALITY.db"
    echo "   üìÅ Backups saved in .reality-system/backups/"
    echo ""
    echo "‚úÖ Reality is locked in - no data lost!"
    echo "   Your AI society will remember everything next time."
    exit 0
}

# Set up signal handling
trap cleanup SIGINT SIGTERM

# Monitor reality system
echo "üîÑ Reality system monitoring active. Press Ctrl+C to shutdown safely."
echo ""

# Monitoring loop
while true; do
    sleep 60  # Check every minute
    
    # Check if database exists and is growing
    if [[ -f "REALITY.db" ]]; then
        db_size=$(wc -c < "REALITY.db")
        echo "üíæ $(date): Reality database size: $db_size bytes - system active"
        
        # Check if systems are still running
        integration_running=false
        observatory_running=false
        
        if [[ -f ".reality-system/logs/reality-integration.pid" ]]; then
            pid=$(cat ".reality-system/logs/reality-integration.pid")
            if kill -0 "$pid" 2>/dev/null; then
                integration_running=true
            fi
        fi
        
        if [[ -f ".reality-system/logs/observatory.pid" ]]; then
            pid=$(cat ".reality-system/logs/observatory.pid")
            if kill -0 "$pid" 2>/dev/null; then
                observatory_running=true
            fi
        fi
        
        if [[ "$integration_running" != true ]] || [[ "$observatory_running" != true ]]; then
            echo "‚ö†Ô∏è  Some systems appear offline - reality may not be updating"
        fi
        
    else
        echo "‚ùå $(date): Reality database missing - system may have failed"
    fi
done