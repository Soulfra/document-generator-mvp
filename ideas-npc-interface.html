<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Ideas NPC - Your Personal Thought Processor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e1e5ee;
            min-height: 100vh;
            padding: 15px;
        }
        
        .npc-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: calc(100vh - 30px);
        }
        
        .npc-header {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
        }
        
        .npc-avatar {
            font-size: 4em;
            margin-bottom: 10px;
        }
        
        .npc-name {
            font-size: 2.2em;
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
            margin-bottom: 5px;
        }
        
        .npc-role {
            color: #888;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .npc-mood {
            display: inline-block;
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            overflow: hidden;
        }
        
        .chat-section {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .section-header {
            background: #2a2a3e;
            padding: 15px;
            color: #ff6b6b;
            font-weight: bold;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.user {
            background: rgba(107, 255, 107, 0.1);
            border-left: 3px solid #6bff6b;
            margin-left: auto;
        }
        
        .message.npc {
            background: rgba(255, 107, 107, 0.1);
            border-left: 3px solid #ff6b6b;
        }
        
        .message-header {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }
        
        .message-content {
            line-height: 1.4;
        }
        
        .input-section {
            padding: 15px;
            border-top: 1px solid #444;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .input-tabs {
            display: flex;
            margin-bottom: 10px;
            gap: 5px;
        }
        
        .input-tab {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }
        
        .input-tab.active {
            background: rgba(255, 107, 107, 0.4);
        }
        
        .input-tab:hover {
            background: rgba(255, 107, 107, 0.3);
        }
        
        .input-form {
            display: none;
        }
        
        .input-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-label {
            color: #ff6b6b;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            color: #e1e5ee;
            padding: 8px;
            border-radius: 3px;
            font-family: inherit;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .submit-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            background: #ff5252;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .sidebar-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            border-radius: 5px;
            overflow: hidden;
            flex: 1;
        }
        
        .panel-content {
            padding: 15px;
            overflow-y: auto;
            max-height: 250px;
        }
        
        .idea-item {
            background: rgba(255, 107, 107, 0.1);
            border-left: 3px solid #ff6b6b;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 3px;
        }
        
        .idea-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .idea-type {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .idea-confidence {
            color: #888;
            font-size: 0.8em;
        }
        
        .idea-content {
            color: #ccc;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .idea-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        
        .idea-tag {
            background: rgba(107, 255, 255, 0.2);
            color: #6bffff;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 0.6em;
        }
        
        .project-item {
            background: rgba(107, 255, 107, 0.1);
            border-left: 3px solid #6bff6b;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 3px;
        }
        
        .project-name {
            color: #6bff6b;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .project-details {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 5px;
        }
        
        .project-value {
            color: #ffff6b;
            font-weight: bold;
        }
        
        .node-item {
            background: rgba(255, 255, 107, 0.1);
            border-left: 3px solid #ffff6b;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 3px;
        }
        
        .node-name {
            color: #ffff6b;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .node-status {
            color: #888;
            font-size: 0.7em;
        }
        
        .node-stats {
            color: #ccc;
            font-size: 0.7em;
            margin-top: 3px;
        }
        
        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 5px;
            font-size: 0.8em;
            z-index: 1000;
        }
        
        .status-connected {
            color: #6bff6b;
        }
        
        .status-disconnected {
            color: #ff6b6b;
        }
        
        .file-drop-zone {
            border: 2px dashed #666;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            color: #888;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .file-drop-zone.dragover {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }
        
        .processing {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar::-webkit-scrollbar-track {
            background: #333;
        }
        
        .scrollbar::-webkit-scrollbar-thumb {
            background: #ff6b6b;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span class="status-disconnected">‚óè Disconnected</span>
    </div>
    
    <div class="npc-container">
        <div class="npc-header">
            <div class="npc-avatar">üß†</div>
            <div class="npc-name" id="npcName">Ideas NPC</div>
            <div class="npc-role" id="npcRole">Personal Thought Processor</div>
            <div class="npc-mood" id="npcMood">Awakening...</div>
        </div>
        
        <div class="main-grid">
            <div class="chat-section">
                <div class="section-header">
                    <span>üí¨ Chat with Ideas NPC</span>
                    <button class="input-tab" onclick="clearChat()">Clear Chat</button>
                </div>
                
                <div class="chat-messages scrollbar" id="chatMessages">
                    <div class="message npc">
                        <div class="message-header">Ideas NPC ‚Ä¢ Just now</div>
                        <div class="message-content">Hello! I'm your Personal Idea Extraction NPC. I'm here to help you organize your thoughts, process your chat logs, and turn your ideas into structured project concepts. What would you like me to analyze today?</div>
                    </div>
                </div>
                
                <div class="input-section">
                    <div class="input-tabs">
                        <div class="input-tab active" onclick="switchTab('chat')">üí¨ Chat</div>
                        <div class="input-tab" onclick="switchTab('file')">üìÅ Files</div>
                        <div class="input-tab" onclick="switchTab('prompt')">üí≠ Prompts</div>
                        <div class="input-tab" onclick="switchTab('bulk')">üìã Bulk Text</div>
                    </div>
                    
                    <div class="input-form active" id="chatForm">
                        <div class="form-group">
                            <textarea class="form-textarea" id="chatInput" placeholder="Tell me about your ideas, paste chat logs, or describe projects..."></textarea>
                        </div>
                        <button class="submit-btn" onclick="sendChat()">Send to NPC</button>
                    </div>
                    
                    <div class="input-form" id="fileForm">
                        <div class="file-drop-zone" id="fileDropZone">
                            <div>üìÅ Drop files here or click to browse</div>
                            <div style="font-size: 0.8em; margin-top: 5px;">Supports: .txt, .md, .json, chat logs</div>
                        </div>
                        <input type="file" id="fileInput" style="display: none;" multiple accept=".txt,.md,.json">
                        <button class="submit-btn" onclick="processFiles()">Process Files</button>
                    </div>
                    
                    <div class="input-form" id="promptForm">
                        <div class="form-group">
                            <label class="form-label">Prompt/Idea:</label>
                            <textarea class="form-textarea" id="promptInput" placeholder="Enter a specific prompt or idea to analyze..."></textarea>
                        </div>
                        <button class="submit-btn" onclick="processPrompt()">Analyze Prompt</button>
                    </div>
                    
                    <div class="input-form" id="bulkForm">
                        <div class="form-group">
                            <label class="form-label">Bulk Text (Chat logs, conversations, etc.):</label>
                            <textarea class="form-textarea" id="bulkInput" placeholder="Paste large amounts of text, chat logs, or conversation history..." style="min-height: 120px;"></textarea>
                        </div>
                        <button class="submit-btn" onclick="processBulkText()">Extract Ideas from Text</button>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-panel">
                    <div class="section-header">üí° Extracted Ideas</div>
                    <div class="panel-content scrollbar" id="extractedIdeas">
                        <div style="color: #888; text-align: center;">No ideas extracted yet</div>
                    </div>
                </div>
                
                <div class="sidebar-panel">
                    <div class="section-header">üöÄ Generated Projects</div>
                    <div class="panel-content scrollbar" id="generatedProjects">
                        <div style="color: #888; text-align: center;">No projects generated yet</div>
                    </div>
                </div>
                
                <div class="sidebar-panel">
                    <div class="section-header">üï∏Ô∏è Processing Nodes</div>
                    <div class="panel-content scrollbar" id="processingNodes">
                        <div style="color: #888; text-align: center;">Nodes loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        class IdeasNPCInterface {
            constructor() {
                this.ws = null;
                this.npcData = null;
                this.ideas = [];
                this.projects = [];
                this.nodes = [];
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                
                this.setupFileHandling();
                this.connect();
            }
            
            connect() {
                try {
                    this.ws = new WebSocket('ws://localhost:8085');
                    
                    this.ws.onopen = () => {
                        console.log('üß† Connected to Ideas NPC');
                        document.getElementById('connectionStatus').innerHTML = 
                            '<span class="status-connected">‚óè Connected to Ideas NPC</span>';
                        this.reconnectAttempts = 0;
                    };
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleNPCMessage(data);
                    };
                    
                    this.ws.onclose = () => {
                        console.log('üß† Disconnected from Ideas NPC');
                        document.getElementById('connectionStatus').innerHTML = 
                            '<span class="status-disconnected">‚óè Disconnected</span>';
                        this.attemptReconnect();
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('üö® WebSocket error:', error);
                    };
                } catch (error) {
                    console.error('üö® Connection failed:', error);
                    this.attemptReconnect();
                }
            }
            
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`üîÑ Reconnect attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
                    setTimeout(() => this.connect(), 3000);
                }
            }
            
            handleNPCMessage(data) {
                switch (data.type) {
                    case 'npc_greeting':
                        this.handleNPCGreeting(data);
                        break;
                    case 'processing_complete':
                        this.handleProcessingComplete(data);
                        break;
                    case 'idea_extracted':
                        this.handleIdeaExtracted(data);
                        break;
                    case 'project_generated':
                        this.handleProjectGenerated(data);
                        break;
                    default:
                        console.log('ü§î Unknown NPC message:', data.type);
                }
            }
            
            handleNPCGreeting(data) {
                this.npcData = data.npc;
                
                document.getElementById('npcName').textContent = data.npc.name;
                document.getElementById('npcRole').textContent = data.npc.role;
                document.getElementById('npcMood').textContent = `Mood: ${data.npc.currentMood}`;
                
                this.addNPCMessage(data.message);
            }
            
            handleProcessingComplete(data) {
                this.addNPCMessage(
                    `Processing complete! I extracted ${data.extracted_count} ideas from your input. ` +
                    `You now have ${data.total_ideas} total ideas in your database.`
                );
                
                if (data.new_projects && data.new_projects.length > 0) {
                    this.addNPCMessage(
                        `I also generated ${data.new_projects.length} new project concepts: ` +
                        data.new_projects.map(p => p.name).join(', ')
                    );
                    
                    data.new_projects.forEach(project => {
                        this.projects.push(project);
                    });
                    this.updateProjectsDisplay();
                }
                
                // Update mood
                if (data.npc_mood) {
                    document.getElementById('npcMood').textContent = `Mood: ${data.npc_mood}`;
                }
            }
            
            handleIdeaExtracted(data) {
                this.ideas.push(data.idea);
                this.updateIdeasDisplay();
            }
            
            handleProjectGenerated(data) {
                this.projects.push(data.project);
                this.updateProjectsDisplay();
            }
            
            addUserMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="message-header">You ‚Ä¢ Just now</div>
                    <div class="message-content">${this.escapeHtml(message)}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            addNPCMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message npc';
                messageDiv.innerHTML = `
                    <div class="message-header">Ideas NPC ‚Ä¢ Just now</div>
                    <div class="message-content">${this.escapeHtml(message)}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            sendChat() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message && this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.addUserMessage(message);
                    
                    this.ws.send(JSON.stringify({
                        type: 'process_chat_log',
                        content: message
                    }));
                    
                    input.value = '';
                } else {
                    alert('Please enter a message and ensure NPC is connected.');
                }
            }
            
            processPrompt() {
                const input = document.getElementById('promptInput');
                const prompt = input.value.trim();
                
                if (prompt && this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.addUserMessage(`Analyzing prompt: "${prompt}"`);
                    
                    this.ws.send(JSON.stringify({
                        type: 'process_prompt',
                        content: prompt
                    }));
                    
                    input.value = '';
                } else {
                    alert('Please enter a prompt and ensure NPC is connected.');
                }
            }
            
            processBulkText() {
                const input = document.getElementById('bulkInput');
                const text = input.value.trim();
                
                if (text && this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.addUserMessage(`Processing ${text.length} characters of bulk text...`);
                    
                    this.ws.send(JSON.stringify({
                        type: 'process_chat_log',
                        content: text
                    }));
                    
                    input.value = '';
                } else {
                    alert('Please enter text and ensure NPC is connected.');
                }
            }
            
            setupFileHandling() {
                const fileDropZone = document.getElementById('fileDropZone');
                const fileInput = document.getElementById('fileInput');
                
                fileDropZone.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.add('dragover');
                });
                
                fileDropZone.addEventListener('dragleave', () => {
                    fileDropZone.classList.remove('dragover');
                });
                
                fileDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileDropZone.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    this.handleFiles(files);
                });
                
                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });
            }
            
            async handleFiles(files) {
                for (const file of files) {
                    if (file.type === 'text/plain' || file.name.endsWith('.md') || file.name.endsWith('.json')) {
                        const content = await this.readFileContent(file);
                        
                        this.addUserMessage(`Processing file: ${file.name} (${file.size} bytes)`);
                        
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({
                                type: 'process_chat_log',
                                content: content,
                                filename: file.name
                            }));
                        }
                    } else {
                        this.addNPCMessage(`Sorry, I can't process ${file.name}. I only support .txt, .md, and .json files currently.`);
                    }
                }
            }
            
            readFileContent(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
            
            updateIdeasDisplay() {
                const container = document.getElementById('extractedIdeas');
                
                if (this.ideas.length === 0) {
                    container.innerHTML = '<div style="color: #888; text-align: center;">No ideas extracted yet</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                // Show latest ideas first
                const recentIdeas = this.ideas.slice(-10).reverse();
                
                recentIdeas.forEach(idea => {
                    const div = document.createElement('div');
                    div.className = 'idea-item';
                    
                    const confidence = (idea.content?.confidence || 0.5) * 100;
                    const tags = idea.tags || [];
                    
                    div.innerHTML = `
                        <div class="idea-header">
                            <span class="idea-type">${idea.content?.type || 'concept'}</span>
                            <span class="idea-confidence">${Math.round(confidence)}%</span>
                        </div>
                        <div class="idea-content">
                            ${this.escapeHtml(idea.content?.description || idea.raw_text || 'No description')}
                        </div>
                        <div class="idea-tags">
                            ${tags.map(tag => `<span class="idea-tag">${tag}</span>`).join('')}
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            }
            
            updateProjectsDisplay() {
                const container = document.getElementById('generatedProjects');
                
                if (this.projects.length === 0) {
                    container.innerHTML = '<div style="color: #888; text-align: center;">No projects generated yet</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                this.projects.forEach(project => {
                    const div = document.createElement('div');
                    div.className = 'project-item';
                    
                    div.innerHTML = `
                        <div class="project-name">${project.name}</div>
                        <div class="project-details">
                            Status: ${project.status} | Layer: ${project.layer || 'personal'}
                        </div>
                        <div class="project-value">Value: ${(project.value || 0).toFixed(2)}</div>
                    `;
                    
                    container.appendChild(div);
                });
            }
            
            updateNodesDisplay() {
                const container = document.getElementById('processingNodes');
                
                // Simulate node data for now
                const nodeData = [
                    { name: 'extractor_node', status: 'ready', processed: 15 },
                    { name: 'tagger_node', status: 'active', processed: 12 },
                    { name: 'grouper_node', status: 'ready', processed: 8 },
                    { name: 'evolver_node', status: 'processing', processed: 5 },
                    { name: 'synthesizer_node', status: 'ready', processed: 3 }
                ];
                
                container.innerHTML = '';
                
                nodeData.forEach(node => {
                    const div = document.createElement('div');
                    div.className = 'node-item';
                    
                    div.innerHTML = `
                        <div class="node-name">${node.name.replace('_', ' ').toUpperCase()}</div>
                        <div class="node-status">Status: ${node.status}</div>
                        <div class="node-stats">Processed: ${node.processed}</div>
                    `;
                    
                    if (node.status === 'processing') {
                        div.classList.add('pulse');
                    }
                    
                    container.appendChild(div);
                });
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        
        // Global functions
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.input-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update forms
            document.querySelectorAll('.input-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(tabName + 'Form').classList.add('active');
        }
        
        function sendChat() {
            npcInterface.sendChat();
        }
        
        function processPrompt() {
            npcInterface.processPrompt();
        }
        
        function processBulkText() {
            npcInterface.processBulkText();
        }
        
        function processFiles() {
            document.getElementById('fileInput').click();
        }
        
        function clearChat() {
            document.getElementById('chatMessages').innerHTML = '';
        }
        
        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChat();
                }
            });
        });
        
        // Start the interface
        const npcInterface = new IdeasNPCInterface();
        
        // Update nodes display periodically
        setInterval(() => {
            npcInterface.updateNodesDisplay();
        }, 5000);
        
        console.log('üß† Ideas NPC Interface loaded');
        console.log('ü§ñ Connecting to ws://localhost:8085');
    </script>
</body>
</html>