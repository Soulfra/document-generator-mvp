{
  "meta": {
    "version": "2.0.0", 
    "description": "Cloudflare Worker-First Domain Routing Configuration",
    "lastUpdated": "2025-01-14T00:00:00Z",
    "purpose": "Ensures ALL traffic flows through Intelligent Universal Router first"
  },

  "routing_architecture": {
    "flow": "Domain → Cloudflare Worker → Backend Services",
    "benefits": [
      "Zero 502 Bad Gateway errors",
      "Intelligent request tagging and analysis", 
      "Missing dependencies become reasoning challenges",
      "Learning system prevents future issues",
      "Multiple fallback layers for reliability"
    ]
  },

  "cloudflare_worker_routes": {
    "primary_domains": [
      {
        "domain": "soulfra.com",
        "routes": [
          "soulfra.com/*",
          "*.soulfra.com/*"
        ],
        "zone_id": "YOUR_SOULFRA_ZONE_ID"
      },
      {
        "domain": "YOUR-MAIN-DOMAIN.com",
        "routes": [
          "YOUR-MAIN-DOMAIN.com/*",
          "*.YOUR-MAIN-DOMAIN.com/*"  
        ],
        "zone_id": "YOUR_MAIN_ZONE_ID"
      },
      {
        "domain": "YOUR-SECOND-DOMAIN.com",
        "routes": [
          "YOUR-SECOND-DOMAIN.com/*",
          "*.YOUR-SECOND-DOMAIN.com/*"
        ],
        "zone_id": "YOUR_SECOND_ZONE_ID"
      },
      {
        "domain": "YOUR-THIRD-DOMAIN.com", 
        "routes": [
          "YOUR-THIRD-DOMAIN.com/*",
          "*.YOUR-THIRD-DOMAIN.com/*"
        ],
        "zone_id": "YOUR_THIRD_ZONE_ID"
      }
    ]
  },

  "backend_services": {
    "internal_cluster": {
      "description": "Docker services running internally",
      "access": "via Cloudflare Worker only",
      "services": {
        "cal-riven": {
          "url": "http://cal-riven-service.soulfra-cal:80",
          "purpose": "Main API service",
          "routes_handled": ["/api/*"]
        },
        "export-service": {
          "url": "http://soulfra-authenticated-export-service.soulfra-cal:3333", 
          "purpose": "Document export processing",
          "routes_handled": ["/export/*"]
        },
        "bridge-service": {
          "url": "http://deathtodata-bridge-service.soulfra-cal:8080",
          "purpose": "Legacy system integration", 
          "routes_handled": ["/bridge/*"]
        },
        "gacha-service": {
          "url": "http://gacha-reward-service.soulfra-cal:7777",
          "purpose": "Gaming and reward system",
          "routes_handled": ["/gacha/*", "/rewards/*"]
        }
      }
    },
    
    "external_fallbacks": {
      "description": "External services for fallback routing",
      "access": "public URLs",
      "services": {
        "vercel-backend": {
          "url": "https://document-generator-mvp.vercel.app",
          "purpose": "Serverless API fallback",
          "routes_handled": ["fallback for /api/*"]
        },
        "railway-backend": {
          "url": "https://document-generator.railway.app", 
          "purpose": "Alternative deployment fallback",
          "routes_handled": ["fallback for all services"]
        }
      }
    }
  },

  "domain_specific_routing": {
    "YOUR-MAIN-DOMAIN.com": {
      "primary_backend": "cal-riven",
      "fallbacks": ["vercel-backend", "static-response"],
      "special_features": [
        "document-processing-challenges",
        "business-dashboard-routing",
        "executive-decision-games"
      ]
    },
    
    "YOUR-SECOND-DOMAIN.com": {
      "primary_backend": "gacha-service",
      "fallbacks": ["cal-riven", "static-trading-response"], 
      "special_features": [
        "agent-economy-challenges",
        "blockchain-reasoning-puzzles",
        "p-money-trading-games"
      ]
    },
    
    "YOUR-THIRD-DOMAIN.com": {
      "primary_backend": "bridge-service",
      "fallbacks": ["cal-riven", "collaborative-static"],
      "special_features": [
        "group-chat-challenges", 
        "world-building-reasoning",
        "collaborative-design-games"
      ]
    }
  },

  "dns_configuration": {
    "required_records": [
      {
        "type": "A/AAAA",
        "name": "@",
        "value": "Cloudflare Proxy IP",
        "proxied": true,
        "note": "Main domain proxied through Cloudflare"
      },
      {
        "type": "CNAME", 
        "name": "*",
        "value": "@",
        "proxied": true,
        "note": "All subdomains proxy through Cloudflare" 
      }
    ],
    "ssl_configuration": {
      "mode": "Full (Strict)",
      "edge_certificates": "Cloudflare managed",
      "origin_certificates": "Required for backend services"
    }
  },

  "intelligent_routing_features": {
    "request_tagging": {
      "enabled": true,
      "tags": [
        "complexity_level",
        "missing_dependencies", 
        "risk_assessment",
        "gamification_eligibility",
        "reasoning_requirements"
      ]
    },
    
    "missing_dependency_handling": {
      "ai-economy-runtime": {
        "action": "reasoning_challenge",
        "reward_tokens": 50,
        "challenge_type": "design_economic_system"
      },
      "real-data-hooks-layer": {
        "action": "reasoning_challenge", 
        "reward_tokens": 35,
        "challenge_type": "design_data_integration"
      },
      "flag-tag-system": {
        "action": "reasoning_challenge",
        "reward_tokens": 25, 
        "challenge_type": "design_organization_system"
      },
      "cobol-http-translator": {
        "action": "reasoning_challenge",
        "reward_tokens": 75,
        "challenge_type": "design_legacy_bridge" 
      }
    },

    "fallback_strategies": {
      "primary_failure": "Try intelligent fallback service",
      "all_services_down": "Present reasoning challenge with rewards",
      "high_risk_requests": "Require human verification first",
      "gaming_requests": "Route to gacha/reward system",
      "unknown_routes": "Present helpful navigation with challenges"
    }
  },

  "deployment_instructions": {
    "step_1": "Deploy Cloudflare Worker",
    "commands": [
      "cd cloudflare-worker/",
      "./deploy-intelligent-router.sh"
    ],
    
    "step_2": "Update DNS Records",
    "instructions": [
      "Set domain DNS to use Cloudflare nameservers",
      "Enable Cloudflare proxy (orange cloud) for all records", 
      "Configure SSL to 'Full (Strict)' mode"
    ],
    
    "step_3": "Update Domain Names",
    "files_to_edit": [
      "cloudflare-worker/wrangler.toml - Update route patterns",
      "DOMAIN-REGISTRY.json - Replace YOUR-DOMAIN.com placeholders",
      "This file - Update domain configurations"
    ],
    
    "step_4": "Deploy Backend Services", 
    "options": [
      "Docker Compose: docker-compose up -d",
      "Vercel: vercel deploy",
      "Railway: railway deploy"  
    ],
    
    "step_5": "Test Routing",
    "test_commands": [
      "curl https://your-domain.com/health",
      "curl https://your-domain.com/api/status", 
      "curl https://your-domain.com/missing-endpoint # Should show reasoning challenge"
    ]
  },

  "monitoring_and_debugging": {
    "cloudflare_dashboard": "https://dash.cloudflare.com/",
    "worker_logs": "wrangler tail", 
    "analytics_endpoints": [
      "/health - Basic health check",
      "/api/router/stats - Router performance metrics",
      "/api/challenges/leaderboard - Reasoning challenge stats"
    ],
    "debug_headers": [
      "X-Intelligence-Route - Which route was used",
      "X-Intelligence-Tags - Request analysis tags",
      "X-Fallback-Reason - Why fallback was triggered"
    ]
  },

  "integration_with_existing": {
    "vercel_deployment": {
      "status": "Compatible as fallback",
      "role": "Fallback service when internal cluster unavailable", 
      "configuration": "No changes needed to vercel.json"
    },
    
    "docker_services": {
      "status": "Primary backend",
      "role": "Main services behind Cloudflare Worker",
      "configuration": "Services remain internal, accessed via Worker only"
    },
    
    "domain_registry": {
      "status": "Enhanced",
      "role": "Defines domain-specific routing behavior", 
      "configuration": "Add cloudflare_routing section to each domain"
    }
  }
}