<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 Document Generator - Complete Ecosystem</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, system-ui, 'Courier New', monospace;
            background: linear-gradient(135deg, #000428 0%, #004e92 100%);
            color: #00ff88;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #00ff88;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.ready {
            background: #00ff88;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .card-icon {
            font-size: 24px;
        }

        .balance-display {
            font-size: 32px;
            color: #00ffff;
            text-align: center;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .button {
            background: linear-gradient(45deg, #00ff88, #00ffff);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
            font-size: 16px;
        }

        .button:hover {
            background: linear-gradient(45deg, #00ffff, #00ff88);
            transform: scale(1.05);
        }

        .button:active {
            transform: scale(0.95);
        }

        .tip-interface {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .tip-amount {
            flex: 1;
            padding: 10px;
            border: 2px solid #00ff88;
            background: rgba(0, 0, 0, 0.5);
            color: #00ff88;
            border-radius: 5px;
            font-size: 16px;
        }

        .user-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #00ff88;
            background: rgba(0, 0, 0, 0.5);
            color: #00ff88;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 16px;
        }

        .activity-feed {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #00ff88;
            padding: 10px;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.3);
        }

        .activity-item {
            padding: 8px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            font-size: 14px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .character-preview {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }

        .character-card {
            flex: 1;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }

        .character-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .navigation {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .nav-button {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .nav-button:hover {
            background: rgba(0, 255, 136, 0.4);
            color: #fff;
        }

        .ascii-art {
            font-family: 'Courier New', monospace;
            white-space: pre;
            text-align: center;
            font-size: 10px;
            color: #00ffff;
            margin: 15px 0;
        }

        /* WebSocket status */
        .ws-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff88;
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .header {
                padding: 10px;
            }
            
            .logo {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">🌟 Document Generator Ecosystem</div>
        <div class="status-indicator">
            <div class="status-dot" id="systemStatus"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        
        <!-- User Profile Card -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">👤</span>
                <span>Your Profile</span>
            </div>
            
            <input type="text" class="user-input" id="userIdInput" placeholder="Enter your user ID (@username)" value="@alice">
            
            <div class="balance-display" id="balanceDisplay">
                Loading...
            </div>
            
            <button class="button" onclick="setupUser()">🚀 Initialize Account</button>
            <button class="button" onclick="refreshBalance()">💰 Refresh Balance</button>
        </div>

        <!-- Tipping Interface -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">💸</span>
                <span>Send Tips</span>
            </div>
            
            <input type="text" class="user-input" id="tipToUser" placeholder="Tip to (@username)">
            
            <div class="tip-interface">
                <input type="number" class="tip-amount" id="tipAmount" placeholder="Amount" min="1" max="1000" value="50">
                <button class="button" onclick="sendTip()">💰 Send Tip</button>
            </div>
            
            <div class="ascii-art" id="tipAscii">
     💰→💎→⚡
TIP → ENERGY → BREED
     </div>
        </div>

        <!-- Character System -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">👥</span>
                <span>Character Breeding</span>
            </div>
            
            <div class="character-preview" id="characterPreview">
                <div class="character-card">
                    <div class="character-avatar">🧬</div>
                    <div>Create Characters</div>
                </div>
            </div>
            
            <input type="text" class="user-input" id="characterName" placeholder="Character name">
            <select class="user-input" id="characterHairColor">
                <option value="golden">Golden</option>
                <option value="silver">Silver</option>
                <option value="copper">Copper</option>
                <option value="brown">Brown</option>
                <option value="black">Black</option>
                <option value="red">Red</option>
            </select>
            
            <button class="button" onclick="createCharacter()">👶 Create Character</button>
            
            <div class="navigation">
                <a href="/characters" class="nav-button">🧬 Breeding Lab</a>
                <a href="/tips" class="nav-button">💰 Tip Center</a>
            </div>
        </div>

        <!-- Live Activity Feed -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">📡</span>
                <span>Live Activity</span>
            </div>
            
            <div class="activity-feed" id="activityFeed">
                <div class="activity-item">🔌 Connecting to live feed...</div>
            </div>
        </div>

    </div>

    <!-- WebSocket Status -->
    <div class="ws-status" id="wsStatus">
        WebSocket: Connecting...
    </div>

    <script>
        // Global state
        let ws = null;
        let currentUser = '@alice';
        let systemReady = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeWebSocket();
            setupUser();
        });

        // WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                updateStatus('connected', '🔗 Connected');
                ws.send(JSON.stringify({
                    type: 'join_user',
                    userId: currentUser
                }));
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            ws.onclose = () => {
                updateStatus('disconnected', '🔌 Disconnected');
                // Try to reconnect
                setTimeout(initializeWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                updateStatus('error', '❌ Error');
                console.error('WebSocket error:', error);
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'connected':
                    updateStatus('ready', '✅ Ready');
                    systemReady = true;
                    break;
                    
                case 'balance_update':
                    updateBalanceDisplay(message.balance);
                    break;
                    
                case 'tip_sent':
                    addActivityItem(`💰 ${message.data.from} tipped ${message.data.to} ${message.data.amount} FART (⚡${message.data.breedingEnergy} energy)`);
                    if (message.data.to === currentUser || message.data.from === currentUser) {
                        refreshBalance();
                    }
                    break;
                    
                case 'character_created':
                    addActivityItem(`👶 ${message.data.userId} created character "${message.data.name}" (${message.data.hairColor} hair)`);
                    break;
                    
                case 'pong':
                    // Keep-alive response
                    break;
            }
        }

        // Setup user account
        async function setupUser() {
            const userInput = document.getElementById('userIdInput').value.trim();
            if (userInput) {
                currentUser = userInput.startsWith('@') ? userInput : '@' + userInput;
                
                // Credit initial balance for testing
                try {
                    const response = await fetch('/api/balance/' + encodeURIComponent(currentUser));
                    const result = await response.json();
                    
                    if (result.balance === 0) {
                        // Setup initial balance via backend (this would be done through the debit controller)
                        addActivityItem(`🎁 Setting up account for ${currentUser}...`);
                    }
                    
                    refreshBalance();
                    
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'join_user',
                            userId: currentUser
                        }));
                    }
                    
                } catch (error) {
                    console.error('Setup error:', error);
                    addActivityItem('❌ Setup failed: ' + error.message);
                }
            }
        }

        // Send tip
        async function sendTip() {
            const toUser = document.getElementById('tipToUser').value.trim();
            const amount = parseInt(document.getElementById('tipAmount').value);
            
            if (!toUser || !amount || amount <= 0) {
                addActivityItem('❌ Please enter valid recipient and amount');
                return;
            }
            
            const recipient = toUser.startsWith('@') ? toUser : '@' + toUser;
            
            try {
                const response = await fetch('/api/tip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from: currentUser,
                        to: recipient,
                        amount: amount
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addActivityItem(`✅ Tip sent! Generated ${result.breedingEnergy} breeding energy`);
                    document.getElementById('tipAmount').value = '';
                    document.getElementById('tipToUser').value = '';
                } else {
                    addActivityItem('❌ Tip failed: ' + result.error);
                }
                
            } catch (error) {
                addActivityItem('❌ Tip error: ' + error.message);
            }
        }

        // Create character
        async function createCharacter() {
            const name = document.getElementById('characterName').value.trim();
            const hairColor = document.getElementById('characterHairColor').value;
            
            if (!name) {
                addActivityItem('❌ Please enter a character name');
                return;
            }
            
            try {
                const response = await fetch('/api/characters/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser,
                        characterData: { name, hairColor }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addActivityItem(`✅ Character "${name}" created with ${hairColor} hair!`);
                    document.getElementById('characterName').value = '';
                    updateCharacterPreview(result.character);
                } else {
                    addActivityItem('❌ Character creation failed: ' + result.error);
                }
                
            } catch (error) {
                addActivityItem('❌ Character error: ' + error.message);
            }
        }

        // Refresh balance
        async function refreshBalance() {
            try {
                const response = await fetch('/api/balance/' + encodeURIComponent(currentUser));
                const result = await response.json();
                
                if (result.success) {
                    updateBalanceDisplay(result.balance);
                } else {
                    addActivityItem('❌ Balance fetch failed: ' + result.error);
                }
                
            } catch (error) {
                addActivityItem('❌ Balance error: ' + error.message);
            }
        }

        // Update UI functions
        function updateStatus(status, text) {
            const statusDot = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            const wsStatus = document.getElementById('wsStatus');
            
            statusDot.className = 'status-dot ' + (status === 'ready' ? 'ready' : '');
            statusText.textContent = text;
            wsStatus.textContent = 'WebSocket: ' + text;
        }

        function updateBalanceDisplay(balance) {
            document.getElementById('balanceDisplay').textContent = balance + ' FART';
        }

        function addActivityItem(text) {
            const feed = document.getElementById('activityFeed');
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.textContent = new Date().toLocaleTimeString() + ' - ' + text;
            
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 20 items
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        function updateCharacterPreview(character) {
            const preview = document.getElementById('characterPreview');
            preview.innerHTML = `
                <div class="character-card">
                    <div class="character-avatar" style="background: linear-gradient(45deg, ${getColorForHair(character.hairColor)}, #4ecdc4);">
                        👤
                    </div>
                    <div>${character.name}</div>
                    <div style="font-size: 12px; color: #00ffff;">${character.hairColor}</div>
                </div>
            `;
        }

        function getColorForHair(color) {
            const colors = {
                golden: '#ffd700',
                silver: '#c0c0c0',
                copper: '#cd7f32',
                brown: '#8b4513',
                black: '#2c2c2c',
                red: '#ff4444'
            };
            return colors[color] || '#666';
        }

        // Keep WebSocket alive
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);
    </script>
</body>
</html>