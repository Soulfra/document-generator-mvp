<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Engineering Laboratory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .profile-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .profile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .profile-card.active {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .typing-animation {
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .score-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .story-response {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .technical-response {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .narrative-mode {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">üß™ AI Prompt Engineering Laboratory</h1>
                    <p class="text-gray-600">Live A/B/C testing with context profiles, storytelling, and reinforcement learning</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600">Ollama Connected</span>
                    </div>
                    <button onclick="openSwipeInterface()" class="px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                        üÉè Swipe Mode
                    </button>
                    <div class="text-sm text-gray-500">Session: #1234</div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Quick Settings Bar -->
        <div class="bg-white rounded-lg shadow-sm mb-6 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="storyMode" class="rounded border-gray-300">
                        <span class="text-sm font-medium">üìö Story Mode</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="reinforcementLearning" class="rounded border-gray-300" checked>
                        <span class="text-sm font-medium">üß† Reinforcement Learning</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="qrTracking" class="rounded border-gray-300">
                        <span class="text-sm font-medium">üì± QR Tracking</span>
                    </label>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="generateQRCode()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Generate QR Session
                    </button>
                    <button onclick="startNewExperiment()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        New A/B Test
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Sidebar: Context Profiles -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">üé≠ Context Profiles</h3>
                    <div class="space-y-3">
                        <div class="profile-card active border-2 border-gray-200 rounded-lg p-3" data-profile="storyteller">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-pink-500 rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm">üìö</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-sm">Story Teller</h4>
                                    <p class="text-xs text-gray-500">Explains through narratives</p>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-600">
                                Score: <span class="font-bold text-green-600">8.7/10</span>
                            </div>
                        </div>

                        <div class="profile-card border-2 border-gray-200 rounded-lg p-3" data-profile="technical">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm">‚öôÔ∏è</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-sm">Technical Expert</h4>
                                    <p class="text-xs text-gray-500">Direct & precise</p>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-600">
                                Score: <span class="font-bold text-blue-600">7.2/10</span>
                            </div>
                        </div>

                        <div class="profile-card border-2 border-gray-200 rounded-lg p-3" data-profile="educator">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm">üéì</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-sm">Educator</h4>
                                    <p class="text-xs text-gray-500">Step-by-step teaching</p>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-600">
                                Score: <span class="font-bold text-yellow-600">6.8/10</span>
                            </div>
                        </div>

                        <div class="profile-card border-2 border-gray-200 rounded-lg p-3" data-profile="casual">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center">
                                    <span class="text-white text-sm">üí¨</span>
                                </div>
                                <div>
                                    <h4 class="font-medium text-sm">Casual Friend</h4>
                                    <p class="text-xs text-gray-500">Conversational tone</p>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-600">
                                Score: <span class="font-bold text-orange-600">5.9/10</span>
                            </div>
                        </div>
                    </div>

                    <!-- Live Scoring -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-sm mb-2">üìä Live Scoring</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span>User Engagement</span>
                                <span class="font-bold">87%</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span>Comprehension</span>
                                <span class="font-bold">92%</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span>Satisfaction</span>
                                <span class="font-bold">85%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QR Code Display -->
                <div class="bg-white rounded-lg shadow-sm p-6 mt-6">
                    <h3 class="text-lg font-semibold mb-4">üì± Session QR</h3>
                    <div id="qrDisplay" class="text-center">
                        <div class="w-32 h-32 bg-gray-100 rounded-lg mx-auto flex items-center justify-center">
                            <span class="text-gray-400 text-sm">Generate QR</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 text-center mt-2">Scan to join session on mobile</p>
                </div>
            </div>

            <!-- Main Content: Question Input & AI Responses -->
            <div class="lg:col-span-2">
                <!-- Question Input -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">üí≠ Ask Your Question</h3>
                    <div class="space-y-4">
                        <textarea 
                            id="questionInput" 
                            class="w-full h-20 p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Ask something like: 'How do I build a shopping cart for my e-commerce site?'"
                        ></textarea>
                        <button onclick="askQuestion()" class="w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-colors">
                            üöÄ Test All Profiles
                        </button>
                    </div>
                </div>

                <!-- AI Responses Comparison -->
                <div class="space-y-6">
                    <!-- Story Teller Response -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-pink-500 rounded-full flex items-center justify-center">
                                    <span class="text-white">üìö</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Story Teller Response</h4>
                                    <p class="text-sm text-gray-500">Narrative-driven explanation</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="scoreResponse('storyteller', 'up')" class="p-2 text-green-600 hover:bg-green-50 rounded-lg">üëç</button>
                                <button onclick="scoreResponse('storyteller', 'down')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">üëé</button>
                                <span class="score-badge text-white px-2 py-1 rounded text-sm">8.7</span>
                            </div>
                        </div>
                        <div id="storyResponse" class="story-response rounded-lg p-4 text-white">
                            <div class="typing-animation">ü§î Story Teller is crafting a narrative...</div>
                        </div>
                    </div>

                    <!-- Technical Expert Response -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                    <span class="text-white">‚öôÔ∏è</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Technical Expert Response</h4>
                                    <p class="text-sm text-gray-500">Direct and precise</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="scoreResponse('technical', 'up')" class="p-2 text-green-600 hover:bg-green-50 rounded-lg">üëç</button>
                                <button onclick="scoreResponse('technical', 'down')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">üëé</button>
                                <span class="score-badge text-white px-2 py-1 rounded text-sm">7.2</span>
                            </div>
                        </div>
                        <div id="technicalResponse" class="technical-response rounded-lg p-4 text-white">
                            <div class="typing-animation">‚öôÔ∏è Technical Expert is analyzing...</div>
                        </div>
                    </div>

                    <!-- Third Response (Dynamic) -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                    <span class="text-white">üéì</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Educator Response</h4>
                                    <p class="text-sm text-gray-500">Step-by-step teaching</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="scoreResponse('educator', 'up')" class="p-2 text-green-600 hover:bg-green-50 rounded-lg">üëç</button>
                                <button onclick="scoreResponse('educator', 'down')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">üëé</button>
                                <span class="score-badge text-white px-2 py-1 rounded text-sm">6.8</span>
                            </div>
                        </div>
                        <div id="educatorResponse" class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                            <div class="typing-animation">üéì Educator is preparing lesson...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar: Analytics & Controls -->
            <div class="lg:col-span-1">
                <!-- Real-time Analytics -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">üìà Live Analytics</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Story Teller Preference</span>
                                <span>67%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-pink-500 h-2 rounded-full" style="width: 67%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Technical Expert</span>
                                <span>23%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 23%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Educator</span>
                                <span>10%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: 10%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Experiment Controls -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">üß™ Experiment Controls</h3>
                    <div class="space-y-3">
                        <button onclick="switchProfile('storyteller')" class="w-full text-left p-3 bg-pink-50 border border-pink-200 rounded-lg hover:bg-pink-100 transition-colors">
                            <div class="font-medium text-sm">Test Story Mode</div>
                            <div class="text-xs text-gray-500">Enhanced narrative responses</div>
                        </button>
                        <button onclick="switchProfile('comparison')" class="w-full text-left p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                            <div class="font-medium text-sm">A/B Compare</div>
                            <div class="text-xs text-gray-500">Side-by-side testing</div>
                        </button>
                        <button onclick="switchProfile('custom')" class="w-full text-left p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="font-medium text-sm">Custom Profile</div>
                            <div class="text-xs text-gray-500">Create new personality</div>
                        </button>
                    </div>
                </div>

                <!-- AI Conductor Status -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">üéº AI Conductor</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Ollama (Local)</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-xs text-green-600">Active</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Claude (Fallback)</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                                <span class="text-xs text-yellow-600">Standby</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Memory System</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-xs text-green-600">Learning</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="text-xs text-gray-600">
                            <div>Sessions: 47</div>
                            <div>Learning Rate: 94%</div>
                            <div>Confidence: High</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock responses for different profiles
        const profileResponses = {
            storyteller: {
                "shopping cart": "üìñ Imagine you're a blacksmith in a medieval village. When a customer comes to your forge, you don't just hand them a sword immediately - you first show them to a special area where they can examine different weapons, compare their weight and balance, and decide what suits their quest. \n\nThis is exactly what a shopping cart does for your e-commerce site! It's like that special area in the blacksmith's shop. Your cart creates a 'holding space' where customers can gather their chosen items, review their decisions, calculate the total cost of their adventure supplies, and then proceed to the final transaction when they're ready to commit to their purchase.\n\nThe magic happens when you make this experience feel like a natural part of their hero's journey, not a tedious administrative task. ‚ú®"
            },
            technical: {
                "shopping cart": "‚öôÔ∏è Shopping Cart Implementation:\n\n1. **Frontend State Management**: Use Redux/Context for cart state\n2. **Data Structure**: Array of objects with {productId, quantity, price, options}\n3. **Persistence**: LocalStorage for guest users, database for authenticated users\n4. **API Endpoints**: \n   - POST /cart/add\n   - PUT /cart/update\n   - DELETE /cart/remove\n   - GET /cart/contents\n5. **Key Features**: \n   - Real-time inventory checking\n   - Price calculation with taxes/shipping\n   - Session management\n   - Cross-device synchronization\n\n**Tech Stack**: React/Vue + Node.js + MongoDB/PostgreSQL\n**Security**: CSRF tokens, input validation, rate limiting"
            },
            educator: {
                "shopping cart": "üéì Let's build your shopping cart step by step!\n\n**Lesson 1: Understanding the Concept**\nA shopping cart is temporary storage that holds items before purchase.\n\n**Lesson 2: Core Components**\n- Add to cart button\n- Cart display/preview\n- Quantity controls\n- Remove item functionality\n- Checkout process\n\n**Lesson 3: Technical Implementation**\nStart with a simple JavaScript array, then enhance:\n```javascript\nlet cart = [];\nfunction addToCart(product) {\n  cart.push(product);\n  updateCartDisplay();\n}\n```\n\n**Lesson 4: Enhancement Options**\n- User accounts for persistence\n- Database storage\n- Payment integration\n- Inventory management\n\n**Practice Exercise**: Build a basic cart with 3 products first!"
            }
        };

        // Profile switching
        function switchProfile(profileType) {
            document.querySelectorAll('.profile-card').forEach(card => {
                card.classList.remove('active');
            });
            
            if (profileType !== 'comparison') {
                document.querySelector(`[data-profile="${profileType}"]`)?.classList.add('active');
            }
        }

        // Question asking with real API
        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            
            if (!question) {
                alert('Please enter a question first!');
                return;
            }
            
            // Show typing indicators
            showTypingIndicators();
            
            try {
                const response = await fetch('/api/laboratory/test-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question,
                        profiles: ['storyteller', 'technical', 'educator'],
                        storyMode: document.getElementById('storyMode').checked,
                        sessionId: window.currentSessionId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    window.currentSessionId = data.data.sessionId;
                    
                    // Display responses
                    data.data.responses.forEach((resp, index) => {
                        const elementIds = ['storyResponse', 'technicalResponse', 'educatorResponse'];
                        if (elementIds[index]) {
                            document.getElementById(elementIds[index]).innerHTML = resp.response;
                        }
                    });
                } else {
                    console.error('API Error:', data.error);
                    alert('Failed to get AI responses. Please try again.');
                }
            } catch (error) {
                console.error('Network Error:', error);
                alert('Network error. Please check if the server is running.');
            }
        }

        function getResponseForProfile(profile, question) {
            // Simple keyword matching for demo
            if (question.includes('shopping') || question.includes('cart') || question.includes('ecommerce')) {
                return profileResponses[profile]['shopping cart'];
            }
            
            // Fallback responses
            const fallbacks = {
                storyteller: "üìñ Let me tell you a story that will illuminate this concept...",
                technical: "‚öôÔ∏è Here's the technical implementation you need...",
                educator: "üéì Let's break this down into manageable learning steps..."
            };
            
            return fallbacks[profile];
        }

        function showTypingIndicators() {
            document.getElementById('storyResponse').innerHTML = '<div class="typing-animation">üìö Story Teller is crafting a narrative...</div>';
            document.getElementById('technicalResponse').innerHTML = '<div class="typing-animation">‚öôÔ∏è Technical Expert is analyzing...</div>';
            document.getElementById('educatorResponse').innerHTML = '<div class="typing-animation">üéì Educator is preparing lesson...</div>';
        }

        // Scoring system
        let scores = {
            storyteller: 8.7,
            technical: 7.2,
            educator: 6.8
        };

        function scoreResponse(profile, direction) {
            if (direction === 'up') {
                scores[profile] = Math.min(10, scores[profile] + 0.1);
            } else {
                scores[profile] = Math.max(0, scores[profile] - 0.1);
            }
            
            // Update score display
            updateScoreDisplays();
            
            // Trigger enhanced emotional feedback learning
            if (document.getElementById('reinforcementLearning').checked) {
                triggerEmotionalLearning(profile, direction);
            }
        }

        function triggerEmotionalLearning(profile, direction) {
            // Detect emotional context from user interaction patterns
            const emotionalContext = detectEmotionalContext(profile, direction);
            
            // Enhanced learning with emotional feedback
            console.log(`üß†üíù Emotional Learning: ${profile} scored ${direction} - emotion: ${emotionalContext.primaryEmotion}`);
            
            // Show enhanced learning indicator with emotional context
            const indicator = document.createElement('div');
            indicator.className = 'fixed top-4 right-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-500';
            indicator.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${emotionalContext.emoji}</span>
                    <span>Learning from ${emotionalContext.primaryEmotion} feedback...</span>
                </div>
            `;
            document.body.appendChild(indicator);
            
            // Animate in
            setTimeout(() => {
                indicator.style.transform = 'translateX(-10px)';
            }, 100);
            
            // Update emotional profile for this AI personality
            updateEmotionalProfile(profile, emotionalContext);
            
            // Send emotional feedback to backend
            sendEmotionalFeedback(profile, direction, emotionalContext);
            
            setTimeout(() => {
                indicator.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    indicator.remove();
                }, 300);
            }, 2500);
        }

        function detectEmotionalContext(profile, direction) {
            // Analyze timing, frequency, and patterns to detect emotional state
            const now = Date.now();
            const recentInteractions = getRecentInteractions(profile);
            
            let primaryEmotion = 'neutral';
            let emoji = 'ü§î';
            let intensity = 0.5;
            
            if (direction === 'up') {
                if (recentInteractions.filter(i => i.direction === 'up').length > 2) {
                    primaryEmotion = 'excitement';
                    emoji = 'üéâ';
                    intensity = 0.9;
                } else {
                    primaryEmotion = 'satisfaction';
                    emoji = 'üòä';
                    intensity = 0.7;
                }
            } else {
                if (recentInteractions.filter(i => i.direction === 'down').length > 2) {
                    primaryEmotion = 'frustration';
                    emoji = 'üò§';
                    intensity = 0.8;
                } else {
                    primaryEmotion = 'disappointment';
                    emoji = 'üòê';
                    intensity = 0.6;
                }
            }
            
            return {
                primaryEmotion,
                emoji,
                intensity,
                timestamp: now,
                context: {
                    profile,
                    direction,
                    recentPattern: recentInteractions.map(i => i.direction).join(''),
                    sessionDuration: now - sessionStartTime
                }
            };
        }

        let userInteractionHistory = [];
        let sessionStartTime = Date.now();

        function getRecentInteractions(profile) {
            const cutoff = Date.now() - 30000; // Last 30 seconds
            return userInteractionHistory
                .filter(i => i.profile === profile && i.timestamp > cutoff)
                .slice(-5); // Last 5 interactions
        }

        function updateEmotionalProfile(profile, emotionalContext) {
            // Store interaction in history
            userInteractionHistory.push({
                profile,
                direction: emotionalContext.context.direction,
                emotion: emotionalContext.primaryEmotion,
                intensity: emotionalContext.intensity,
                timestamp: emotionalContext.timestamp
            });
            
            // Keep only recent history (last 100 interactions)
            if (userInteractionHistory.length > 100) {
                userInteractionHistory = userInteractionHistory.slice(-100);
            }
            
            // Update UI with emotional indicators
            updateEmotionalIndicators(profile, emotionalContext);
        }

        function updateEmotionalIndicators(profile, emotionalContext) {
            // Add emotional indicator to the profile card
            const profileCard = document.querySelector(`[data-profile="${profile}"]`);
            if (profileCard) {
                // Remove existing emotional indicator
                const existingIndicator = profileCard.querySelector('.emotion-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                // Add new emotional indicator
                const emotionIndicator = document.createElement('div');
                emotionIndicator.className = 'emotion-indicator absolute -top-1 -right-1 w-6 h-6 rounded-full flex items-center justify-center text-xs';
                emotionIndicator.style.background = getEmotionColor(emotionalContext.primaryEmotion);
                emotionIndicator.textContent = emotionalContext.emoji;
                emotionIndicator.title = `Current emotion: ${emotionalContext.primaryEmotion} (${Math.round(emotionalContext.intensity * 100)}% intensity)`;
                
                profileCard.style.position = 'relative';
                profileCard.appendChild(emotionIndicator);
                
                // Fade out after 5 seconds
                setTimeout(() => {
                    if (emotionIndicator.parentNode) {
                        emotionIndicator.style.opacity = '0.3';
                    }
                }, 5000);
            }
        }

        function getEmotionColor(emotion) {
            const colors = {
                excitement: 'linear-gradient(45deg, #ff6b6b, #feca57)',
                satisfaction: 'linear-gradient(45deg, #48cae4, #023e8a)',
                frustration: 'linear-gradient(45deg, #e74c3c, #c0392b)',
                disappointment: 'linear-gradient(45deg, #95a5a6, #7f8c8d)',
                neutral: 'linear-gradient(45deg, #bdc3c7, #95a5a6)'
            };
            return colors[emotion] || colors.neutral;
        }

        async function sendEmotionalFeedback(profile, direction, emotionalContext) {
            try {
                await fetch('/api/laboratory/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        profileId: profile,
                        responseId: `response-${Date.now()}`,
                        rating: direction,
                        score: scores[profile],
                        sessionId: window.currentSessionId,
                        emotionalContext: {
                            emotion: emotionalContext.primaryEmotion,
                            intensity: emotionalContext.intensity,
                            timestamp: emotionalContext.timestamp,
                            userPattern: emotionalContext.context.recentPattern
                        }
                    })
                });
            } catch (error) {
                console.error('Failed to send emotional feedback:', error);
            }
        }

        function updateScoreDisplays() {
            // Update score badges and profile cards
            document.querySelectorAll('.score-badge').forEach((badge, index) => {
                const profiles = ['storyteller', 'technical', 'educator'];
                if (profiles[index]) {
                    badge.textContent = scores[profiles[index]].toFixed(1);
                }
            });
        }

        function triggerLearning(profile, direction) {
            // Mock reinforcement learning notification
            console.log(`üß† Learning: ${profile} scored ${direction} - adjusting neural weights`);
            
            // Show brief learning indicator
            const indicator = document.createElement('div');
            indicator.className = 'fixed top-4 right-4 bg-purple-600 text-white px-4 py-2 rounded-lg shadow-lg';
            indicator.innerHTML = 'üß† Learning from feedback...';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 2000);
        }

        // Enhanced QR Code generation
        async function generateQRCode() {
            try {
                const sessionId = window.currentSessionId || 'lab-' + Math.random().toString(36).substr(2, 9);
                
                // Check which profiles are active
                const activeProfiles = [];
                document.querySelectorAll('.profile-card.active').forEach(card => {
                    activeProfiles.push(card.dataset.profile);
                });
                
                const storyMode = document.getElementById('storyMode').checked;
                
                const response = await fetch('/api/laboratory/qr-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId,
                        profiles: activeProfiles.length > 0 ? activeProfiles : ['storyteller', 'technical', 'educator'],
                        storyMode
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Display enhanced QR code
                    document.getElementById('qrDisplay').innerHTML = `
                        <div class="w-32 h-32 bg-gradient-to-br from-blue-500 to-purple-600 mx-auto flex items-center justify-center rounded-lg relative overflow-hidden">
                            <div class="absolute inset-0 bg-black bg-opacity-20"></div>
                            <div class="text-white text-xs text-center z-10">
                                <div class="font-bold">üß™ LAB QR</div>
                                <div class="text-xs mt-1">${data.data.sessionId.slice(-6)}</div>
                                <div class="text-xs mt-1">${activeProfiles.length} AI${activeProfiles.length !== 1 ? 's' : ''}</div>
                                ${storyMode ? '<div class="text-xs">üìö Story</div>' : ''}
                            </div>
                        </div>
                        <div class="text-xs text-center mt-2 text-gray-600">
                            Expires: ${new Date(data.data.expiresAt).toLocaleTimeString()}
                        </div>
                    `;
                    
                    console.log('üîó Enhanced QR Session:', data.data);
                    
                    // Show success feedback
                    showNotification('QR Code generated! Scan to join session on mobile.', 'success');
                } else {
                    console.error('QR Generation Failed:', data.error);
                    showNotification('Failed to generate QR code. Using basic version.', 'warning');
                    generateBasicQR(sessionId);
                }
                
            } catch (error) {
                console.error('QR Generation Error:', error);
                showNotification('Network error. Using basic QR code.', 'error');
                generateBasicQR('lab-' + Math.random().toString(36).substr(2, 9));
            }
        }

        function generateBasicQR(sessionId) {
            // Fallback QR code display
            document.getElementById('qrDisplay').innerHTML = `
                <div class="w-32 h-32 bg-gray-800 mx-auto flex items-center justify-center rounded-lg">
                    <div class="text-white text-xs text-center">
                        QR CODE<br>
                        ${sessionId.slice(-6)}
                    </div>
                </div>
            `;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'warning' ? 'bg-yellow-600' : 
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // New experiment
        function startNewExperiment() {
            // Reset scores with some randomization
            scores.storyteller = 8.0 + Math.random() * 2;
            scores.technical = 7.0 + Math.random() * 1.5;
            scores.educator = 6.5 + Math.random() * 1.8;
            
            updateScoreDisplays();
            
            // Clear responses
            document.getElementById('storyResponse').innerHTML = '<div class="text-gray-400">Waiting for question...</div>';
            document.getElementById('technicalResponse').innerHTML = '<div class="text-gray-400">Waiting for question...</div>';
            document.getElementById('educatorResponse').innerHTML = '<div class="text-gray-400">Waiting for question...</div>';
            
            // Clear input
            document.getElementById('questionInput').value = '';
            
            console.log('üß™ New experiment started');
        }

        // Swipe interface integration
        function openSwipeInterface() {
            // Open swipe interface in a new window or modal
            const swipeWindow = window.open('/components/swipe-decision-interface.html', 'swipeInterface', 'width=400,height=700,resizable=yes,scrollbars=yes');
            
            if (swipeWindow) {
                showNotification('Swipe interface opened! Use it to train AI preferences.', 'success');
                
                // Listen for decisions from swipe interface
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'swipeDecision') {
                        handleSwipeDecision(event.data);
                    }
                });
            } else {
                showNotification('Please allow popups to use swipe interface.', 'warning');
            }
        }

        function handleSwipeDecision(decisionData) {
            console.log('üéØ Swipe decision received:', decisionData);
            
            // Update laboratory based on swipe decisions
            if (decisionData.decision === 'approve' || decisionData.decision === 'always') {
                // Enhance current responses based on the approved pattern
                enhanceCurrentResponses(decisionData);
            }
            
            showNotification(`Applied swipe decision: ${decisionData.decision}`, 'info');
        }

        function enhanceCurrentResponses(decisionData) {
            // Apply the approved enhancement to current responses
            const responseElements = ['storyResponse', 'technicalResponse', 'educatorResponse'];
            
            responseElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element && element.innerHTML && !element.innerHTML.includes('typing-animation')) {
                    // Add enhancement indicator
                    if (!element.querySelector('.enhancement-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'enhancement-badge mt-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full inline-block';
                        badge.innerHTML = `‚ú® Enhanced via ${decisionData.cardType || 'Swipe Decision'}`;
                        element.appendChild(badge);
                    }
                }
            });
        }

        // Real-time collaboration features
        function enableRealtimeCollaboration() {
            // WebSocket connection for real-time updates
            const ws = new WebSocket('ws://localhost:8081');
            
            ws.onopen = () => {
                console.log('üîå WebSocket connected for real-time collaboration');
                showNotification('Real-time collaboration enabled!', 'success');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleRealtimeUpdate(data);
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                showNotification('Real-time collaboration connection failed', 'error');
            };
            
            return ws;
        }

        function handleRealtimeUpdate(data) {
            switch (data.type) {
                case 'laboratory_feedback':
                    updateProfileScore(data.data.profileId, data.data.newScore);
                    break;
                case 'new_user_joined':
                    showNotification(`${data.data.userName} joined the session`, 'info');
                    break;
                case 'swipe_decision_shared':
                    applySharedSwipeDecision(data.data);
                    break;
            }
        }

        function updateProfileScore(profileId, newScore) {
            // Update the score display for the profile
            const scoreElements = document.querySelectorAll('.score-badge');
            const profiles = ['storyteller', 'technical', 'educator'];
            const index = profiles.indexOf(profileId);
            
            if (index !== -1 && scoreElements[index]) {
                scoreElements[index].textContent = newScore.toFixed(1);
                
                // Add visual feedback for the update
                scoreElements[index].classList.add('bg-green-500');
                setTimeout(() => {
                    scoreElements[index].classList.remove('bg-green-500');
                }, 1000);
            }
        }

        function applySharedSwipeDecision(decisionData) {
            showNotification(`Team member applied: ${decisionData.decision}`, 'info');
            enhanceCurrentResponses(decisionData);
        }

        // Advanced prompt processing
        async function processAsyncPrompts() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                showNotification('Please enter a question first!', 'warning');
                return;
            }

            // Show advanced processing indicator
            showNotification('üöÄ Advanced processing: Running concurrent multi-profile analysis...', 'info');
            
            try {
                // Process multiple variations concurrently
                const variations = [
                    { question, storyMode: false, profiles: ['storyteller', 'technical', 'educator'] },
                    { question, storyMode: true, profiles: ['storyteller', 'mirror_child', 'storm_singer'] },
                    { question: `Optimize this for beginners: ${question}`, storyMode: false, profiles: ['educator', 'guardian'] }
                ];

                const results = await Promise.all(
                    variations.map(variation => 
                        fetch('/api/laboratory/test-prompt', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(variation)
                        }).then(r => r.json())
                    )
                );

                // Display comparative analysis
                displayConcurrentResults(results);
                
            } catch (error) {
                console.error('Async processing error:', error);
                showNotification('Advanced processing failed. Using standard mode.', 'error');
            }
        }

        function displayConcurrentResults(results) {
            // Create comparison view
            const comparison = document.createElement('div');
            comparison.className = 'mt-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200';
            comparison.innerHTML = `
                <h4 class="font-semibold text-purple-800 mb-3">üî¨ Concurrent Analysis Results</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    ${results.map((result, index) => `
                        <div class="bg-white p-3 rounded border">
                            <div class="font-medium mb-2">Variation ${index + 1}</div>
                            <div class="text-gray-600">
                                Profiles: ${result.data?.responses?.map(r => r.profileName).join(', ') || 'N/A'}
                            </div>
                            <div class="text-gray-600">
                                Avg Confidence: ${result.data?.responses?.reduce((sum, r) => sum + r.metadata.confidence, 0) / (result.data?.responses?.length || 1) * 100 || 0}%
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Insert after the main responses
            const responsesContainer = document.querySelector('.space-y-6');
            if (responsesContainer) {
                responsesContainer.appendChild(comparison);
            }
        }

        // Initialize with example question and enhanced features
        window.onload = function() {
            document.getElementById('questionInput').value = "How do I build a shopping cart for my e-commerce site?";
            
            // Enable real-time collaboration
            const ws = enableRealtimeCollaboration();
            
            // Add advanced processing button
            const advancedBtn = document.createElement('button');
            advancedBtn.onclick = processAsyncPrompts;
            advancedBtn.className = 'ml-2 px-3 py-2 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg hover:from-green-700 hover:to-teal-700 transition-colors';
            advancedBtn.innerHTML = 'üöÄ Advanced Processing';
            
            const askButton = document.querySelector('button[onclick="askQuestion()"]');
            if (askButton && askButton.parentNode) {
                askButton.parentNode.appendChild(advancedBtn);
            }
        };
    </script>
</body>
</html>