#!/bin/bash

# DOCUMENT GENERATOR VAULT INSTALLER
# Installs the vault app and integrates with macOS

echo "ðŸŽ Installing Document Generator Vault..."

# Get current directory
VAULT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_NAME="DocumentGeneratorVault"
APP_PATH="${VAULT_DIR}/${APP_NAME}.app"

echo "ðŸ“ Installation source: ${APP_PATH}"

# Check if app bundle exists
if [ ! -d "${APP_PATH}" ]; then
    echo "âŒ App bundle not found at: ${APP_PATH}"
    echo "âŒ Please make sure you're running this script from the correct directory"
    exit 1
fi

# Check for Node.js
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js not found. Please install Node.js first:"
    echo "   https://nodejs.org/en/download/"
    exit 1
fi

echo "âœ… Node.js found: $(node --version)"

# Make executable permissions
echo "ðŸ”§ Setting executable permissions..."
chmod +x "${APP_PATH}/Contents/MacOS/${APP_NAME}"

# Copy app to Applications (optional)
read -p "ðŸ“± Install to Applications folder? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if [ -d "/Applications/${APP_NAME}.app" ]; then
        echo "ðŸ—‘ï¸ Removing existing installation..."
        rm -rf "/Applications/${APP_NAME}.app"
    fi

    echo "ðŸ“ Copying app to Applications..."
    cp -R "${APP_PATH}" "/Applications/"
    
    if [ $? -eq 0 ]; then
        echo "âœ… App installed to Applications folder"
        INSTALLED_PATH="/Applications/${APP_NAME}.app"
    else
        echo "âš ï¸ Failed to copy to Applications, using local installation"
        INSTALLED_PATH="${APP_PATH}"
    fi
else
    echo "ðŸ“ Using local installation"
    INSTALLED_PATH="${APP_PATH}"
fi

# Create command line alias
echo "ðŸ”— Creating command line tools..."

# Create vault-cli command
sudo tee /usr/local/bin/vault-cli > /dev/null << EOF
#!/bin/bash
open "${INSTALLED_PATH}"
EOF

sudo chmod +x /usr/local/bin/vault-cli

# Create direct convergence commands
sudo tee /usr/local/bin/vault-converge > /dev/null << EOF
#!/bin/bash
cd "${VAULT_DIR}"
node convergence-engine.js converge
EOF

sudo chmod +x /usr/local/bin/vault-converge

echo "âœ… Installation complete!"
echo ""
echo "ðŸš€ Usage Options:"
echo ""
echo "   ðŸ“± GUI Application:"
if [[ $INSTALLED_PATH == "/Applications"* ]]; then
    echo "      â€¢ Open from Applications folder"
    echo "      â€¢ Spotlight search: '${APP_NAME}'"
fi
echo "      â€¢ Command: open '${INSTALLED_PATH}'"
echo "      â€¢ Alias: vault-cli"
echo ""
echo "   âš¡ Direct Commands:"
echo "      â€¢ vault-converge           # Run convergence directly"
echo "      â€¢ cd '${VAULT_DIR}' && npm run converge"
echo ""
echo "ðŸ§¬ Character System Ready:"
echo "   ðŸ’¥ Ralph - Chaos coordination (70% in chaos mirror)"
echo "   ðŸŽ¯ Cal - Simplification specialist (70% in simple mirror)"
echo "   ðŸŽ¨ Arty - Design enhancement (20% aesthetic weight)"
echo "   ðŸ›¡ï¸ Charlie - Security protection (20% protection weight)"
echo ""
echo "ðŸŽ¯ Features Available:"
echo "   âš¡ Template convergence and deduplication"
echo "   ðŸ’° Template marketplace with buy/sell"
echo "   ðŸ—„ï¸ File vault with versioning"
echo "   ðŸŒ OSS network and ARD management"
echo "   ðŸ“– Automatic README/documentation generation"
echo ""
echo "ðŸŽ‰ Ready to use! Open the app and start converging your templates!"

# Optional: Generate initial README
echo ""
read -p "ðŸ“ Generate README for your vault? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ðŸ“ Generating vault README..."
    
    cat > "${VAULT_DIR}/README-VAULT-QUICK-START.md" << 'EOF'
# ðŸ›ï¸ Document Generator Vault - Quick Start

## ðŸŽ¯ What This Is

Your unified vault for template convergence, character systems, and document processing.

### âš¡ Quick Actions

```bash
# Open the vault app
vault-cli

# Run convergence directly
vault-converge

# Scan for duplicates
npm run context-scan scan

# Mix character contexts  
npm run context-mix mix
```

### ðŸ§¬ Character System

- **ðŸ’¥ Ralph (Chaos)**: Real-time monitoring, bash operations, complex systems
- **ðŸŽ¯ Cal (Simple)**: Clean interfaces, external integration, optimization
- **ðŸŽ¨ Arty (Design)**: Aesthetic enhancement, creative solutions
- **ðŸ›¡ï¸ Charlie (Security)**: Protection, strategic deployment, reliability

### ðŸ’° Economy Features

- Buy and sell templates in the marketplace
- $127 starting vault balance
- Templates: Convergence Engine ($15), Character System ($25), etc.

### ðŸ”§ Integration

Your vault integrates with:
- Existing file systems and vaults
- OSS network and ARD management
- Economy and marketplace systems
- Documentation and storytelling tools

**Template layer confusion = SOLVED!** ðŸŽ‰

Generated by Document Generator Vault Installer
EOF

    echo "âœ… README created: README-VAULT-QUICK-START.md"
fi

echo ""
echo "ðŸŽŠ Installation successful! Enjoy your unified document vault!"