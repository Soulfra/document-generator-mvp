<!DOCTYPE html>
<html>
<head>
    <title>üîÆ Soulfra Capsule Mesh - 4 Layer Visualization</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: radial-gradient(circle at center, #1a0033, #000000);
            color: #ff00ff;
            overflow: hidden;
            position: relative;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .capsule-panel {
            position: absolute;
            background: rgba(255, 0, 255, 0.1);
            border: 2px solid;
            border-radius: 15px;
            padding: 20px;
            font-size: 11px;
            backdrop-filter: blur(15px);
            pointer-events: auto;
            transition: all 0.3s;
        }
        
        .capsule-panel:hover {
            background: rgba(255, 0, 255, 0.2);
            transform: scale(1.02);
        }
        
        #identity-panel {
            top: 20px;
            left: 20px;
            min-width: 280px;
            border-color: #ff0080;
            color: #ff0080;
        }
        
        #memory-panel {
            top: 20px;
            right: 20px;
            min-width: 260px;
            border-color: #8000ff;
            color: #8000ff;
        }
        
        #interaction-panel {
            bottom: 20px;
            left: 20px;
            min-width: 300px;
            border-color: #00ff80;
            color: #00ff80;
        }
        
        #projection-panel {
            bottom: 20px;
            right: 20px;
            min-width: 280px;
            border-color: #ffff00;
            color: #ffff00;
        }
        
        .capsule-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 0 10px currentColor;
        }
        
        .capsule-data {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .capsule-value {
            font-weight: bold;
            opacity: 0.9;
        }
        
        .visibility-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .visibility-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        .mesh-pattern {
            font-family: monospace;
            font-size: 6px;
            line-height: 1;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre;
            max-height: 100px;
            overflow: hidden;
        }
        
        .essence-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin: 2px;
            opacity: 0.8;
        }
        
        .memory-segment {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin: 1px;
            border-radius: 2px;
            opacity: 0.7;
        }
        
        .goal-progress {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .goal-name {
            flex: 1;
            font-size: 10px;
        }
        
        .goal-bar {
            width: 60px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-left: 10px;
            overflow: hidden;
        }
        
        .goal-fill {
            height: 100%;
            background: currentColor;
            border-radius: 3px;
            transition: width 0.5s;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin: 3px 0;
            font-size: 10px;
        }
        
        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connection-active { background: #00ff00; }
        .connection-pending { background: #ffff00; }
        .connection-inactive { background: #666; }
        
        #center-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ff00ff;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #ff00ff;
            backdrop-filter: blur(10px);
        }
        
        .device-signature {
            font-size: 12px;
            opacity: 0.8;
            margin: 5px 0;
        }
        
        .capsule-sync-status {
            margin: 10px 0;
        }
        
        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 3px;
            animation: pulse 2s infinite;
        }
        
        .sync-active { background: #00ff00; }
        .sync-updating { background: #ffff00; }
        .sync-error { background: #ff0000; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .layer-controls {
            margin-top: 15px;
        }
        
        .layer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid currentColor;
            color: currentColor;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            margin: 2px;
            font-size: 9px;
            transition: all 0.3s;
        }
        
        .layer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .layer-btn.active {
            background: currentColor;
            color: #000;
        }
        
        #floating-stats {
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #ff00ff;
            border-radius: 10px;
            padding: 15px;
            color: #ff00ff;
            font-size: 10px;
            pointer-events: auto;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .capsule-mesh-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: glow 3s infinite;
        }
        
        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 0 5px currentColor;
                opacity: 0.8;
            }
            50% { 
                box-shadow: 0 0 20px currentColor;
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        
        <div id="ui-overlay">
            <!-- Identity Capsule Panel -->
            <div id="identity-panel" class="capsule-panel">
                <div class="capsule-mesh-indicator">1</div>
                <div class="capsule-header">üîí IDENTITY CAPSULE</div>
                
                <div class="capsule-data">
                    <span>Soul Name:</span>
                    <span class="capsule-value" id="identity-name">Loading...</span>
                </div>
                
                <div class="capsule-data">
                    <span>Form:</span>
                    <span class="capsule-value" id="identity-form">Unknown</span>
                </div>
                
                <div class="capsule-data">
                    <span>Essence:</span>
                    <div id="essence-indicators"></div>
                </div>
                
                <div>Mesh Visibility:</div>
                <div class="visibility-bar">
                    <div class="visibility-fill" id="identity-visibility" style="background: #ff0080; width: 30%;"></div>
                </div>
                
                <div class="mesh-pattern" id="identity-pattern">‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë\n‚ñë‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñà\n‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n‚ñà‚ñà‚ñà‚ñë‚ñë‚ñà‚ñà‚ñà</div>
                
                <div class="layer-controls">
                    <button class="layer-btn" onclick="toggleIdentityEncryption()">üîê Encrypt</button>
                    <button class="layer-btn" onclick="regenerateIdentity()">üîÑ Regen</button>
                </div>
            </div>
            
            <!-- Memory Capsule Panel -->
            <div id="memory-panel" class="capsule-panel">
                <div class="capsule-mesh-indicator">2</div>
                <div class="capsule-header">üß† MEMORY CAPSULE</div>
                
                <div class="capsule-data">
                    <span>Experiences:</span>
                    <span class="capsule-value" id="memory-experiences">0</span>
                </div>
                
                <div class="capsule-data">
                    <span>Patterns:</span>
                    <span class="capsule-value" id="memory-patterns">0</span>
                </div>
                
                <div>Memory Segments:</div>
                <div id="memory-segments"></div>
                
                <div>Mesh Visibility:</div>
                <div class="visibility-bar">
                    <div class="visibility-fill" id="memory-visibility" style="background: #8000ff; width: 60%;"></div>
                </div>
                
                <div class="capsule-data">
                    <span>Recent:</span>
                    <span class="capsule-value" id="memory-recent">None</span>
                </div>
                
                <div class="layer-controls">
                    <button class="layer-btn" onclick="compactMemory()">üóúÔ∏è Compact</button>
                    <button class="layer-btn" onclick="shareMemory()">üì§ Share</button>
                </div>
            </div>
            
            <!-- Interaction Capsule Panel -->
            <div id="interaction-panel" class="capsule-panel">
                <div class="capsule-mesh-indicator">3</div>
                <div class="capsule-header">ü§ù INTERACTION CAPSULE</div>
                
                <div class="capsule-data">
                    <span>Active:</span>
                    <span class="capsule-value" id="interaction-active">0</span>
                </div>
                
                <div class="capsule-data">
                    <span>Trusted:</span>
                    <span class="capsule-value" id="interaction-trusted">0</span>
                </div>
                
                <div>Connections:</div>
                <div id="connection-list"></div>
                
                <div>Mesh Visibility:</div>
                <div class="visibility-bar">
                    <div class="visibility-fill" id="interaction-visibility" style="background: #00ff80; width: 80%;"></div>
                </div>
                
                <div class="capsule-data">
                    <span>Style:</span>
                    <span class="capsule-value" id="interaction-style">Adaptive</span>
                </div>
                
                <div class="layer-controls">
                    <button class="layer-btn" onclick="broadcastPresence()">üì° Broadcast</button>
                    <button class="layer-btn" onclick="initiateHandshake()">ü§ù Handshake</button>
                </div>
            </div>
            
            <!-- Projection Capsule Panel -->
            <div id="projection-panel" class="capsule-panel">
                <div class="capsule-mesh-indicator">4</div>
                <div class="capsule-header">üéØ PROJECTION CAPSULE</div>
                
                <div class="capsule-data">
                    <span>Vision:</span>
                    <span class="capsule-value" id="projection-vision">Forming...</span>
                </div>
                
                <div>Goals Progress:</div>
                <div id="goals-progress"></div>
                
                <div>Mesh Visibility:</div>
                <div class="visibility-bar">
                    <div class="visibility-fill" id="projection-visibility" style="background: #ffff00; width: 70%;"></div>
                </div>
                
                <div class="capsule-data">
                    <span>Evolution:</span>
                    <span class="capsule-value" id="projection-evolution">30%</span>
                </div>
                
                <div class="layer-controls">
                    <button class="layer-btn" onclick="visualizeFuture()">üîÆ Visualize</button>
                    <button class="layer-btn" onclick="alignGoals()">‚ö° Align</button>
                </div>
            </div>
            
            <!-- Center Device Info -->
            <div id="center-info">
                <div style="font-size: 18px; margin-bottom: 10px;">üîÆ SOULFRA CAPSULE MESH</div>
                <div class="device-signature">Device: <span id="device-id">Loading...</span></div>
                <div class="device-signature">Fingerprint: <span id="device-fingerprint">Generating...</span></div>
                
                <div class="capsule-sync-status">
                    <span>Capsule Sync:</span>
                    <span class="sync-indicator sync-active" id="sync-identity"></span>
                    <span class="sync-indicator sync-active" id="sync-memory"></span>
                    <span class="sync-indicator sync-active" id="sync-interaction"></span>
                    <span class="sync-indicator sync-active" id="sync-projection"></span>
                </div>
                
                <div style="margin-top: 15px; font-size: 10px; opacity: 0.7;">
                    4 Layers ‚Ä¢ Mesh Integrated ‚Ä¢ Handshake Secured
                </div>
            </div>
            
            <!-- Floating Stats -->
            <div id="floating-stats">
                <div style="font-weight: bold; margin-bottom: 10px;">üìä CAPSULE STATS</div>
                
                <div class="stat-row">
                    <span>Total Capacity:</span>
                    <span id="total-capacity">100%</span>
                </div>
                
                <div class="stat-row">
                    <span>Mesh Efficiency:</span>
                    <span id="mesh-efficiency">85%</span>
                </div>
                
                <div class="stat-row">
                    <span>Sync Status:</span>
                    <span id="sync-status">Active</span>
                </div>
                
                <div class="stat-row">
                    <span>Handshakes:</span>
                    <span id="handshake-count">0</span>
                </div>
                
                <div class="stat-row">
                    <span>Visibility:</span>
                    <span id="average-visibility">0%</span>
                </div>
                
                <div style="margin-top: 10px; font-size: 9px; opacity: 0.6;">
                    Updates every 10s
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Three.js scene for 3D capsule visualization
        let scene, camera, renderer;
        let capsuleGroups = {};
        let meshLines = [];
        let particleSystems = [];
        
        // Capsule data
        let capsuleData = null;
        let deviceInfo = null;
        
        function init() {
            // Initialize Three.js
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000011, 0.001);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 50);
            
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000011);
            
            // Lighting for capsule visualization
            const ambientLight = new THREE.AmbientLight(0x330033, 0.4);
            scene.add(ambientLight);
            
            const pointLight = new THREE.PointLight(0xff00ff, 1, 100);
            pointLight.position.set(0, 0, 20);
            scene.add(pointLight);
            
            // Create capsule visualization
            createCapsuleVisualization();
            
            // Start data fetching
            fetchCapsuleData();
            setInterval(fetchCapsuleData, 10000);
            
            // Start render loop
            animate();
            
            console.log('üîÆ Soulfra Capsule Mesh Visualizer initialized');
        }
        
        function createCapsuleVisualization() {
            const capsuleConfigs = [
                { name: 'identity', position: [-20, 15, 0], color: 0xff0080, size: 8 },
                { name: 'memory', position: [20, 15, 0], color: 0x8000ff, size: 7 },
                { name: 'interaction', position: [-20, -15, 0], color: 0x00ff80, size: 6 },
                { name: 'projection', position: [20, -15, 0], color: 0xffff00, size: 7 }
            ];
            
            capsuleConfigs.forEach(config => {
                const group = new THREE.Group();
                
                // Main capsule sphere
                const geometry = new THREE.SphereGeometry(config.size, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: config.color,
                    transparent: true,
                    opacity: 0.7,
                    emissive: config.color,
                    emissiveIntensity: 0.1
                });
                const sphere = new THREE.Mesh(geometry, material);
                group.add(sphere);
                
                // Capsule ring
                const ringGeometry = new THREE.RingGeometry(config.size * 1.2, config.size * 1.4, 32);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: config.color,
                    transparent: true,
                    opacity: 0.5,
                    side: THREE.DoubleSide
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.rotation.x = Math.PI / 2;
                group.add(ring);
                
                // Position group
                group.position.set(...config.position);
                scene.add(group);
                
                capsuleGroups[config.name] = {
                    group: group,
                    sphere: sphere,
                    ring: ring,
                    config: config
                };
                
                // Create particle system for capsule
                createCapsuleParticles(config.name, config.position, config.color);
            });
            
            // Create central connection hub
            const hubGeometry = new THREE.IcosahedronGeometry(3, 1);
            const hubMaterial = new THREE.MeshPhongMaterial({
                color: 0xff00ff,
                wireframe: true,
                transparent: true,
                opacity: 0.8
            });
            const hub = new THREE.Mesh(hubGeometry, hubMaterial);
            scene.add(hub);
            
            // Create mesh connection lines
            createMeshConnections();
        }
        
        function createCapsuleParticles(capsuleName, position, color) {
            const particleCount = 50;
            const particles = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount * 3; i += 3) {
                positions[i] = position[0] + (Math.random() - 0.5) * 20;
                positions[i + 1] = position[1] + (Math.random() - 0.5) * 20;
                positions[i + 2] = position[2] + (Math.random() - 0.5) * 20;
            }
            
            particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const particleMaterial = new THREE.PointsMaterial({
                color: color,
                size: 0.5,
                transparent: true,
                opacity: 0.6
            });
            
            const particleSystem = new THREE.Points(particles, particleMaterial);
            scene.add(particleSystem);
            
            particleSystems.push({
                name: capsuleName,
                system: particleSystem,
                basePositions: positions.slice()
            });
        }
        
        function createMeshConnections() {
            const connections = [
                ['identity', 'memory'],
                ['memory', 'interaction'],
                ['interaction', 'projection'],
                ['projection', 'identity'],
                ['identity', 'interaction'],
                ['memory', 'projection']
            ];
            
            connections.forEach(([from, to]) => {
                const fromPos = capsuleGroups[from].group.position;
                const toPos = capsuleGroups[to].group.position;
                
                const geometry = new THREE.BufferGeometry();
                const positions = [
                    fromPos.x, fromPos.y, fromPos.z,
                    toPos.x, toPos.y, toPos.z
                ];
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                
                const material = new THREE.LineBasicMaterial({
                    color: 0xff00ff,
                    transparent: true,
                    opacity: 0.3
                });
                
                const line = new THREE.Line(geometry, material);
                scene.add(line);
                meshLines.push(line);
            });
        }
        
        async function fetchCapsuleData() {
            try {
                const response = await fetch('/api/mesh-data');
                const data = await response.json();
                
                deviceInfo = {
                    deviceId: data.deviceId,
                    fingerprint: data.fingerprint
                };
                
                capsuleData = data.capsuleLayers;
                
                updateCapsuleUI();
                updateCapsuleVisualization();
                
            } catch (error) {
                console.error('Failed to fetch capsule data:', error);
                // Use mock data for demonstration
                useMockCapsuleData();
            }
        }
        
        function useMockCapsuleData() {
            deviceInfo = {
                deviceId: 'demo_device_001',
                fingerprint: 'mock_fingerprint_12345'
            };
            
            capsuleData = {
                capsuleLayers: {
                    identity: {
                        data: { name: 'Soul_demo01' },
                        meshVisibility: { handshakeView: 0.3 }
                    },
                    memory: {
                        data: { recentExperiences: ['demo', 'test'] },
                        meshVisibility: { handshakeView: 0.6 }
                    },
                    interaction: {
                        data: { currentInteractions: [] },
                        meshVisibility: { handshakeView: 0.8 }
                    },
                    projection: {
                        data: { futureGoals: [{ id: 'demo', progress: 0.3 }] },
                        meshVisibility: { handshakeView: 0.7 }
                    }
                }
            };
            
            updateCapsuleUI();
        }
        
        function updateCapsuleUI() {
            // Update device info
            document.getElementById('device-id').textContent = deviceInfo.deviceId.substring(0, 16);
            document.getElementById('device-fingerprint').textContent = deviceInfo.fingerprint.substring(0, 16) + '...';
            
            // Update identity panel
            if (capsuleData.capsuleLayers && capsuleData.capsuleLayers.identity) {
                const identity = capsuleData.capsuleLayers.identity;
                document.getElementById('identity-name').textContent = identity.data.name || 'Unknown';
                document.getElementById('identity-form').textContent = identity.data.manifestation?.primaryForm || 'Unknown';
                
                // Update visibility bar
                const visibilityPercent = (identity.meshVisibility.handshakeView * 100);
                document.getElementById('identity-visibility').style.width = visibilityPercent + '%';
            }
            
            // Update memory panel
            if (capsuleData.capsuleLayers && capsuleData.capsuleLayers.memory) {
                const memory = capsuleData.capsuleLayers.memory;
                document.getElementById('memory-experiences').textContent = memory.data.recentExperiences?.length || 0;
                document.getElementById('memory-patterns').textContent = Object.keys(memory.data.learnedPatterns || {}).length;
                
                // Update memory segments visualization
                updateMemorySegments(memory);
                
                const visibilityPercent = (memory.meshVisibility.handshakeView * 100);
                document.getElementById('memory-visibility').style.width = visibilityPercent + '%';
            }
            
            // Update interaction panel
            if (capsuleData.capsuleLayers && capsuleData.capsuleLayers.interaction) {
                const interaction = capsuleData.capsuleLayers.interaction;
                document.getElementById('interaction-active').textContent = interaction.data.currentInteractions?.length || 0;
                document.getElementById('interaction-trusted').textContent = interaction.data.trustedDevices?.size || 0;
                document.getElementById('interaction-style').textContent = interaction.data.communicationPreferences?.style || 'Unknown';
                
                const visibilityPercent = (interaction.meshVisibility.handshakeView * 100);
                document.getElementById('interaction-visibility').style.width = visibilityPercent + '%';
                
                // Update connections list
                updateConnectionsList(interaction);
            }
            
            // Update projection panel
            if (capsuleData.capsuleLayers && capsuleData.capsuleLayers.projection) {
                const projection = capsuleData.capsuleLayers.projection;
                document.getElementById('projection-vision').textContent = projection.data.longTermVision?.primaryVision?.substring(0, 20) + '...' || 'Forming...';
                document.getElementById('projection-evolution').textContent = Math.floor((projection.core?.evolutionPath?.evolutionMetrics?.complexity || 0.3) * 100) + '%';
                
                const visibilityPercent = (projection.meshVisibility.handshakeView * 100);
                document.getElementById('projection-visibility').style.width = visibilityPercent + '%';
                
                // Update goals progress
                updateGoalsProgress(projection);
            }
            
            // Update floating stats
            updateFloatingStats();
        }
        
        function updateMemorySegments(memory) {
            const segmentsDiv = document.getElementById('memory-segments');
            segmentsDiv.innerHTML = '';
            
            if (memory.core && memory.core.memorySegments) {
                memory.core.memorySegments.slice(0, 12).forEach(segment => {
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'memory-segment';
                    
                    // Color based on segment type and usage
                    const usage = segment.used / segment.capacity;
                    const colors = {
                        experience: \`hsl(280, 70%, \${30 + usage * 50}%)\`,
                        learning: \`hsl(260, 70%, \${30 + usage * 50}%)\`,
                        interaction: \`hsl(240, 70%, \${30 + usage * 50}%)\`,
                        achievement: \`hsl(220, 70%, \${30 + usage * 50}%)\`
                    };
                    
                    segmentDiv.style.background = colors[segment.type] || '#666';
                    segmentDiv.title = \`\${segment.type}: \${Math.floor(usage * 100)}% used\`;
                    
                    segmentsDiv.appendChild(segmentDiv);
                });
            }
        }
        
        function updateConnectionsList(interaction) {
            const connectionsDiv = document.getElementById('connection-list');
            connectionsDiv.innerHTML = '';
            
            if (interaction.data && interaction.data.currentInteractions) {
                interaction.data.currentInteractions.slice(0, 3).forEach(connection => {
                    const connectionDiv = document.createElement('div');
                    connectionDiv.className = 'connection-status';
                    
                    const dot = document.createElement('div');
                    dot.className = 'connection-dot connection-active';
                    
                    const text = document.createElement('span');
                    text.textContent = connection.deviceId?.substring(0, 8) || 'Unknown';
                    
                    connectionDiv.appendChild(dot);
                    connectionDiv.appendChild(text);
                    connectionsDiv.appendChild(connectionDiv);
                });
            }
        }
        
        function updateGoalsProgress(projection) {
            const goalsDiv = document.getElementById('goals-progress');
            goalsDiv.innerHTML = '';
            
            if (projection.core && projection.core.futureGoals) {
                projection.core.futureGoals.slice(0, 3).forEach(goal => {
                    const goalDiv = document.createElement('div');
                    goalDiv.className = 'goal-progress';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'goal-name';
                    nameDiv.textContent = goal.id.replace('_', ' ');
                    
                    const barDiv = document.createElement('div');
                    barDiv.className = 'goal-bar';
                    
                    const fillDiv = document.createElement('div');
                    fillDiv.className = 'goal-fill';
                    fillDiv.style.width = (goal.progress * 100) + '%';
                    
                    barDiv.appendChild(fillDiv);
                    goalDiv.appendChild(nameDiv);
                    goalDiv.appendChild(barDiv);
                    goalsDiv.appendChild(goalDiv);
                });
            }
        }
        
        function updateFloatingStats() {
            // Calculate average visibility
            let totalVisibility = 0;
            let layerCount = 0;
            
            if (capsuleData.capsuleLayers) {
                Object.values(capsuleData.capsuleLayers).forEach(layer => {
                    if (layer.meshVisibility) {
                        totalVisibility += layer.meshVisibility.handshakeView;
                        layerCount++;
                    }
                });
            }
            
            const avgVisibility = layerCount > 0 ? (totalVisibility / layerCount * 100) : 0;
            document.getElementById('average-visibility').textContent = Math.floor(avgVisibility) + '%';
            
            // Update other stats
            document.getElementById('handshake-count').textContent = '0'; // Would come from mesh data
            document.getElementById('sync-status').textContent = 'Active';
            document.getElementById('mesh-efficiency').textContent = Math.floor(avgVisibility * 0.85) + '%';
        }
        
        function updateCapsuleVisualization() {
            // Animate capsules based on data
            Object.keys(capsuleGroups).forEach(capsuleName => {
                const capsuleGroup = capsuleGroups[capsuleName];
                const capsuleLayer = capsuleData.capsuleLayers?.[capsuleName];
                
                if (capsuleLayer) {
                    // Scale based on visibility
                    const visibility = capsuleLayer.meshVisibility?.handshakeView || 0.5;
                    const targetScale = 0.8 + (visibility * 0.4);
                    capsuleGroup.group.scale.lerp(new THREE.Vector3(targetScale, targetScale, targetScale), 0.1);
                    
                    // Update opacity
                    capsuleGroup.sphere.material.opacity = 0.5 + (visibility * 0.3);
                    capsuleGroup.ring.material.opacity = 0.3 + (visibility * 0.2);
                }
            });
            
            // Animate particles
            particleSystems.forEach(particleSystem => {
                const positions = particleSystem.system.geometry.attributes.position.array;
                const basePositions = particleSystem.basePositions;
                
                for (let i = 0; i < positions.length; i += 3) {
                    positions[i] = basePositions[i] + Math.sin(Date.now() * 0.001 + i) * 2;
                    positions[i + 1] = basePositions[i + 1] + Math.cos(Date.now() * 0.001 + i) * 2;
                    positions[i + 2] = basePositions[i + 2] + Math.sin(Date.now() * 0.002 + i) * 1;
                }
                
                particleSystem.system.geometry.attributes.position.needsUpdate = true;
            });
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            // Rotate capsules
            Object.values(capsuleGroups).forEach(capsuleGroup => {
                capsuleGroup.group.rotation.y += 0.005;
                capsuleGroup.ring.rotation.z += 0.01;
            });
            
            // Animate mesh lines
            meshLines.forEach((line, index) => {
                const opacity = 0.2 + Math.sin(Date.now() * 0.002 + index) * 0.1;
                line.material.opacity = Math.max(0.1, opacity);
            });
            
            // Camera orbit
            const time = Date.now() * 0.0005;
            camera.position.x = Math.cos(time) * 50;
            camera.position.z = Math.sin(time) * 50;
            camera.lookAt(0, 0, 0);
            
            renderer.render(scene, camera);
        }
        
        // Control functions
        function toggleIdentityEncryption() {
            console.log('üîê Toggling identity encryption');
        }
        
        function regenerateIdentity() {
            console.log('üîÑ Regenerating identity');
        }
        
        function compactMemory() {
            console.log('üóúÔ∏è Compacting memory');
        }
        
        function shareMemory() {
            console.log('üì§ Sharing memory');
        }
        
        function broadcastPresence() {
            console.log('üì° Broadcasting presence');
        }
        
        function initiateHandshake() {
            console.log('ü§ù Initiating handshake');
        }
        
        function visualizeFuture() {
            console.log('üîÆ Visualizing future');
        }
        
        function alignGoals() {
            console.log('‚ö° Aligning goals');
        }
        
        // Initialize when page loads
        window.addEventListener('load', init);
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        console.log('üîÆ Soulfra Capsule Mesh Visualizer loaded');
        console.log('Features:');
        console.log('  ‚úÖ 4 Capsule layers (Identity, Memory, Interaction, Projection)');
        console.log('  ‚úÖ Real-time 3D visualization');
        console.log('  ‚úÖ Mesh visibility patterns');
        console.log('  ‚úÖ Handshake-based access control');
        console.log('  ‚úÖ Live data integration');
        console.log('  ‚úÖ Interactive layer controls');
    </script>
</body>
</html>