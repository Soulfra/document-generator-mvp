# Railway Deployment Guide

## Why Railway?

Railway is perfect for FinishThisIdea because:
- **One-click deploy** - Get running in 3 minutes
- **Automatic scaling** - Handles growth seamlessly
- **Built-in databases** - PostgreSQL and Redis included
- **Fair pricing** - Pay only for what you use
- **Great developer experience** - Simple and powerful

## Quick Deploy (3 minutes)

### Option 1: Deploy Button (Easiest)

[![Deploy on Railway](https://railway.app/button.svg)](https://railway.app/new/template?template=https://github.com/finishthisidea/finishthisidea&plugins=postgresql,redis&envs=STRIPE_SECRET_KEY,STRIPE_WEBHOOK_SECRET,OLLAMA_URL&optionalEnvs=OPENAI_API_KEY,ANTHROPIC_API_KEY)

This button will:
1. Fork the repository
2. Create all services
3. Set up databases
4. Configure environment
5. Deploy automatically

### Option 2: CLI Deploy

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login to Railway
railway login

# Initialize project
railway init

# Link to GitHub repo
railway link

# Deploy
railway up
```

## Manual Setup (10 minutes)

### Step 1: Create Railway Account
1. Go to [railway.app](https://railway.app)
2. Sign up with GitHub
3. Verify email

### Step 2: Create New Project
```
Railway Dashboard â†’ New Project â†’ Deploy from GitHub repo
```

Select: `finishthisidea/finishthisidea`

### Step 3: Add Services

Click "New" and add these services:

#### PostgreSQL Database
```
New â†’ Database â†’ PostgreSQL
Name: finishthisidea-db
```

#### Redis Cache
```
New â†’ Database â†’ Redis  
Name: finishthisidea-cache
```

#### Frontend Service
```
New â†’ GitHub Repo â†’ finishthisidea
Service name: frontend
Start command: npm run start:frontend
Build command: npm run build:frontend
Port: 3000
```

#### Backend API Service
```
New â†’ GitHub Repo â†’ finishthisidea
Service name: backend
Start command: npm run start:backend  
Build command: npm run build:backend
Port: 3001
```

#### Worker Service
```
New â†’ GitHub Repo â†’ finishthisidea
Service name: worker
Start command: npm run start:worker
Build command: npm run build:backend
```

### Step 4: Configure Environment

#### Shared Variables (Project Settings)
```bash
# Generated by Railway
DATABASE_URL=${{Postgres.DATABASE_URL}}
REDIS_URL=${{Redis.REDIS_URL}}

# Your values
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Optional AI providers
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
```

#### Frontend Variables
```bash
NEXT_PUBLIC_API_URL=https://${{backend.RAILWAY_PUBLIC_DOMAIN}}
NEXT_PUBLIC_WS_URL=wss://${{backend.RAILWAY_PUBLIC_DOMAIN}}
NEXT_PUBLIC_STRIPE_PUBLIC_KEY=pk_test_...
```

#### Backend Variables
```bash
NODE_ENV=production
PORT=3001
FRONTEND_URL=https://${{frontend.RAILWAY_PUBLIC_DOMAIN}}

# Storage (use Railway volumes or S3)
S3_ENDPOINT=https://s3.amazonaws.com
S3_BUCKET=finishthisidea-prod
S3_ACCESS_KEY=...
S3_SECRET_KEY=...
```

### Step 5: Configure Domains

#### Custom Domain (Recommended)
```
Service Settings â†’ Domains â†’ Add Custom Domain
Frontend: finishthisidea.com
Backend: api.finishthisidea.com
```

#### Railway Domains (Free)
Railway provides domains like:
- Frontend: `finishthisidea-frontend.up.railway.app`
- Backend: `finishthisidea-backend.up.railway.app`

### Step 6: Set Up Webhooks

1. Get your backend URL
2. Go to Stripe Dashboard
3. Add webhook endpoint: `https://api.finishthisidea.com/api/stripe/webhook`
4. Copy webhook secret
5. Add to Railway environment

## Ollama on Railway

### Option 1: External Ollama Service
Use a dedicated Ollama service provider:
```bash
OLLAMA_URL=https://ollama-api.yourprovider.com
```

### Option 2: Self-Hosted Ollama
Add Ollama as a service:

```dockerfile
# Dockerfile.ollama
FROM ollama/ollama:latest

# Pre-download models
RUN ollama pull codellama
RUN ollama pull mistral

EXPOSE 11434
CMD ["serve"]
```

```bash
# Railway service
OLLAMA_URL=http://ollama.railway.internal:11434
```

## Production Configuration

### Database Migrations
```yaml
# railway.yaml
deploy:
  startCommand: npm run start
  buildCommand: npm run build
  releaseCommand: npm run db:migrate:prod
```

### Health Checks
```yaml
# railway.yaml
healthcheck:
  path: /health
  port: 3001
  interval: 30
  timeout: 5
  retries: 3
```

### Scaling Configuration
```yaml
# railway.yaml
services:
  - name: backend
    minInstances: 2
    maxInstances: 10
    targetCPU: 70
    targetMemory: 80
    
  - name: worker
    minInstances: 1
    maxInstances: 5
    targetQueueDepth: 100
```

## Monitoring Setup

### Railway Metrics
Built-in monitoring includes:
- CPU usage
- Memory usage
- Network I/O
- Request count
- Error rate

### Custom Monitoring
Add to your backend:
```javascript
// Sentry
import * as Sentry from "@sentry/node";
Sentry.init({ dsn: process.env.SENTRY_DSN });

// Custom metrics
import { metrics } from './utils/metrics';
metrics.increment('job.processed');
```

## Deployment Process

### Automatic Deploys
```
GitHub main branch â†’ Railway auto-deploys â†’ Live in ~3 minutes
```

### Manual Deploy
```bash
# Deploy specific commit
railway up --commit abc123

# Deploy with environment
railway up --environment production

# Rollback
railway rollback
```

### Zero-Downtime Deploy
Railway automatically:
1. Builds new version
2. Runs health checks
3. Gradually shifts traffic
4. Removes old version

## Cost Optimization

### Estimated Costs
```
Hobby Plan ($5/month):
- 8GB RAM
- 8 vCPUs
- $0.10/GB bandwidth

Typical usage:
- Frontend: $5-10/month
- Backend: $10-20/month
- Worker: $10-20/month
- Database: $5-10/month
- Redis: $5/month
Total: ~$35-65/month
```

### Cost Saving Tips
1. **Use Ollama** - Reduces AI costs by 90%
2. **Enable auto-sleep** - Scale to zero when idle
3. **Optimize images** - Smaller Docker images
4. **Cache aggressively** - Reduce computation
5. **Use Railway volumes** - Cheaper than S3

## Troubleshooting

### Build Failures
```bash
# Check build logs
railway logs --service backend --build

# Common fixes
- Ensure package-lock.json is committed
- Check Node version in package.json
- Verify all dependencies listed
```

### Database Connection
```bash
# Test connection
railway run node -e "console.log(process.env.DATABASE_URL)"

# Run migrations manually
railway run npm run db:migrate
```

### Environment Variables
```bash
# List all variables
railway variables

# Set variable
railway variables set KEY=value

# Remove variable  
railway variables remove KEY
```

### Domain Issues
- Ensure CNAME points to Railway
- Wait for SSL certificate (automatic)
- Check CORS settings for API

## Backup & Recovery

### Database Backups
```bash
# Manual backup
railway run pg_dump $DATABASE_URL > backup.sql

# Scheduled backups (add to worker)
0 0 * * * railway run npm run backup:db
```

### Disaster Recovery
1. Database: Point-in-time recovery available
2. Code: Git history preserved
3. Configs: Stored in Railway
4. Files: S3 provides durability

## Security Checklist

- [x] HTTPS enforced on all services
- [x] Environment variables encrypted
- [x] Database SSL enabled
- [x] Private networking between services
- [x] DDoS protection included
- [x] Automatic security updates

## Going Live Checklist

### Before Launch
- [ ] All environment variables set
- [ ] Stripe webhook configured
- [ ] Custom domains added
- [ ] SSL certificates active
- [ ] Database migrations run
- [ ] Health checks passing

### Launch Day
- [ ] Deploy to production
- [ ] Test critical flows
- [ ] Monitor metrics
- [ ] Check error rates
- [ ] Verify payments work
- [ ] Announce launch! ðŸš€

## Support

### Railway Support
- [Discord](https://discord.gg/railway)
- [Documentation](https://docs.railway.app)
- [Status Page](https://status.railway.app)

### FinishThisIdea Support
- Email: support@finishthisidea.com
- Discord: [Join us](https://discord.gg/finishthisidea)
- GitHub: [Issues](https://github.com/finishthisidea/issues)

---

Ready to deploy? Click the deploy button at the top or follow the manual steps. Your app will be live in minutes! ðŸŽ‰