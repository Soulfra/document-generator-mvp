<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåÄüî•üíä SoulFRA Sprite Studio - Where Reality is Optional‚Ñ¢</title>
    <link rel="stylesheet" href="FinishThisIdea/soulfra-brand.css">
    <style>
        /* Additional Sprite Studio specific styles */
        .sprite-studio-container {
            min-height: 100vh;
            background: var(--soulfra-bg-primary);
            position: relative;
            overflow-x: auto;
        }

        /* Quantum particle background */
        .quantum-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        /* Main studio layout */
        .studio-layout {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .studio-header {
            grid-column: 1 / -1;
            padding: var(--space-lg);
            background: var(--soulfra-glass-dark);
            border-bottom: 1px solid rgba(139, 0, 255, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .studio-logo {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo-symbol {
            font-size: 2rem;
            background: var(--soulfra-lsd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-shift 3s infinite;
        }

        .logo-text {
            font-family: var(--font-display);
            font-size: var(--text-heading-lg);
            color: var(--soulfra-quantum);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 0 0 20px var(--soulfra-quantum-glow);
        }

        .logo-tagline {
            font-family: var(--font-mono);
            font-size: var(--text-caption);
            color: var(--soulfra-reality);
            margin-left: var(--space-sm);
        }

        .header-actions {
            display: flex;
            gap: var(--space-md);
            align-items: center;
        }

        .quantum-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-md);
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--soulfra-reality);
            border-radius: var(--radius-pill);
            font-size: var(--text-caption);
            color: var(--soulfra-reality);
        }

        /* Left sidebar - Tools */
        .tools-sidebar {
            background: var(--soulfra-glass);
            border-right: 1px solid rgba(139, 0, 255, 0.2);
            padding: var(--space-lg);
            overflow-y: auto;
        }

        .tools-section {
            margin-bottom: var(--space-xl);
        }

        .tools-section h3 {
            font-family: var(--font-display);
            font-size: var(--text-heading-sm);
            color: var(--soulfra-quantum);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }

        .tool-btn {
            background: var(--soulfra-bg-secondary);
            border: 1px solid var(--soulfra-quantum);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-quantum);
            text-align: center;
            color: var(--soulfra-text-primary);
        }

        .tool-btn:hover {
            background: rgba(139, 0, 255, 0.1);
            box-shadow: 0 0 20px var(--soulfra-quantum-glow);
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background: var(--soulfra-quantum);
            color: white;
            box-shadow: 0 0 30px var(--soulfra-quantum-glow);
        }

        .tool-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: var(--space-xs);
        }

        .tool-name {
            font-size: var(--text-caption);
            font-family: var(--font-mono);
            text-transform: uppercase;
        }

        /* Center canvas area */
        .canvas-area {
            display: flex;
            flex-direction: column;
            background: var(--soulfra-bg-secondary);
            border: 1px solid rgba(139, 0, 255, 0.2);
            margin: var(--space-lg);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .canvas-header {
            background: var(--soulfra-glass-dark);
            padding: var(--space-md);
            border-bottom: 1px solid rgba(139, 0, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-title {
            font-family: var(--font-display);
            color: var(--soulfra-reality);
            font-size: var(--text-heading-sm);
        }

        .canvas-controls {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--soulfra-text-secondary);
            font-family: var(--font-mono);
            font-size: var(--text-caption);
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            position: relative;
        }

        #spriteCanvas {
            border: 2px solid var(--soulfra-quantum);
            border-radius: var(--radius-md);
            cursor: crosshair;
            box-shadow: 
                0 0 40px var(--soulfra-quantum-glow),
                inset 0 0 20px rgba(139, 0, 255, 0.1);
            transition: all var(--transition-base);
        }

        #spriteCanvas:hover {
            box-shadow: 
                0 0 60px var(--soulfra-quantum-glow),
                inset 0 0 30px rgba(139, 0, 255, 0.2);
        }

        /* Right sidebar - Properties */
        .properties-sidebar {
            background: var(--soulfra-glass);
            border-left: 1px solid rgba(139, 0, 255, 0.2);
            padding: var(--space-lg);
            overflow-y: auto;
        }

        .property-section {
            margin-bottom: var(--space-xl);
        }

        .property-section h3 {
            font-family: var(--font-display);
            font-size: var(--text-heading-sm);
            color: var(--soulfra-wormhole);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-xs);
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--transition-base);
            position: relative;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .color-swatch.active {
            border-color: var(--soulfra-reality);
            box-shadow: 0 0 20px var(--soulfra-reality-glow);
        }

        /* Game Boy Palette */
        .gameboy-palette {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
        }

        .gameboy-color {
            width: 60px;
            height: 30px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-size: var(--text-caption);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Animation controls */
        .animation-controls {
            background: var(--soulfra-bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            border: 1px solid rgba(139, 0, 255, 0.2);
        }

        .frame-strip {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
            overflow-x: auto;
            padding: var(--space-sm);
            background: var(--soulfra-bg-primary);
            border-radius: var(--radius-sm);
        }

        .frame-thumbnail {
            width: 40px;
            height: 40px;
            background: var(--soulfra-bg-secondary);
            border: 2px solid var(--soulfra-quantum);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-base);
            flex-shrink: 0;
        }

        .frame-thumbnail.active {
            border-color: var(--soulfra-reality);
            box-shadow: 0 0 15px var(--soulfra-reality-glow);
        }

        .frame-thumbnail:hover {
            transform: scale(1.1);
        }

        /* Export section */
        .export-section {
            background: var(--soulfra-bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .export-buttons {
            display: grid;
            gap: var(--space-sm);
        }

        .export-btn {
            background: linear-gradient(45deg, var(--soulfra-reality), var(--soulfra-reality-dark));
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-pill);
            font-family: var(--font-mono);
            font-size: var(--text-caption);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all var(--transition-quantum);
            position: relative;
            overflow: hidden;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--soulfra-reality-pulse);
        }

        .export-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .export-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .share-buttons {
            display: grid;
            gap: var(--space-xs);
            margin-top: var(--space-md);
        }

        .share-btn {
            background: var(--soulfra-bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--soulfra-text-primary);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: var(--text-caption);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .share-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        /* Status bar */
        .status-bar {
            grid-column: 1 / -1;
            background: var(--soulfra-bg-tertiary);
            border-top: 1px solid rgba(139, 0, 255, 0.2);
            padding: var(--space-sm) var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-mono);
            font-size: var(--text-caption);
            color: var(--soulfra-text-secondary);
        }

        .status-left, .status-right {
            display: flex;
            gap: var(--space-lg);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .reality-indicator {
            width: 8px;
            height: 8px;
            background: var(--soulfra-reality);
            border-radius: 50%;
            animation: reality-pulse 2s infinite;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .studio-layout {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        @media (max-width: 768px) {
            .studio-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
            
            .tools-sidebar, .properties-sidebar {
                order: 2;
                max-height: 200px;
            }
            
            .canvas-area {
                order: 1;
                margin: var(--space-md);
            }
            
            .status-bar {
                order: 3;
            }
        }

        /* Custom scrollbars */
        .tools-sidebar::-webkit-scrollbar,
        .properties-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .tools-sidebar::-webkit-scrollbar-track,
        .properties-sidebar::-webkit-scrollbar-track {
            background: var(--soulfra-bg-primary);
        }

        .tools-sidebar::-webkit-scrollbar-thumb,
        .properties-sidebar::-webkit-scrollbar-thumb {
            background: var(--soulfra-quantum);
            border-radius: var(--radius-sm);
        }

        .tools-sidebar::-webkit-scrollbar-thumb:hover,
        .properties-sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--soulfra-quantum-light);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
            color: var(--soulfra-text-primary);
        }

        .loading-text {
            font-family: var(--font-display);
            font-size: var(--text-heading-md);
            margin-bottom: var(--space-md);
            color: var(--soulfra-quantum);
        }
    </style>
</head>
<body class="sprite-studio-container">
    <!-- Quantum particle background -->
    <div class="quantum-background" id="quantumBackground"></div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="soulfra-loader"></div>
            <div class="loading-text" id="loadingText">Initializing Reality...</div>
        </div>
    </div>

    <div class="studio-layout">
        <!-- Header -->
        <header class="studio-header">
            <div class="header-content">
                <div class="studio-logo">
                    <span class="logo-symbol">‚óâ‚óØ‚óâ</span>
                    <div>
                        <div class="logo-text">SoulFRA</div>
                        <div class="logo-tagline">Sprite Studio</div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="quantum-status">
                        <div class="reality-indicator"></div>
                        <span>Reality: Optional</span>
                    </div>
                    <button class="btn-quantum" onclick="saveProject()">üíæ Save</button>
                    <button class="btn-pill purple" onclick="toggleSettings()">‚öôÔ∏è</button>
                </div>
            </div>
        </header>

        <!-- Left Sidebar - Tools -->
        <aside class="tools-sidebar">
            <div class="tools-section">
                <h3>üé® Drawing Tools</h3>
                <div class="tool-grid">
                    <div class="tool-btn active" data-tool="brush" onclick="selectTool('brush')">
                        <span class="tool-icon">üñåÔ∏è</span>
                        <div class="tool-name">Brush</div>
                    </div>
                    <div class="tool-btn" data-tool="pencil" onclick="selectTool('pencil')">
                        <span class="tool-icon">‚úèÔ∏è</span>
                        <div class="tool-name">Pencil</div>
                    </div>
                    <div class="tool-btn" data-tool="eraser" onclick="selectTool('eraser')">
                        <span class="tool-icon">üßΩ</span>
                        <div class="tool-name">Eraser</div>
                    </div>
                    <div class="tool-btn" data-tool="fill" onclick="selectTool('fill')">
                        <span class="tool-icon">ü™£</span>
                        <div class="tool-name">Fill</div>
                    </div>
                </div>
            </div>

            <div class="tools-section">
                <h3>üìê Shapes</h3>
                <div class="tool-grid">
                    <div class="tool-btn" data-tool="line" onclick="selectTool('line')">
                        <span class="tool-icon">üìè</span>
                        <div class="tool-name">Line</div>
                    </div>
                    <div class="tool-btn" data-tool="rectangle" onclick="selectTool('rectangle')">
                        <span class="tool-icon">‚¨ú</span>
                        <div class="tool-name">Rect</div>
                    </div>
                    <div class="tool-btn" data-tool="circle" onclick="selectTool('circle')">
                        <span class="tool-icon">‚≠ï</span>
                        <div class="tool-name">Circle</div>
                    </div>
                    <div class="tool-btn" data-tool="select" onclick="selectTool('select')">
                        <span class="tool-icon">‚ö°</span>
                        <div class="tool-name">Select</div>
                    </div>
                </div>
            </div>

            <div class="tools-section">
                <h3>üéÆ Game Boy Mode</h3>
                <div class="gameboy-palette">
                    <div class="gameboy-color" style="background: #0F380F;" onclick="selectGameBoyColor('#0F380F')">DMG 0</div>
                    <div class="gameboy-color" style="background: #306230;" onclick="selectGameBoyColor('#306230')">DMG 1</div>
                    <div class="gameboy-color" style="background: #8BAC0F;" onclick="selectGameBoyColor('#8BAC0F')">DMG 2</div>
                    <div class="gameboy-color" style="background: #9BBD0F;" onclick="selectGameBoyColor('#9BBD0F')">DMG 3</div>
                </div>
                <button class="btn-pill blue" onclick="convertToGameBoy()">üéÆ Convert to GB</button>
            </div>
        </aside>

        <!-- Center Canvas Area -->
        <main class="canvas-area">
            <div class="canvas-header">
                <h2 class="canvas-title">Quantum Canvas</h2>
                <div class="canvas-controls">
                    <div class="zoom-control">
                        <button onclick="zoomOut()">-</button>
                        <span id="zoomLevel">400%</span>
                        <button onclick="zoomIn()">+</button>
                    </div>
                    <button class="btn-quantum" onclick="clearCanvas()">üóëÔ∏è Clear</button>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="spriteCanvas" width="320" height="320"></canvas>
            </div>
        </main>

        <!-- Right Sidebar - Properties -->
        <aside class="properties-sidebar">
            <div class="property-section">
                <h3>üåà Color Palette</h3>
                <div class="color-palette" id="colorPalette">
                    <!-- SoulFRA brand colors -->
                    <div class="color-swatch active" style="background: #8B00FF;" data-color="#8B00FF" onclick="selectColor('#8B00FF')"></div>
                    <div class="color-swatch" style="background: #00FF88;" data-color="#00FF88" onclick="selectColor('#00FF88')"></div>
                    <div class="color-swatch" style="background: #00CCFF;" data-color="#00CCFF" onclick="selectColor('#00CCFF')"></div>
                    <div class="color-swatch" style="background: #FF0044;" data-color="#FF0044" onclick="selectColor('#FF0044')"></div>
                    <div class="color-swatch" style="background: #FF69B4;" data-color="#FF69B4" onclick="selectColor('#FF69B4')"></div>
                    <div class="color-swatch" style="background: #FFFFFF;" data-color="#FFFFFF" onclick="selectColor('#FFFFFF')"></div>
                    <div class="color-swatch" style="background: #000000;" data-color="#000000" onclick="selectColor('#000000')"></div>
                    <div class="color-swatch" style="background: #666666;" data-color="#666666" onclick="selectColor('#666666')"></div>
                </div>
                <input type="color" class="soulfra-input" id="customColor" onchange="selectColor(this.value)" style="margin-top: 10px;">
            </div>

            <div class="property-section">
                <h3>üé¨ Animation</h3>
                <div class="animation-controls">
                    <div class="frame-strip" id="frameStrip">
                        <div class="frame-thumbnail active" onclick="selectFrame(0)"></div>
                        <div class="frame-thumbnail" onclick="addFrame()">+</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="btn-pill quantum" onclick="playAnimation()">‚ñ∂Ô∏è Play</button>
                        <button class="btn-pill quantum" onclick="stopAnimation()">‚èπÔ∏è Stop</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="color: var(--soulfra-text-secondary); font-size: 12px;">FPS:</label>
                        <input type="range" min="1" max="30" value="8" id="fpsSlider" onchange="updateFPS(this.value)" style="width: 100%;">
                        <span id="fpsDisplay" style="color: var(--soulfra-reality); font-family: var(--font-mono);">8 FPS</span>
                    </div>
                </div>
            </div>

            <div class="property-section">
                <h3>üì§ Export</h3>
                <div class="export-section">
                    <div class="export-buttons">
                        <button class="export-btn" onclick="exportAsGIF()">
                            üéûÔ∏è Export GIF
                        </button>
                        <button class="export-btn" onclick="exportAsPNG()">
                            üñºÔ∏è Export PNG
                        </button>
                        <button class="export-btn" onclick="exportGameBoyROM()">
                            üéÆ Game Boy ROM
                        </button>
                    </div>
                    
                    <div class="share-buttons">
                        <button class="share-btn" onclick="shareToImgur()">
                            <span>üì∏</span> Upload to Imgur
                        </button>
                        <button class="share-btn" onclick="shareToDiscord()">
                            <span>üí¨</span> Share on Discord
                        </button>
                        <button class="share-btn" onclick="shareToGiphy()">
                            <span>üé≠</span> Upload to Giphy
                        </button>
                    </div>
                </div>
            </div>

            <div class="property-section">
                <h3>‚öôÔ∏è Settings</h3>
                <div style="display: grid; gap: 10px;">
                    <label class="checkbox-group">
                        <input type="checkbox" class="soulfra-checkbox" id="gridToggle" checked onchange="toggleGrid()">
                        <span>Show Grid</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" class="soulfra-checkbox" id="onionSkin" onchange="toggleOnionSkin()">
                        <span>Onion Skinning</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" class="soulfra-checkbox" id="realTimeShare" onchange="toggleRealTimeShare()">
                        <span>Real-time Sharing</span>
                    </label>
                </div>
            </div>
        </aside>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <span>Canvas:</span>
                    <span id="canvasSize">32√ó32</span>
                </div>
                <div class="status-item">
                    <span>Tool:</span>
                    <span id="currentTool">Brush</span>
                </div>
                <div class="status-item">
                    <span>Color:</span>
                    <span id="currentColor">#8B00FF</span>
                </div>
            </div>
            <div class="status-right">
                <div class="status-item">
                    <span>Frame:</span>
                    <span id="currentFrame">1/1</span>
                </div>
                <div class="status-item">
                    <span>Reality Level:</span>
                    <span style="color: var(--soulfra-reality);">Optional</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Include GIF.js for GIF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.min.js"></script>
    
    <script>
        // SoulFRA Sprite Studio - Main Application
        class SoulFRASpritStudio {
            constructor() {
                this.canvas = document.getElementById('spriteCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.currentTool = 'brush';
                this.currentColor = '#8B00FF';
                this.isDrawing = false;
                this.zoom = 10; // 32x32 sprite at 320x320 canvas = 10x zoom
                this.frames = [this.createEmptyFrame()];
                this.currentFrame = 0;
                this.animationInterval = null;
                this.fps = 8;
                this.showGrid = true;
                
                this.init();
            }

            init() {
                this.setupCanvas();
                this.setupEventListeners();
                this.createQuantumParticles();
                this.drawGrid();
                
                // Hide loading after initialization
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.remove('active');
                }, 1000);
            }

            createEmptyFrame() {
                const frame = this.ctx.createImageData(32, 32);
                // Fill with transparent pixels
                for (let i = 0; i < frame.data.length; i += 4) {
                    frame.data[i] = 0;     // R
                    frame.data[i + 1] = 0; // G
                    frame.data[i + 2] = 0; // B
                    frame.data[i + 3] = 0; // A (transparent)
                }
                return frame;
            }

            setupCanvas() {
                this.ctx.imageSmoothingEnabled = false;
                this.canvas.style.imageRendering = 'pixelated';
                
                // Set canvas to crisp pixel rendering
                this.ctx.webkitImageSmoothingEnabled = false;
                this.ctx.mozImageSmoothingEnabled = false;
                this.ctx.msImageSmoothingEnabled = false;
            }

            setupEventListeners() {
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseleave', () => this.stopDrawing());
                
                // Touch events for mobile
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousedown', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousemove', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                });
                
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const mouseEvent = new MouseEvent('mouseup', {});
                    this.canvas.dispatchEvent(mouseEvent);
                });
            }

            getPixelPosition(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) / this.zoom);
                const y = Math.floor((e.clientY - rect.top) / this.zoom);
                return { x: Math.max(0, Math.min(31, x)), y: Math.max(0, Math.min(31, y)) };
            }

            startDrawing(e) {
                this.isDrawing = true;
                this.draw(e);
            }

            draw(e) {
                if (!this.isDrawing) return;
                
                const pos = this.getPixelPosition(e);
                
                switch (this.currentTool) {
                    case 'brush':
                    case 'pencil':
                        this.drawPixel(pos.x, pos.y, this.currentColor);
                        break;
                    case 'eraser':
                        this.erasePixel(pos.x, pos.y);
                        break;
                    case 'fill':
                        this.floodFill(pos.x, pos.y, this.currentColor);
                        break;
                }
                
                this.updateFrameThumbnail();
            }

            stopDrawing() {
                this.isDrawing = false;
            }

            drawPixel(x, y, color) {
                // Convert hex color to RGB
                const rgb = this.hexToRgb(color);
                
                // Update frame data
                const frame = this.frames[this.currentFrame];
                const index = (y * 32 + x) * 4;
                frame.data[index] = rgb.r;
                frame.data[index + 1] = rgb.g;
                frame.data[index + 2] = rgb.b;
                frame.data[index + 3] = 255; // Full alpha
                
                // Draw to canvas
                this.ctx.fillStyle = color;
                this.ctx.fillRect(x * this.zoom, y * this.zoom, this.zoom, this.zoom);
                
                if (this.showGrid) {
                    this.drawGrid();
                }
            }

            erasePixel(x, y) {
                // Update frame data
                const frame = this.frames[this.currentFrame];
                const index = (y * 32 + x) * 4;
                frame.data[index + 3] = 0; // Set alpha to 0
                
                // Clear canvas pixel
                this.ctx.clearRect(x * this.zoom, y * this.zoom, this.zoom, this.zoom);
                
                if (this.showGrid) {
                    this.drawGrid();
                }
            }

            floodFill(startX, startY, fillColor) {
                const frame = this.frames[this.currentFrame];
                const startIndex = (startY * 32 + startX) * 4;
                const startR = frame.data[startIndex];
                const startG = frame.data[startIndex + 1];
                const startB = frame.data[startIndex + 2];
                const startA = frame.data[startIndex + 3];
                
                const fillRgb = this.hexToRgb(fillColor);
                
                if (startR === fillRgb.r && startG === fillRgb.g && startB === fillRgb.b) {
                    return; // Same color, nothing to fill
                }
                
                const stack = [[startX, startY]];
                
                while (stack.length > 0) {
                    const [x, y] = stack.pop();
                    
                    if (x < 0 || x >= 32 || y < 0 || y >= 32) continue;
                    
                    const index = (y * 32 + x) * 4;
                    
                    if (frame.data[index] === startR && 
                        frame.data[index + 1] === startG && 
                        frame.data[index + 2] === startB &&
                        frame.data[index + 3] === startA) {
                        
                        frame.data[index] = fillRgb.r;
                        frame.data[index + 1] = fillRgb.g;
                        frame.data[index + 2] = fillRgb.b;
                        frame.data[index + 3] = 255;
                        
                        stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
                    }
                }
                
                this.redrawCanvas();
            }

            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            drawGrid() {
                if (!this.showGrid) return;
                
                this.ctx.strokeStyle = 'rgba(139, 0, 255, 0.3)';
                this.ctx.lineWidth = 1;
                
                for (let x = 0; x <= 32; x++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x * this.zoom, 0);
                    this.ctx.lineTo(x * this.zoom, 32 * this.zoom);
                    this.ctx.stroke();
                }
                
                for (let y = 0; y <= 32; y++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y * this.zoom);
                    this.ctx.lineTo(32 * this.zoom, y * this.zoom);
                    this.ctx.stroke();
                }
            }

            redrawCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const frame = this.frames[this.currentFrame];
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');
                ctx.putImageData(frame, 0, 0);
                
                this.ctx.imageSmoothingEnabled = false;
                this.ctx.drawImage(canvas, 0, 0, 32, 32, 0, 0, 320, 320);
                
                if (this.showGrid) {
                    this.drawGrid();
                }
            }

            updateFrameThumbnail() {
                const thumbnail = document.querySelectorAll('.frame-thumbnail')[this.currentFrame];
                if (thumbnail) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 32;
                    canvas.height = 32;
                    const ctx = canvas.getContext('2d');
                    ctx.putImageData(this.frames[this.currentFrame], 0, 0);
                    thumbnail.style.backgroundImage = `url(${canvas.toDataURL()})`;
                    thumbnail.style.backgroundSize = 'contain';
                }
            }

            createQuantumParticles() {
                const container = document.getElementById('quantumBackground');
                const particleCount = 50;
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'quantum-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 10 + 's';
                    particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                    container.appendChild(particle);
                }
            }

            // Export functions
            async exportAsGIF() {
                if (this.frames.length === 1) {
                    this.showNotification('‚ö†Ô∏è Add more frames for GIF animation', 'warning');
                    return;
                }

                this.showLoading('Generating GIF...');
                
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: 32,
                    height: 32,
                    workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
                });

                this.frames.forEach(frame => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 32;
                    canvas.height = 32;
                    const ctx = canvas.getContext('2d');
                    ctx.putImageData(frame, 0, 0);
                    gif.addFrame(canvas, { delay: 1000 / this.fps });
                });

                gif.on('finished', (blob) => {
                    this.hideLoading();
                    this.downloadBlob(blob, 'soulfra-sprite.gif');
                    this.showNotification('üéûÔ∏è GIF exported successfully!', 'success');
                });

                gif.render();
            }

            exportAsPNG() {
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');
                ctx.putImageData(this.frames[this.currentFrame], 0, 0);
                
                canvas.toBlob((blob) => {
                    this.downloadBlob(blob, 'soulfra-sprite.png');
                    this.showNotification('üñºÔ∏è PNG exported successfully!', 'success');
                });
            }

            downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showLoading(text) {
                document.getElementById('loadingText').textContent = text;
                document.getElementById('loadingOverlay').classList.add('active');
            }

            hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('active');
            }

            showNotification(message, type = 'info') {
                // Create notification system
                const notification = document.createElement('div');
                notification.className = `soulfra-notification ${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--soulfra-glass-dark);
                    border: 1px solid var(--soulfra-${type === 'success' ? 'reality' : type === 'warning' ? 'doctor' : 'wormhole'});
                    border-radius: var(--radius-md);
                    padding: var(--space-md);
                    color: var(--soulfra-text-primary);
                    font-family: var(--font-mono);
                    z-index: 1001;
                    animation: slideInFade 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutFade 0.3s ease';
                    setTimeout(() => document.body.removeChild(notification), 300);
                }, 3000);
            }
        }

        // Global functions for UI interactions
        let spriteStudio;

        window.addEventListener('DOMContentLoaded', () => {
            spriteStudio = new SoulFRASpritStudio();
        });

        function selectTool(tool) {
            spriteStudio.currentTool = tool;
            document.getElementById('currentTool').textContent = tool.charAt(0).toUpperCase() + tool.slice(1);
            
            // Update UI
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
        }

        function selectColor(color) {
            spriteStudio.currentColor = color;
            document.getElementById('currentColor').textContent = color;
            
            // Update UI
            document.querySelectorAll('.color-swatch').forEach(swatch => swatch.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`)?.classList.add('active');
        }

        function selectGameBoyColor(color) {
            selectColor(color);
        }

        function convertToGameBoy() {
            // Convert current frame to Game Boy palette
            spriteStudio.showNotification('üéÆ Converting to Game Boy palette...', 'info');
            // Implementation would map colors to nearest Game Boy colors
        }

        function clearCanvas() {
            spriteStudio.ctx.clearRect(0, 0, spriteStudio.canvas.width, spriteStudio.canvas.height);
            spriteStudio.frames[spriteStudio.currentFrame] = spriteStudio.createEmptyFrame();
            spriteStudio.drawGrid();
            spriteStudio.updateFrameThumbnail();
        }

        function zoomIn() {
            // Zoom functionality
            spriteStudio.showNotification('üîç Zoom in', 'info');
        }

        function zoomOut() {
            // Zoom functionality  
            spriteStudio.showNotification('üîç Zoom out', 'info');
        }

        function addFrame() {
            spriteStudio.frames.push(spriteStudio.createEmptyFrame());
            const frameStrip = document.getElementById('frameStrip');
            const newThumbnail = document.createElement('div');
            newThumbnail.className = 'frame-thumbnail';
            newThumbnail.onclick = () => selectFrame(spriteStudio.frames.length - 1);
            frameStrip.insertBefore(newThumbnail, frameStrip.lastElementChild);
            selectFrame(spriteStudio.frames.length - 1);
        }

        function selectFrame(index) {
            spriteStudio.currentFrame = index;
            spriteStudio.redrawCanvas();
            
            // Update UI
            document.querySelectorAll('.frame-thumbnail').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
            
            document.getElementById('currentFrame').textContent = `${index + 1}/${spriteStudio.frames.length}`;
        }

        function playAnimation() {
            if (spriteStudio.animationInterval) return;
            
            let frameIndex = 0;
            spriteStudio.animationInterval = setInterval(() => {
                selectFrame(frameIndex);
                frameIndex = (frameIndex + 1) % spriteStudio.frames.length;
            }, 1000 / spriteStudio.fps);
        }

        function stopAnimation() {
            if (spriteStudio.animationInterval) {
                clearInterval(spriteStudio.animationInterval);
                spriteStudio.animationInterval = null;
            }
        }

        function updateFPS(fps) {
            spriteStudio.fps = parseInt(fps);
            document.getElementById('fpsDisplay').textContent = `${fps} FPS`;
            
            if (spriteStudio.animationInterval) {
                stopAnimation();
                playAnimation();
            }
        }

        function toggleGrid() {
            spriteStudio.showGrid = document.getElementById('gridToggle').checked;
            spriteStudio.redrawCanvas();
        }

        function toggleOnionSkin() {
            const enabled = document.getElementById('onionSkin').checked;
            spriteStudio.showNotification(`üëª Onion skinning ${enabled ? 'enabled' : 'disabled'}`, 'info');
        }

        function toggleRealTimeShare() {
            const enabled = document.getElementById('realTimeShare').checked;
            spriteStudio.showNotification(`üîó Real-time sharing ${enabled ? 'enabled' : 'disabled'}`, 'info');
        }

        function exportAsGIF() {
            spriteStudio.exportAsGIF();
        }

        function exportAsPNG() {
            spriteStudio.exportAsPNG();
        }

        function exportGameBoyROM() {
            spriteStudio.showNotification('üéÆ Game Boy ROM export coming soon!', 'info');
        }

        function shareToImgur() {
            spriteStudio.showNotification('üì∏ Imgur integration coming soon!', 'info');
        }

        function shareToDiscord() {
            spriteStudio.showNotification('üí¨ Discord integration coming soon!', 'info');
        }

        function shareToGiphy() {
            spriteStudio.showNotification('üé≠ Giphy integration coming soon!', 'info');
        }

        function saveProject() {
            spriteStudio.showNotification('üíæ Project saved to SoulFRA Cloud', 'success');
        }

        function toggleSettings() {
            spriteStudio.showNotification('‚öôÔ∏è Settings panel', 'info');
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInFade {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutFade {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>