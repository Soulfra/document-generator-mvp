<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAL Platform - AI-Powered Development Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: #e6edf3;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #30363d;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #238636, #2ea043);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(56, 139, 253, 0.1);
            border: 1px solid rgba(56, 139, 253, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-menu:hover {
            background: rgba(56, 139, 253, 0.2);
        }
        
        .status-dots {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f85149;
            transition: all 0.3s;
        }
        
        .status-dot.active {
            background: #3fb950;
            box-shadow: 0 0 8px rgba(63, 185, 80, 0.4);
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 56px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #30363d;
        }
        
        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .quick-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(48, 54, 61, 0.3);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .quick-action:hover {
            background: rgba(56, 139, 253, 0.1);
            border-color: rgba(56, 139, 253, 0.3);
        }
        
        .action-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        
        .navigation {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 32px;
        }
        
        .nav-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .nav-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .nav-item:hover {
            background: rgba(48, 54, 61, 0.5);
        }
        
        .nav-item.active {
            background: rgba(56, 139, 253, 0.15);
            color: #58a6ff;
            border-left: 3px solid #58a6ff;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Chat Interface */
        .chat-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(13, 17, 23, 0.7);
        }
        
        .messages-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .message {
            display: flex;
            gap: 16px;
            animation: messageSlide 0.4s ease-out;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
        }
        
        .cal-avatar {
            background: linear-gradient(135deg, #238636, #2ea043);
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-header {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .message-author {
            font-weight: 600;
            color: #58a6ff;
        }
        
        .message-time {
            font-size: 12px;
            color: #8b949e;
        }
        
        .message-text {
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .message-actions {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .action-card {
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 200px;
        }
        
        .action-card:hover {
            background: rgba(56, 139, 253, 0.1);
            border-color: #58a6ff;
            transform: translateY(-2px);
        }
        
        .action-title {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-description {
            font-size: 14px;
            color: #8b949e;
        }
        
        /* Progress Indicator */
        .progress-message {
            background: rgba(22, 27, 34, 0.9);
            border: 1px solid #30363d;
            border-left: 4px solid #58a6ff;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
        }
        
        .progress-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #30363d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .step-icon.completed {
            background: #3fb950;
            color: #0d1117;
        }
        
        .step-icon.active {
            background: #58a6ff;
            color: #0d1117;
        }
        
        /* Input Area */
        .input-container {
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #30363d;
            padding: 24px;
        }
        
        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-field {
            flex: 1;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 16px 20px;
            color: #e6edf3;
            font-size: 16px;
            resize: none;
            min-height: 56px;
            max-height: 200px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .send-button {
            background: linear-gradient(135deg, #238636, #2ea043);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .send-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.3);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Right Panel */
        .right-panel {
            width: 320px;
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border-left: 1px solid #30363d;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #30363d;
        }
        
        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .panel-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: rgba(48, 54, 61, 0.3);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #3fb950;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .recent-activity {
            margin-bottom: 24px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .activity-item:hover {
            background: rgba(48, 54, 61, 0.3);
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(56, 139, 253, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #8b949e;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 60px;
        }
        
        .welcome-title {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #58a6ff, #3fb950);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-subtitle {
            font-size: 20px;
            color: #8b949e;
            margin-bottom: 48px;
            max-width: 600px;
            line-height: 1.5;
        }
        
        .example-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }
        
        .example-prompt {
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .example-prompt:hover {
            background: rgba(56, 139, 253, 0.1);
            border-color: #58a6ff;
            transform: translateY(-4px);
        }
        
        .example-icon {
            font-size: 32px;
            margin-bottom: 16px;
        }
        
        .example-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #58a6ff;
        }
        
        .example-description {
            font-size: 14px;
            color: #8b949e;
            line-height: 1.5;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .right-panel {
                width: 280px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar,
            .right-panel {
                display: none;
            }
            
            .main-container {
                flex-direction: column;
            }
        }
        
        /* Loading Animation */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .loading-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #58a6ff;
            animation: loadingDot 1.4s ease-in-out infinite both;
        }
        
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes loadingDot {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ü§ñ</div>
            <span>CAL Platform</span>
        </div>
        
        <div class="header-actions">
            <div class="status-dots">
                <div class="status-dot active" title="AI Services"></div>
                <div class="status-dot active" title="Document Generator"></div>
                <div class="status-dot active" title="Analytics"></div>
                <div class="status-dot active" title="Vault Integration"></div>
            </div>
            
            <div class="user-menu">
                <span>üë§</span>
                <span>Developer</span>
                <span>‚ñº</span>
            </div>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Quick Actions</h3>
                <div class="quick-actions">
                    <div class="quick-action" onclick="sendMessage('Create a new SaaS project')">
                        <span class="action-icon">üöÄ</span>
                        <span>New Project</span>
                    </div>
                    <div class="quick-action" onclick="sendMessage('Show me my domains')">
                        <span class="action-icon">üåê</span>
                        <span>Manage Domains</span>
                    </div>
                    <div class="quick-action" onclick="sendMessage('Generate a pitch deck')">
                        <span class="action-icon">üìä</span>
                        <span>Create Pitch</span>
                    </div>
                    <div class="quick-action" onclick="openTemplateGallery()">
                        <span class="action-icon">üìã</span>
                        <span>Templates</span>
                    </div>
                </div>
            </div>
            
            <nav class="navigation">
                <div class="nav-section">
                    <h4 class="nav-section-title">Chat & AI</h4>
                    <div class="nav-items">
                        <div class="nav-item active" data-view="chat">
                            <span>üí¨</span>
                            <span>AI Assistant</span>
                        </div>
                        <div class="nav-item" data-view="conversations">
                            <span>üìö</span>
                            <span>Conversations</span>
                        </div>
                        <div class="nav-item" data-view="models">
                            <span>üß†</span>
                            <span>AI Models</span>
                        </div>
                    </div>
                </div>
                
                <div class="nav-section">
                    <h4 class="nav-section-title">Development</h4>
                    <div class="nav-items">
                        <div class="nav-item" data-view="projects">
                            <span>üöÄ</span>
                            <span>Projects</span>
                        </div>
                        <div class="nav-item" data-view="domains">
                            <span>üåê</span>
                            <span>Domains</span>
                        </div>
                        <div class="nav-item" data-view="plugins">
                            <span>üîå</span>
                            <span>Plugins</span>
                        </div>
                        <div class="nav-item" data-view="templates">
                            <span>üìã</span>
                            <span>Templates</span>
                        </div>
                    </div>
                </div>
                
                <div class="nav-section">
                    <h4 class="nav-section-title">Platform</h4>
                    <div class="nav-items">
                        <div class="nav-item" data-view="analytics">
                            <span>üìä</span>
                            <span>Analytics</span>
                        </div>
                        <div class="nav-item" data-view="vault">
                            <span>üóÑÔ∏è</span>
                            <span>Secure Vault</span>
                        </div>
                        <div class="nav-item" data-view="settings">
                            <span>‚öôÔ∏è</span>
                            <span>Settings</span>
                        </div>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- Content Area -->
        <main class="content-area">
            <!-- Chat Interface -->
            <div class="chat-interface" id="chatInterface">
                <div class="messages-container" id="messagesContainer">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcomeScreen">
                        <h1 class="welcome-title">Build Anything</h1>
                        <p class="welcome-subtitle">
                            Your AI-powered development companion. From idea to production in minutes.
                            Chat naturally and watch your projects come to life.
                        </p>
                        
                        <div class="example-prompts">
                            <div class="example-prompt" onclick="sendExample('Build me a SaaS platform for team collaboration with real-time chat, file sharing, and project management')">
                                <div class="example-icon">üíº</div>
                                <h3 class="example-title">SaaS Platform</h3>
                                <p class="example-description">Create a complete team collaboration platform with all the bells and whistles</p>
                            </div>
                            
                            <div class="example-prompt" onclick="sendExample('I need a Chrome extension that blocks social media during work hours and tracks productivity')">
                                <div class="example-icon">üåê</div>
                                <h3 class="example-title">Browser Extension</h3>
                                <p class="example-description">Build productivity tools that integrate seamlessly with your browser</p>
                            </div>
                            
                            <div class="example-prompt" onclick="sendExample('Create an e-commerce store with inventory management, payment processing, and customer analytics')">
                                <div class="example-icon">üõçÔ∏è</div>
                                <h3 class="example-title">E-commerce Store</h3>
                                <p class="example-description">Full-featured online marketplace with advanced business features</p>
                            </div>
                            
                            <div class="example-prompt" onclick="sendExample('Help me build a mobile app for tracking fitness goals with social sharing and gamification')">
                                <div class="example-icon">üì±</div>
                                <h3 class="example-title">Mobile App</h3>
                                <p class="example-description">Cross-platform mobile applications with native performance</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Input Container -->
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea
                            id="messageInput"
                            class="input-field"
                            placeholder="Describe your project idea, ask for help, or request modifications..."
                            rows="1"
                        ></textarea>
                        <button id="sendButton" class="send-button">
                            <span>Send</span>
                            <span>‚Üí</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Right Panel -->
        <aside class="right-panel">
            <div class="panel-header">
                <h3 class="panel-title">Platform Overview</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="projectCount">0</div>
                        <div class="stat-label">Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="messageCount">0</div>
                        <div class="stat-label">Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="domainCount">0</div>
                        <div class="stat-label">Domains</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="templateCount">12</div>
                        <div class="stat-label">Templates</div>
                    </div>
                </div>
            </div>
            
            <div class="panel-content">
                <div class="recent-activity">
                    <h4 style="margin-bottom: 16px; color: #8b949e; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Recent Activity</h4>
                    <div id="activityFeed">
                        <div class="activity-item">
                            <div class="activity-icon">ü§ñ</div>
                            <div class="activity-content">
                                <div class="activity-text">CAL Platform initialized</div>
                                <div class="activity-time">Just now</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="capabilities">
                    <h4 style="margin-bottom: 16px; color: #8b949e; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">AI Capabilities</h4>
                    <div class="nav-items">
                        <div class="nav-item">
                            <span>üöÄ</span>
                            <span>Full-stack development</span>
                        </div>
                        <div class="nav-item">
                            <span>üåê</span>
                            <span>Domain & hosting setup</span>
                        </div>
                        <div class="nav-item">
                            <span>üîå</span>
                            <span>Plugin & extension creation</span>
                        </div>
                        <div class="nav-item">
                            <span>üìä</span>
                            <span>Analytics & monitoring</span>
                        </div>
                        <div class="nav-item">
                            <span>üé®</span>
                            <span>UI/UX design</span>
                        </div>
                        <div class="nav-item">
                            <span>üì±</span>
                            <span>Mobile app development</span>
                        </div>
                        <div class="nav-item">
                            <span>üóÑÔ∏è</span>
                            <span>Database design</span>
                        </div>
                        <div class="nav-item">
                            <span>üîê</span>
                            <span>Security & authentication</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
    
    <script>
        // Global state
        let ws = null;
        let conversationId = null;
        let messageCount = 0;
        let projectCount = 0;
        let domainCount = 0;
        let currentView = 'chat';
        
        // DOM elements
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const activityFeed = document.getElementById('activityFeed');
        
        // Initialize platform
        function init() {
            console.log('üöÄ CAL Platform initializing...');
            
            setupEventListeners();
            connectWebSocket();
            loadInitialData();
            setupAutoSave();
            
            console.log('‚úÖ CAL Platform ready!');
            addActivity('Platform initialized and ready', 'üöÄ');
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Send message
            sendButton.addEventListener('click', () => sendMessage(messageInput.value));
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(messageInput.value);
                }
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', autoResize);
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const view = item.dataset.view;
                    if (view && view !== currentView) {
                        switchView(view);
                    }
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case '/':
                            e.preventDefault();
                            messageInput.focus();
                            break;
                        case 'n':
                            e.preventDefault();
                            sendMessage('Create a new project');
                            break;
                    }
                }
            });
        }
        
        // Connect to WebSocket
        function connectWebSocket() {
            // Try multiple ports for different services
            const ports = [9091, 8081, 9090];
            let portIndex = 0;
            
            function tryConnect() {
                if (portIndex >= ports.length) {
                    console.warn('‚ö†Ô∏è Could not connect to any WebSocket service');
                    // Fall back to HTTP polling
                    setupHTTPPolling();
                    return;
                }
                
                const port = ports[portIndex];
                ws = new WebSocket(`ws://localhost:${port}`);
                
                ws.onopen = () => {
                    console.log(`‚úÖ Connected to WebSocket on port ${port}`);
                    
                    if (!conversationId) {
                        conversationId = 'conv-' + Date.now();
                    }
                    
                    // Join conversation
                    ws.send(JSON.stringify({
                        type: 'join-conversation',
                        data: { conversationId, platform: 'cal-saas' }
                    }));
                    
                    addActivity('Connected to AI services', 'ü§ñ');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (error) {
                        console.error('Failed to parse message:', error);
                    }
                };
                
                ws.onclose = () => {
                    console.log('‚ùå WebSocket disconnected');
                    // Try next port or reconnect
                    portIndex++;
                    setTimeout(tryConnect, 2000);
                };
                
                ws.onerror = () => {
                    portIndex++;
                    tryConnect();
                };
            }
            
            tryConnect();
        }
        
        // Setup HTTP polling as fallback
        function setupHTTPPolling() {
            console.log('üì° Setting up HTTP polling...');
            
            setInterval(async () => {
                try {
                    const response = await fetch('http://localhost:3001/api/platform/status');
                    const data = await response.json();
                    
                    // Update stats
                    updateStats(data);
                    
                } catch (error) {
                    // Service not available
                }
            }, 30000);
        }
        
        // Handle incoming messages
        function handleMessage(message) {
            switch (message.type) {
                case 'welcome':
                    console.log('üëã Welcome:', message.data);
                    break;
                    
                case 'new-message':
                    addMessage(message.data);
                    break;
                    
                case 'action-progress':
                    updateActionProgress(message.data);
                    break;
                    
                case 'project-created':
                    handleProjectCreated(message.data);
                    break;
                    
                case 'stats-update':
                    updateStats(message.data);
                    break;
                    
                case 'platform-event':
                    handlePlatformEvent(message.data);
                    break;
                    
                default:
                    console.log('Unknown message type:', message.type);
            }
        }
        
        // Send message
        function sendMessage(text) {
            if (!text.trim()) return;
            
            // Hide welcome screen
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
            
            // Add user message to UI immediately
            addMessage({
                userId: 'user',
                content: text,
                timestamp: Date.now()
            });
            
            // Send via WebSocket or HTTP
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'message',
                    data: {
                        message: text,
                        conversationId,
                        platform: 'cal-saas'
                    }
                }));
            } else {
                // HTTP fallback
                sendMessageHTTP(text);
            }
            
            // Clear input
            messageInput.value = '';
            autoResize();
            
            // Show typing indicator
            showTypingIndicator();
            
            messageCount++;
            updateStats({ messages: messageCount });
            addActivity(`Sent message: "${text.slice(0, 50)}${text.length > 50 ? '...' : ''}"`, 'üí¨');
        }
        
        // HTTP message sending
        async function sendMessageHTTP(text) {
            try {
                const response = await fetch('http://localhost:3001/api/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        conversationId,
                        platform: 'cal-saas'
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Add AI response
                addMessage({
                    userId: 'cal',
                    content: data.response,
                    timestamp: Date.now(),
                    actions: data.actions
                });
                
            } catch (error) {
                removeTypingIndicator();
                addMessage({
                    userId: 'cal',
                    content: 'I\'m having trouble connecting to my services right now. Please try again in a moment.',
                    timestamp: Date.now()
                });
            }
        }
        
        // Add message to chat
        function addMessage(messageData) {
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            
            const isCAL = messageData.userId === 'cal';
            const timestamp = new Date(messageData.timestamp).toLocaleTimeString();
            
            messageEl.innerHTML = `
                <div class="message-avatar ${isCAL ? 'cal-avatar' : 'user-avatar'}">
                    ${isCAL ? 'CAL' : 'YOU'}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${isCAL ? 'ü§ñ CAL Assistant' : 'üë§ You'}</span>
                        <span class="message-time">${timestamp}</span>
                    </div>
                    <div class="message-text">${escapeHtml(messageData.content)}</div>
                    ${messageData.actions ? renderActions(messageData.actions) : ''}
                </div>
            `;
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Render action cards
        function renderActions(actions) {
            if (!actions || actions.length === 0) return '';
            
            return `
                <div class="message-actions">
                    ${actions.map(action => `
                        <div class="action-card" onclick="handleAction('${action.type}', '${action.id || ''}')">
                            <div class="action-title">
                                ${getActionIcon(action.type)} ${getActionTitle(action.type)}
                            </div>
                            <div class="action-description">${getActionDescription(action)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Action helpers
        function getActionIcon(type) {
            const icons = {
                'create-project': 'üöÄ',
                'configure-domain': 'üåê',
                'scaffold-plugin': 'üîå',
                'generate-pitch': 'üìä',
                'deploy-app': 'üö¢',
                'setup-analytics': 'üìà',
                'create-database': 'üóÑÔ∏è',
                'configure-auth': 'üîê'
            };
            return icons[type] || '‚ö°';
        }
        
        function getActionTitle(type) {
            return type.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        function getActionDescription(action) {
            switch (action.type) {
                case 'create-project':
                    return `Create ${action.projectType || 'new'} project`;
                case 'configure-domain':
                    return `Setup domain: ${action.domain}`;
                case 'scaffold-plugin':
                    return `Build ${action.platform} plugin`;
                case 'generate-pitch':
                    return 'Create investor pitch deck';
                default:
                    return action.description || 'Perform action';
            }
        }
        
        // Handle action clicks
        function handleAction(type, id) {
            console.log('Action clicked:', type, id);
            sendMessage(`Execute action: ${type} ${id ? `for ${id}` : ''}`);
            addActivity(`Executed action: ${getActionTitle(type)}`, getActionIcon(type));
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const typingEl = document.createElement('div');
            typingEl.className = 'message typing-indicator';
            typingEl.id = 'typingIndicator';
            
            typingEl.innerHTML = `
                <div class="message-avatar cal-avatar">CAL</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">ü§ñ CAL Assistant</span>
                    </div>
                    <div class="message-text">
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Remove typing indicator
        function removeTypingIndicator() {
            const typingEl = document.getElementById('typingIndicator');
            if (typingEl) {
                typingEl.remove();
            }
        }
        
        // Update action progress
        function updateActionProgress(progress) {
            // Find or create progress element
            let progressEl = document.getElementById(`progress-${progress.action}`);
            
            if (!progressEl && progress.status === 'started') {
                progressEl = document.createElement('div');
                progressEl.id = `progress-${progress.action}`;
                progressEl.className = 'progress-message';
                progressEl.innerHTML = `
                    <div class="progress-header">
                        <div class="spinner"></div>
                        <span>${progress.message}</span>
                    </div>
                    <div class="progress-steps" id="steps-${progress.action}"></div>
                `;
                messagesContainer.appendChild(progressEl);
            }
            
            if (progress.status === 'progress' && progressEl) {
                const stepsEl = document.getElementById(`steps-${progress.action}`);
                if (stepsEl) {
                    const stepEl = document.createElement('div');
                    stepEl.className = 'progress-step';
                    stepEl.innerHTML = `
                        <span class="step-icon active">‚ö°</span>
                        <span>${progress.message}</span>
                    `;
                    stepsEl.appendChild(stepEl);
                    
                    // Mark previous steps as completed
                    const steps = stepsEl.querySelectorAll('.step-icon');
                    steps.forEach((step, i) => {
                        if (i < steps.length - 1) {
                            step.classList.remove('active');
                            step.classList.add('completed');
                            step.textContent = '‚úì';
                        }
                    });
                }
            }
            
            if ((progress.status === 'completed' || progress.status === 'failed') && progressEl) {
                const spinner = progressEl.querySelector('.spinner');
                const message = progressEl.querySelector('.progress-header span');
                
                if (spinner) spinner.style.display = 'none';
                if (message) message.textContent = progress.message;
                
                // Mark all steps as completed
                progressEl.querySelectorAll('.step-icon').forEach(step => {
                    step.classList.remove('active');
                    step.classList.add('completed');
                    step.textContent = '‚úì';
                });
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Handle project created
        function handleProjectCreated(project) {
            projectCount++;
            updateStats({ projects: projectCount });
            addActivity(`Created project: ${project.name}`, 'üöÄ');
        }
        
        // Handle platform events
        function handlePlatformEvent(event) {
            addActivity(event.message, event.icon || 'üì°');
            
            if (event.type === 'domain-configured') {
                domainCount++;
                updateStats({ domains: domainCount });
            }
        }
        
        // Update statistics
        function updateStats(stats) {
            if (stats.projects !== undefined) {
                document.getElementById('projectCount').textContent = stats.projects;
            }
            if (stats.messages !== undefined) {
                document.getElementById('messageCount').textContent = stats.messages;
            }
            if (stats.domains !== undefined) {
                document.getElementById('domainCount').textContent = stats.domains;
            }
        }
        
        // Add activity to feed
        function addActivity(text, icon = 'üì°') {
            const activityEl = document.createElement('div');
            activityEl.className = 'activity-item';
            
            const now = new Date().toLocaleTimeString();
            
            activityEl.innerHTML = `
                <div class="activity-icon">${icon}</div>
                <div class="activity-content">
                    <div class="activity-text">${text}</div>
                    <div class="activity-time">${now}</div>
                </div>
            `;
            
            activityFeed.insertBefore(activityEl, activityFeed.firstChild);
            
            // Keep only last 10 activities
            while (activityFeed.children.length > 10) {
                activityFeed.removeChild(activityFeed.lastChild);
            }
        }
        
        // Switch views
        function switchView(view) {
            currentView = view;
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === view) {
                    item.classList.add('active');
                }
            });
            
            // Handle view-specific logic
            switch (view) {
                case 'chat':
                    // Already showing chat interface
                    break;
                case 'analytics':
                    sendMessage('Show me the platform analytics dashboard');
                    break;
                case 'projects':
                    sendMessage('List all my projects');
                    break;
                case 'domains':
                    sendMessage('Show me my domain management interface');
                    break;
                case 'vault':
                    sendMessage('Open the secure vault interface');
                    break;
                default:
                    sendMessage(`Switch to ${view} view`);
            }
            
            addActivity(`Switched to ${view} view`, 'üëÅÔ∏è');
        }
        
        // Send example prompt
        function sendExample(text) {
            messageInput.value = text;
            sendMessage(text);
        }
        
        // Open template gallery
        function openTemplateGallery() {
            sendMessage('Show me the template gallery with available project templates');
        }
        
        // Auto-resize textarea
        function autoResize() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
        }
        
        // Setup auto-save
        function setupAutoSave() {
            setInterval(() => {
                const draft = messageInput.value.trim();
                if (draft) {
                    localStorage.setItem('cal-draft-message', draft);
                }
            }, 5000);
            
            // Restore draft on load
            const draft = localStorage.getItem('cal-draft-message');
            if (draft) {
                messageInput.value = draft;
                autoResize();
            }
        }
        
        // Load initial data
        async function loadInitialData() {
            try {
                // Try to load from various services
                const endpoints = [
                    'http://localhost:3001/api/platform/stats',
                    'http://localhost:8080/api/dashboard/stats',
                    'http://localhost:3000/api/stats'
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint);
                        const data = await response.json();
                        
                        updateStats(data);
                        addActivity('Loaded platform statistics', 'üìä');
                        break;
                    } catch (error) {
                        // Try next endpoint
                        continue;
                    }
                }
            } catch (error) {
                console.log('Could not load initial data, using defaults');
            }
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
        
        // Global functions for onclick handlers
        window.sendMessage = sendMessage;
        window.sendExample = sendExample;
        window.openTemplateGallery = openTemplateGallery;
        window.handleAction = handleAction;
    </script>
</body>
</html>