<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pirate Islands Clash - Mobile Idle Tycoon</title>
    
    <!-- PWA manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/pirate-icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(to bottom, #87CEEB 0%, #1E90FF 100%);
            color: #333;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* Main game container */
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        /* Top HUD */
        #top-hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
            color: white;
            padding: 10px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .resource-display {
            display: flex;
            gap: 15px;
            font-size: 14px;
            flex-wrap: wrap;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .resource-icon {
            font-size: 18px;
        }
        
        /* Island viewport */
        #island-viewport {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        #island-canvas {
            position: absolute;
            transform-origin: center center;
            transition: transform 0.3s ease;
        }
        
        /* Island grid */
        .island-grid {
            display: grid;
            grid-template-columns: repeat(40, 32px);
            grid-template-rows: repeat(40, 32px);
            gap: 0;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .grid-cell {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            transition: all 0.2s ease;
        }
        
        .grid-cell.water {
            background: rgba(30, 144, 255, 0.6);
            border-color: rgba(30, 144, 255, 0.8);
        }
        
        .grid-cell.land {
            background: rgba(34, 139, 34, 0.8);
            border-color: rgba(34, 139, 34, 0.9);
        }
        
        .grid-cell.land:hover {
            background: rgba(50, 205, 50, 0.9);
            transform: scale(1.1);
            z-index: 10;
        }
        
        .grid-cell.occupied {
            cursor: not-allowed;
        }
        
        /* Buildings */
        .building {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .building.has-resources {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .building-level {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #FFD700;
            color: #333;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Bottom navigation */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.7));
            padding: 10px;
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }
        
        .nav-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .nav-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .nav-button .icon {
            font-size: 20px;
            display: block;
            margin-bottom: 5px;
        }
        
        /* Building menu */
        #building-menu {
            position: fixed;
            bottom: 80px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            border-radius: 20px;
            padding: 20px;
            display: none;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 200;
        }
        
        .building-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        
        .building-option {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .building-option:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        
        .building-option.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .building-option .icon {
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .building-option .name {
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .building-option .cost {
            font-size: 10px;
            color: #FFD700;
        }
        
        /* Floating numbers */
        .floating-number {
            position: absolute;
            font-weight: bold;
            font-size: 20px;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
            z-index: 1000;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }
        
        .floating-number.gold { color: #FFD700; }
        .floating-number.wood { color: #8B4513; }
        .floating-number.rum { color: #FFA500; }
        .floating-number.cannons { color: #696969; }
        
        /* Ship dock */
        #ship-dock {
            position: fixed;
            right: 10px;
            top: 80px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 90;
        }
        
        .ship-slot {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* Battle screen */
        #battle-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            z-index: 300;
            padding: 20px;
        }
        
        .battle-animation {
            text-align: center;
            color: white;
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* Offline progress modal */
        #offline-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid #FFD700;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            display: none;
            z-index: 400;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        #offline-modal h2 {
            color: #FFD700;
            margin-bottom: 20px;
        }
        
        .offline-rewards {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        /* Touch controls */
        .pinch-zoom-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        /* Loading screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-ship {
            font-size: 64px;
            animation: sail 3s ease-in-out infinite;
        }
        
        @keyframes sail {
            0%, 100% { transform: translateX(-20px) rotate(-5deg); }
            50% { transform: translateX(20px) rotate(5deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .resource-display {
                font-size: 12px;
            }
            
            .resource-item {
                padding: 3px 8px;
            }
            
            .building-option {
                padding: 10px;
            }
            
            .nav-button {
                padding: 8px 15px;
                font-size: 12px;
            }
        }
        
        /* Landscape mode */
        @media (orientation: landscape) and (max-height: 500px) {
            #top-hud {
                padding: 5px;
            }
            
            #bottom-nav {
                padding: 5px;
            }
            
            .nav-button {
                padding: 5px 15px;
            }
            
            .nav-button .icon {
                display: inline;
                margin: 0 5px 0 0;
            }
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div id="loading-screen">
        <div class="loading-ship">🚢</div>
        <h1 style="color: #FFD700; margin-top: 20px;">Pirate Islands Clash</h1>
        <p style="color: #FFF; margin-top: 10px;">Loading your pirate empire...</p>
    </div>
    
    <!-- Main game container -->
    <div id="game-container" style="display: none;">
        <!-- Top HUD -->
        <div id="top-hud">
            <div class="player-info">
                <span id="player-name">Pirate</span>
                <span id="player-level">Lv.1</span>
            </div>
            <div class="resource-display">
                <div class="resource-item">
                    <span class="resource-icon">💰</span>
                    <span id="gold-amount">0</span>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">🪵</span>
                    <span id="wood-amount">0</span>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">💣</span>
                    <span id="cannons-amount">0</span>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">🍺</span>
                    <span id="rum-amount">0</span>
                </div>
            </div>
        </div>
        
        <!-- Island viewport -->
        <div id="island-viewport">
            <div id="island-canvas">
                <div class="island-grid" id="island-grid">
                    <!-- Grid cells will be generated here -->
                </div>
            </div>
        </div>
        
        <!-- Ship dock -->
        <div id="ship-dock">
            <div class="ship-slot" data-slot="1">⛵</div>
            <div class="ship-slot" data-slot="2">➕</div>
            <div class="ship-slot" data-slot="3">➕</div>
        </div>
        
        <!-- Bottom navigation -->
        <div id="bottom-nav">
            <button class="nav-button" onclick="toggleBuildMenu()">
                <span class="icon">🏗️</span>
                Build
            </button>
            <button class="nav-button" onclick="openShipyard()">
                <span class="icon">⚓</span>
                Ships
            </button>
            <button class="nav-button" onclick="startBattle()">
                <span class="icon">⚔️</span>
                Battle
            </button>
            <button class="nav-button" onclick="openStore()">
                <span class="icon">💎</span>
                Store
            </button>
            <button class="nav-button" onclick="showSettings()">
                <span class="icon">⚙️</span>
                Settings
            </button>
        </div>
        
        <!-- Building menu -->
        <div id="building-menu">
            <h3 style="color: #FFD700; margin-bottom: 15px;">Build</h3>
            <div class="building-grid" id="building-grid">
                <!-- Building options will be generated here -->
            </div>
        </div>
        
        <!-- Battle screen -->
        <div id="battle-screen">
            <div class="battle-animation">
                <h2>BATTLE IN PROGRESS!</h2>
                <div style="font-size: 100px; margin: 20px;">⚔️</div>
                <p>Your ships are attacking...</p>
            </div>
        </div>
        
        <!-- Offline progress modal -->
        <div id="offline-modal">
            <h2>Welcome Back, Captain!</h2>
            <p>While you were away for <span id="offline-time">0</span> hours...</p>
            <div class="offline-rewards" id="offline-rewards">
                <!-- Rewards will be shown here -->
            </div>
            <button class="nav-button" onclick="closeOfflineModal()">Collect!</button>
        </div>
        
        <!-- Pinch zoom indicator -->
        <div class="pinch-zoom-indicator">🔍</div>
    </div>
    
    <script>
        // Game state
        let gameState = null;
        let socket = null;
        let selectedBuilding = null;
        let currentIsland = null;
        let zoom = 1;
        let panX = 0;
        let panY = 0;
        
        // Building types from server
        const buildingTypes = {
            goldMine: { name: 'Gold Mine', icon: '⛏️', cost: { wood: 100 } },
            lumberMill: { name: 'Lumber Mill', icon: '🪵', cost: { gold: 150 } },
            cannonFactory: { name: 'Cannon Factory', icon: '💣', cost: { gold: 500, wood: 300 } },
            rumDistillery: { name: 'Rum Distillery', icon: '🍺', cost: { gold: 200, wood: 100 } },
            cannonTower: { name: 'Cannon Tower', icon: '🗼', cost: { gold: 1000, wood: 500, cannons: 10 } },
            wall: { name: 'Wall', icon: '🚧', cost: { wood: 50 } },
            shipyard: { name: 'Shipyard', icon: '⚓', cost: { gold: 2000, wood: 1500 } },
            tavern: { name: 'Tavern', icon: '🏚️', cost: { gold: 500, rum: 100 } }
        };
        
        // Initialize game
        async function initGame() {
            // Connect to WebSocket
            connectWebSocket();
            
            // Load game state
            await loadGameState();
            
            // Setup touch controls
            setupTouchControls();
            
            // Setup service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js');
            }
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('game-container').style.display = 'block';
                
                // Check for offline progress
                if (gameState.offlineTime > 0) {
                    showOfflineProgress();
                }
            }, 2000);
        }
        
        // Connect to WebSocket for real-time updates
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.hostname}:${window.location.port || 7778}`;
            socket = new WebSocket(wsUrl);
            
            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleServerMessage(message);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            socket.onclose = () => {
                console.log('WebSocket disconnected, attempting reconnect...');
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // Handle server messages
        function handleServerMessage(message) {
            switch (message.type) {
                case 'game_state':
                    gameState = message.data;
                    updateUI();
                    renderIsland();
                    break;
                case 'resources_updated':
                    gameState.resources = message.data;
                    updateResourceDisplay();
                    break;
                case 'building_created':
                    handleBuildingCreated(message.data);
                    break;
                case 'resources_collected':
                    handleResourcesCollected(message.data);
                    break;
                case 'battle_ended':
                    handleBattleEnded(message.data);
                    break;
            }
        }
        
        // Load game state from server
        async function loadGameState() {
            try {
                const response = await fetch('/api/game/state');
                gameState = await response.json();
                updateUI();
                renderIsland();
            } catch (error) {
                console.error('Failed to load game state:', error);
            }
        }
        
        // Update UI elements
        function updateUI() {
            if (!gameState) return;
            
            // Update player info
            document.getElementById('player-name').textContent = gameState.player.name;
            document.getElementById('player-level').textContent = `Lv.${gameState.player.level}`;
            
            // Update resources
            updateResourceDisplay();
            
            // Update building menu
            updateBuildingMenu();
        }
        
        // Update resource display
        function updateResourceDisplay() {
            document.getElementById('gold-amount').textContent = Math.floor(gameState.resources.gold);
            document.getElementById('wood-amount').textContent = Math.floor(gameState.resources.wood);
            document.getElementById('cannons-amount').textContent = Math.floor(gameState.resources.cannons);
            document.getElementById('rum-amount').textContent = Math.floor(gameState.resources.rum);
        }
        
        // Render island grid
        function renderIsland() {
            if (!gameState || !gameState.islands.length) return;
            
            currentIsland = gameState.islands[0];
            const gridElement = document.getElementById('island-grid');
            gridElement.innerHTML = '';
            
            // Create grid cells
            for (let y = 0; y < 40; y++) {
                for (let x = 0; x < 40; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    const terrain = currentIsland.grid[y][x];
                    cell.classList.add(terrain.terrain);
                    
                    if (terrain.occupied) {
                        cell.classList.add('occupied');
                    }
                    
                    if (terrain.terrain === 'land' && !terrain.occupied) {
                        cell.onclick = () => selectCell(x, y);
                    }
                    
                    gridElement.appendChild(cell);
                }
            }
            
            // Render buildings
            gameState.buildings.forEach(building => {
                if (building.islandId === currentIsland.id) {
                    renderBuilding(building);
                }
            });
        }
        
        // Render a building on the grid
        function renderBuilding(building) {
            const cell = document.querySelector(`[data-x="${building.position.x}"][data-y="${building.position.y}"]`);
            if (!cell) return;
            
            const buildingEl = document.createElement('div');
            buildingEl.className = 'building';
            buildingEl.dataset.buildingId = building.id;
            buildingEl.innerHTML = `
                ${building.sprite}
                <span class="building-level">${building.level}</span>
            `;
            
            buildingEl.onclick = (e) => {
                e.stopPropagation();
                collectFromBuilding(building.id);
            };
            
            cell.appendChild(buildingEl);
        }
        
        // Select a cell for building
        function selectCell(x, y) {
            if (selectedBuilding) {
                buildAt(x, y);
            }
        }
        
        // Toggle build menu
        function toggleBuildMenu() {
            const menu = document.getElementById('building-menu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        // Update building menu
        function updateBuildingMenu() {
            const grid = document.getElementById('building-grid');
            grid.innerHTML = '';
            
            Object.entries(buildingTypes).forEach(([type, building]) => {
                const option = document.createElement('div');
                option.className = 'building-option';
                
                // Check if player can afford
                const canAfford = Object.entries(building.cost).every(([resource, amount]) => 
                    gameState.resources[resource] >= amount
                );
                
                if (!canAfford) {
                    option.classList.add('locked');
                }
                
                option.innerHTML = `
                    <div class="icon">${building.icon}</div>
                    <div class="name">${building.name}</div>
                    <div class="cost">${formatCost(building.cost)}</div>
                `;
                
                option.onclick = () => {
                    if (canAfford) {
                        selectedBuilding = type;
                        toggleBuildMenu();
                    }
                };
                
                grid.appendChild(option);
            });
        }
        
        // Format cost display
        function formatCost(cost) {
            return Object.entries(cost)
                .map(([resource, amount]) => `${amount} ${resource}`)
                .join(', ');
        }
        
        // Build at location
        async function buildAt(x, y) {
            if (!selectedBuilding) return;
            
            try {
                const response = await fetch('/api/building/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: selectedBuilding,
                        x: x,
                        y: y,
                        islandId: currentIsland.id
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(error.error);
                }
                
                selectedBuilding = null;
            } catch (error) {
                console.error('Build error:', error);
            }
        }
        
        // Collect resources from building
        async function collectFromBuilding(buildingId) {
            try {
                const response = await fetch(`/api/building/${buildingId}/collect`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.collected) {
                    // Show floating numbers
                    Object.entries(data.collected).forEach(([resource, amount]) => {
                        if (amount > 0) {
                            showFloatingNumber(resource, amount);
                        }
                    });
                }
            } catch (error) {
                console.error('Collection error:', error);
            }
        }
        
        // Show floating number animation
        function showFloatingNumber(resource, amount) {
            const building = event.target.closest('.building');
            const rect = building.getBoundingClientRect();
            
            const floater = document.createElement('div');
            floater.className = `floating-number ${resource}`;
            floater.textContent = `+${amount}`;
            floater.style.left = `${rect.left + rect.width / 2}px`;
            floater.style.top = `${rect.top}px`;
            
            document.body.appendChild(floater);
            
            setTimeout(() => {
                floater.remove();
            }, 2000);
        }
        
        // Handle building created
        function handleBuildingCreated(data) {
            renderBuilding(data.building);
            updateResourceDisplay();
        }
        
        // Handle resources collected
        function handleResourcesCollected(data) {
            updateResourceDisplay();
        }
        
        // Setup touch controls
        function setupTouchControls() {
            const viewport = document.getElementById('island-viewport');
            const canvas = document.getElementById('island-canvas');
            
            let touching = false;
            let lastTouchDistance = 0;
            let touchStartX = 0;
            let touchStartY = 0;
            
            // Touch start
            viewport.addEventListener('touchstart', (e) => {
                touching = true;
                
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    // Pinch zoom start
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
                }
            });
            
            // Touch move
            viewport.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                if (e.touches.length === 1 && touching) {
                    // Pan
                    const dx = e.touches[0].clientX - touchStartX;
                    const dy = e.touches[0].clientY - touchStartY;
                    
                    panX += dx;
                    panY += dy;
                    
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    
                    updateCanvasTransform();
                } else if (e.touches.length === 2) {
                    // Pinch zoom
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (lastTouchDistance > 0) {
                        const scale = distance / lastTouchDistance;
                        zoom = Math.max(0.5, Math.min(2, zoom * scale));
                        updateCanvasTransform();
                        
                        // Show zoom indicator
                        const indicator = document.querySelector('.pinch-zoom-indicator');
                        indicator.style.opacity = '1';
                        indicator.textContent = zoom > 1 ? '🔍+' : '🔍-';
                        
                        clearTimeout(indicator.hideTimeout);
                        indicator.hideTimeout = setTimeout(() => {
                            indicator.style.opacity = '0';
                        }, 1000);
                    }
                    
                    lastTouchDistance = distance;
                }
            });
            
            // Touch end
            viewport.addEventListener('touchend', () => {
                touching = false;
                lastTouchDistance = 0;
            });
            
            // Mouse wheel zoom
            viewport.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                zoom = Math.max(0.5, Math.min(2, zoom * delta));
                updateCanvasTransform();
            });
        }
        
        // Update canvas transform
        function updateCanvasTransform() {
            const canvas = document.getElementById('island-canvas');
            canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
        }
        
        // Show offline progress
        function showOfflineProgress() {
            const modal = document.getElementById('offline-modal');
            const hours = (gameState.offlineTime / (1000 * 60 * 60)).toFixed(1);
            
            document.getElementById('offline-time').textContent = hours;
            
            const rewardsDiv = document.getElementById('offline-rewards');
            rewardsDiv.innerHTML = '';
            
            // Show resource gains
            ['gold', 'wood', 'rum', 'cannons'].forEach(resource => {
                const amount = Math.floor(gameState.resources[resource] * 0.1); // Show 10% as "earned"
                if (amount > 0) {
                    const reward = document.createElement('div');
                    reward.className = 'resource-item';
                    reward.innerHTML = `
                        <span class="resource-icon">${getResourceIcon(resource)}</span>
                        <span>+${amount}</span>
                    `;
                    rewardsDiv.appendChild(reward);
                }
            });
            
            modal.style.display = 'block';
        }
        
        // Close offline modal
        function closeOfflineModal() {
            document.getElementById('offline-modal').style.display = 'none';
        }
        
        // Get resource icon
        function getResourceIcon(resource) {
            const icons = {
                gold: '💰',
                wood: '🪵',
                rum: '🍺',
                cannons: '💣',
                berries: '🫐'
            };
            return icons[resource] || '❓';
        }
        
        // Start battle
        async function startBattle() {
            // For now, just show battle animation
            document.getElementById('battle-screen').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('battle-screen').style.display = 'none';
                alert('Victory! You earned 500 gold!');
                gameState.resources.gold += 500;
                updateResourceDisplay();
            }, 3000);
        }
        
        // Placeholder functions
        function openShipyard() {
            alert('Shipyard coming soon! Build mighty ships to rule the seas!');
        }
        
        function openStore() {
            alert('Store coming soon! Get Devil Fruits and special items!');
        }
        
        function showSettings() {
            alert('Settings: Sound ON, Graphics HIGH, Auto-save ON');
        }
        
        // Handle battle ended
        function handleBattleEnded(data) {
            document.getElementById('battle-screen').style.display = 'none';
            
            if (data.status === 'victory') {
                alert(`Victory! Loot: ${data.loot.gold} gold, ${data.loot.wood} wood, ${data.loot.rum} rum`);
            } else {
                alert('Defeat! Your ships were destroyed!');
            }
            
            updateResourceDisplay();
        }
        
        // Initialize when page loads
        window.addEventListener('load', initGame);
        
        // Prevent pull-to-refresh on mobile
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>